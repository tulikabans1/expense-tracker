<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#2563eb">
  <title>Expense Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(120deg, #e0e7ef 0%, #f8fafc 100%) fixed;
      position: relative;
    }
    .hero-bg {
      position: absolute;
      top: 0; left: 0; right: 0; height: 340px;
      background: linear-gradient(120deg, #4f8cff 0%, #38b6ff 100%);
      z-index: 0;
      border-bottom-left-radius: 60px 30px;
      border-bottom-right-radius: 60px 30px;
      box-shadow: 0 8px 32px #4f8cff33;
    }
    #main-container {
      max-width: 850px;
      margin: 3.5em auto 2.5em auto;
      background: #fff;
      padding: 2.8em 2.2em 2.2em 2.2em;
      border-radius: 22px;
      box-shadow: 0 8px 40px #4f8cff22, 0 2px 8px #0001;
      position: relative;
      z-index: 1;
    }
    .header {
      text-align: center;
      margin-bottom: 1.5em;
    }
    .header h1 {
      font-size: 2.8em;
      font-weight: 800;
      color: #2563eb;
      margin-bottom: 0.2em;
      letter-spacing: 1.5px;
      text-shadow: 0 2px 8px #4f8cff22;
    }
    .header p {
      font-size: 1.25em;
      color: #4f8cff;
      margin: 0 0 0.5em 0;
      font-weight: 500;
      letter-spacing: 0.2px;
    }
    .header-actions { display:flex; justify-content:center; gap:0.6em; align-items:center; margin-top:0.4em; }
    .badge { background:#eef2ff; color:#1d4ed8; border:1px solid #c7d2fe; padding:0.35em 0.7em; border-radius:999px; box-shadow:0 1px 4px #93c5fd55; display:flex; align-items:center; gap:0.5em; }
    .avatar { width:22px; height:22px; border-radius:999px; background:#3b82f6; color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:12px; box-shadow:0 1px 3px #0002; }

    .btn { border: none; border-radius: 7px; padding: 0.6em 1.5em; font-size: 1.05em; font-weight: 700; cursor: pointer; box-shadow: 0 2px 12px #4f8cff22; transition: background 0.2s, box-shadow 0.2s, transform 0.1s; letter-spacing: 0.3px; display:inline-flex; align-items:center; justify-content:center; line-height:1.2; min-height:42px; }
    .btn:hover { box-shadow: 0 6px 24px #4f8cff33; transform: translateY(-2px) scale(1.02); }
    .btn-primary { background: linear-gradient(90deg, #4f8cff 0%, #38b6ff 100%); color:#fff; }
    .btn-accent { background: linear-gradient(90deg,#10b981 0%,#34d399 100%); color:#fff; }
    .btn-neutral { background:#e5e7eb; color:#111; }
    .btn-outline { background:linear-gradient(90deg,#9333ea 0%,#3b82f6 100%); color:#fff; }
    .btn-sm { padding: 0.45em 1em; font-size: 0.95em; box-shadow: 0 1px 6px #4f8cff22; }
    .btn-warn { background: linear-gradient(90deg,#f59e0b 0%,#fbbf24 100%); color:#fff; }
    .btn-danger { background: linear-gradient(90deg,#ef4444 0%,#f97316 100%); color:#fff; }

    /* Top navigation bar */
    .topbar { position: sticky; top: 0; background: #ffffff; border-bottom: 1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center; padding: 0.6em 1em; box-shadow: 0 2px 8px rgba(0,0,0,0.04); z-index: 3; }
    .brand { font-weight: 800; color:#2563eb; letter-spacing:0.5px; }
    .topbar-actions { display:flex; gap:0.6em; align-items:center; }
    #menuToggleBtn { display:none; }

    /* Upload toolbar layout */
    form#uploadForm {
      display: grid;
      grid-template-columns: minmax(260px, 1.2fr) repeat(5, minmax(0, auto));
      column-gap: 1.6em;
      row-gap: 0.9em;
      align-items: center;
      justify-content: start;
      justify-items: start;
      margin-bottom: 1.6em;
    }
    /* Grouped file selector card */
    .file-group {
      display: flex;
      align-items: center;
      gap: 0.8em;
      padding: 0.7em 0.9em;
      background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      box-shadow: 0 4px 14px rgba(79, 140, 255, 0.12);
      min-height: 46px;
      justify-self: stretch;
    }
    .file-status {
      color: #6b7280; /* slate-500 */
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    /* compact buttons inside toolbar */
    form#uploadForm .btn {
      padding: 0.4em 1em;
      font-size: 0.92em;
      box-shadow: 0 2px 8px rgba(79, 140, 255, 0.18);
      border-radius: 999px;
      min-width: 6.2em;
      margin-inline: 0.35em;
    }
    /* responsive: reduce columns on small screens */
    @media (max-width: 720px) {
      form#uploadForm { grid-template-columns: 1fr auto auto; }
    }
    @media (max-width: 480px) {
      form#uploadForm { grid-template-columns: 1fr; }
      form#uploadForm .btn { width: 100%; justify-self: stretch; }
    }
    input[type="file"] {
      border: 1.5px solid #b6c6e6;
      border-radius: 7px;
      padding: 0.5em 0.9em;
      background: #f3f6fa;
      font-size: 1.08em;
      color: #2563eb;
      font-weight: 500;
      transition: border 0.2s;
    }
    input[type="file"]:focus {
      border: 1.5px solid #4f8cff;
      outline: none;
    }
    button, #drillback { font-family: inherit; }
    #drillback { display:none; margin-bottom:1em; margin-left:1em; }
    #chart-container {
      width: 100%;
      max-width: 700px;
      margin: 1.4em auto 1.7em auto;
      background: #f7faff;
      border-radius: 14px;
      box-shadow: 0 2px 12px #4f8cff11;
      padding: 2.1em 2.3em 2.4em 2.3em;
    }
    /* Pointer cursor on interactive pies */
    #pieChart:hover, #subPieChart:hover, #transfersPieChart:hover, #investmentsPieChart:hover { cursor: pointer; }
    #subchart-section {
      background: #f7faff;
      border-radius: 14px;
      box-shadow: 0 2px 12px #4f8cff11;
      padding: 1.7em 1.2em 1.2em 1.2em;
      margin-top: 2.2em;
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
    }
    /* Time analysis card */
    #time-section {
      display:none;
      margin-top: 2.2em;
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 2px 12px #4f8cff11;
      padding: 1.2em 1.2em 1.6em 1.2em;
      max-width: 820px;
      margin-left: auto;
      margin-right: auto;
      border: 1px solid #e5e7eb;
    }
    #time-controls { display:flex; gap:0.6em; align-items:center; justify-content:flex-end; flex-wrap:wrap; }
    #time-controls select { padding:0.45em 0.6em; border:1px solid #cbd5e1; border-radius:8px; }
    #subchart-title {
      text-align: center;
      color: #2563eb;
      font-size: 1.35em;
      margin-bottom: 2.5em;
      font-weight: 700;
    }
    .summary {
      text-align: center;
      margin-top: 1.2em;
      font-size: 1.35em;
      font-weight: 700;
      color: #2563eb;
      letter-spacing: 0.7px;
      text-shadow: 0 1px 4px #4f8cff11;
    }
    .category-list {
      margin: 1.3em auto 0.7em auto;
      max-width: 440px;
    }
    .category-list ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-wrap: wrap;
      gap: 0.6em 1.3em;
      justify-content: center;
    }
    .category-list li {
      margin: 0.3em 0;
      font-size: 1.12em;
      background: #eaf1fb;
      border-radius: 6px;
      padding: 0.35em 0.9em 0.35em 0.5em;
      display: flex;
      align-items: center;
      box-shadow: 0 1.5px 6px #4f8cff11;
      font-weight: 500;
      color: #2563eb;
    }
    .category-color {
      display: inline-block;
      width: 18px;
      height: 18px;
      border-radius: 4px;
      margin-right: 10px;
      vertical-align: middle;
      border: 2px solid #fff;
      box-shadow: 0 1px 2px #0001;
    }
    /* Year filter toggle chips above main donut */
    #yearFilterBar {
      display: none;
      align-items: center;
      justify-content: flex-start;
      gap: 0.5em;
      margin-bottom: 1.1em;
      flex-wrap: nowrap;
      font-size: 0.9em;
      color: #374151;
      padding: 0.35em 0.7em;
      background: #eef2ff;
      border-radius: 999px;
      box-shadow: 0 1px 6px rgba(59, 130, 246, 0.18);
    }
    #yearFilterOptions {
      display: flex;
      flex-wrap: nowrap; /* keep years in a single horizontal row */
      gap: 0.35em;
      overflow-x: auto;
      max-width: 100%;
      padding-bottom: 0.1em; /* give a little room for shadows */
      scrollbar-width: thin;
    }
    .year-toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.25em;
      padding: 0.2em 0.9em;
      border-radius: 999px;
      border: 1px solid #bfdbfe;
      background: #eff6ff;
      color: #1d4ed8;
      font-weight: 600;
      font-size: 0.85em;
      box-shadow: 0 1px 4px rgba(59, 130, 246, 0.25);
      cursor: pointer;
      transition: background 0.18s ease, color 0.18s ease, box-shadow 0.18s ease, transform 0.08s ease;
    }
    .year-toggle:hover {
      box-shadow: 0 3px 10px rgba(59, 130, 246, 0.35);
      transform: translateY(-1px);
    }
    .year-toggle input {
      display: none;
    }
    .year-toggle-active {
      background: linear-gradient(90deg, #2563eb 0%, #38bdf8 100%);
      color: #ffffff;
      border-color: #1d4ed8;
      box-shadow: 0 4px 14px rgba(37, 99, 235, 0.45);
    }
    #yearFilterClear {
      padding: 0.25em 0.8em;
      font-size: 0.8em;
    }
    @media (max-width: 600px) {
      #main-container {
        padding: 1em 0.2em;
      }
      #chart-container, #subchart-section {
        padding: 0.7em 0.2em 0.2em 0.2em;
      }
      .summary {
        font-size: 1.1em;
      }
      .header h1 {
        font-size: 2em;
      }
    }
    /* Mobile-friendly topbar and safe-area support */
    @media (max-width: 640px) {
      .topbar { padding-top: env(safe-area-inset-top); padding-left: calc(0.8em + env(safe-area-inset-left)); padding-right: calc(0.8em + env(safe-area-inset-right)); }
      #menuToggleBtn { display:inline-flex; }
      .topbar-actions { display:none; position:absolute; top:100%; left:0; right:0; background:#fff; border-bottom:1px solid #e5e7eb; box-shadow:0 8px 20px rgba(0,0,0,0.06); padding:0.6em; flex-direction:column; gap:0.6em; align-items:stretch; z-index:4; }
      .topbar.open .topbar-actions { display:flex; }
      .topbar-actions .btn, .topbar-actions .badge { width:100%; justify-content:center; }
      .hero-bg { height: 220px; }
      #main-container { margin: 1em auto; padding: 1.2em; }
      .btn { min-height: 44px; }
      /* Mapping modal responsive tweaks */
      #mappingModal > div { width:96%; margin:6% auto; max-height:90vh; }
      #uploadsModal > div { width:96%; margin:6% auto; max-height:90vh; overflow:auto; overscroll-behavior:contain; }
      #visualEditorSection > div { flex-direction: column; }
      #visualEditorSection > div > div:first-child { flex: 1 1 auto; max-height: 40vh; }
      #visualEditorSection > div > div:last-child { width: auto; max-height: none; }
    }
    footer {
      text-align: center;
      color: #4f8cff;
      font-size: 1.05em;
      margin: 2.5em 0 1em 0;
      letter-spacing: 0.2px;
      opacity: 0.85;
    }
  </style>
</head>
<body>
  <!-- Top navigation bar -->
  <div class="topbar">
    <div class="brand">Expense Tracker</div>
    <button id="menuToggleBtn" class="btn btn-neutral btn-sm" aria-label="Menu" aria-expanded="false">Menu</button>
    <div class="topbar-actions">
      <div id="authBadge" class="badge" style="display:none;">
        <div id="avatarCircle" class="avatar">U</div>
        <span id="authUserLabel" style="font-weight:700;"></span>
      </div>
      <button id="membersBtn" class="btn btn-neutral" style="display:none;">Members</button>
      <button id="memberRulesBtn" class="btn btn-neutral" style="display:none; margin-left:0.4em;">Transfer Mapping</button>
      <button id="memberInvestmentBtn" class="btn btn-neutral" style="display:none; margin-left:0.4em;">Investment Mapping</button>
      <span id="selectedMembersLabel" class="badge" style="display:none;"><span id="selectedMembersText"></span></span>
      <button id="profileBtn" class="btn btn-accent" style="display:none;">Profile</button>
      <button id="loginBtn" class="btn btn-outline">Login</button>
      <button id="logoutBtn" class="btn btn-neutral" style="display:none;">Logout</button>
    </div>
  </div>
  <div class="hero-bg"></div>
  <div id="main-container">
    <div class="header">
      <h1>Expense Tracker</h1>
      <p>Visualize, analyze, and drill down your expenses with ease.</p>
      <!-- Auth controls moved to topbar -->
    </div>
    <form id="uploadForm" novalidate>
      <input type="file" id="fileInput" name="files" accept=".xlsx,.xls" multiple style="display:none;" />
      <div class="file-group">
        <button type="button" id="selectMainFilesBtn" class="btn btn-primary">Select Files</button>
        <span id="mainFilesLabel" class="file-status">No files selected</span>
      </div>
      <button type="submit" class="btn btn-primary">Upload</button>
      <button type="button" id="annotateExcelBtn" class="btn btn-warn">Excel Comments</button>
      <button type="button" id="resetBtn" class="btn btn-danger">Reset</button>
      <button type="button" id="manageMappingBtn" class="btn btn-accent">Manage Categories</button>
      <button type="button" id="manageUploadsBtn" class="btn btn-primary">Manage Uploads</button>
    </form>
    <div id="annotateExcelResult" style="display:none; margin-top:0.6em; font-size:0.9em; color:#374151;"></div>
    <button id="drillback" class="btn btn-primary">Back</button>
    <button id="categoryEntriesBtn" style="display:none; margin-left:0.6em;" class="btn btn-accent">Category Entries</button>
    <div class="summary" id="summary"></div>
    <div id="chart-container">
      <div id="yearFilterBar">
        <span style="font-weight:600;">Year filter:</span>
        <select id="yearFilterModeSelect" style="margin-left:0.4em; padding:0.15em 0.4em; border-radius:6px; border:1px solid #cbd5e1; font-size:0.85em; background:#ffffff; color:#374151;">
          <option value="calendar">Calendar year</option>
          <option value="financial">Financial year (Apr-Mar)</option>
        </select>
        <div id="yearFilterOptions"></div>
        <button type="button" id="yearFilterClear" class="btn btn-neutral btn-sm">All years</button>
      </div>
      <canvas id="pieChart"></canvas>
    </div>
    <!-- Time analysis section -->
    <div id="time-section">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:0.8em; margin:0.2em 0 0.8em 0;">
        <h3 style="margin:0; color:#2563eb;">Time Analysis</h3>
        <div id="time-controls">
          <label for="timeViewSelect" style="color:#374151; font-weight:600;">View</label>
          <select id="timeViewSelect">
            <option value="monthly" selected>Monthly</option>
            <option value="yearly">Yearly</option>
          </select>
          <label for="timeYearSelect" id="timeYearLabel" style="color:#374151; font-weight:600;">Year</label>
          <select id="timeYearSelect"></select>
        </div>
      </div>
      <div style="width:100%; max-width:800px; margin:auto;">
        <canvas id="timeBarChart"></canvas>
      </div>
      <div id="timeSummary" style="text-align:center; margin-top:0.8em; color:#2563eb; font-weight:700;"></div>
    </div>
    <div class="category-list" id="categoryList"></div>
    <!-- Transfers section -->
    <div id="transfers-section" style="display:none; margin-top:2em; background:#f7faff; border-radius:14px; box-shadow:0 2px 12px #4f8cff11; padding:1.7em 1.2em; max-width:700px; margin-left:auto; margin-right:auto;">
      <h3 id="transfers-title" style="text-align:center; color:#2563eb; font-size:1.35em; margin-bottom:1.5em; font-weight:700;">Transfers Breakdown</h3>
      <div style="text-align:center; margin-bottom:0.8em;">
        <button id="transfersBack" class="btn btn-neutral" style="display:none;">Back</button>
        <button id="transfersCategoryEntriesBtn" class="btn btn-accent" style="display:none; margin-left:0.6em;">Category Entries</button>
      </div>
      <div style="width:100%; max-width:500px; margin:auto;">
        <canvas id="transfersPieChart"></canvas>
      </div>
      <div class="category-list" id="transfersCategoryList"></div>
      <div class="summary" id="transfersSummary"></div>
    </div>
    <!-- Investments section -->
    <div id="investments-section" style="display:none; margin-top:2em; background:#faf7ff; border-radius:14px; box-shadow:0 2px 12px #8b5cf611; padding:1.7em 1.2em; max-width:700px; margin-left:auto; margin-right:auto;">
      <h3 id="investments-title" style="text-align:center; color:#7c3aed; font-size:1.35em; margin-bottom:1.5em; font-weight:700;">Investments Breakdown</h3>
      <div style="text-align:center; margin-bottom:0.8em;">
        <button id="investmentsBack" class="btn btn-neutral" style="display:none;">Back</button>
        <button id="investmentsCategoryEntriesBtn" class="btn btn-accent" style="display:none; margin-left:0.6em;">Category Entries</button>
      </div>
      <div style="width:100%; max-width:500px; margin:auto;">
        <canvas id="investmentsPieChart"></canvas>
      </div>
      <div class="category-list" id="investmentsCategoryList"></div>
      <div class="summary" id="investmentsSummary"></div>
    </div>
    <div id="subchart-section" style="display:none; margin-top:2em;">
      <h3 id="subchart-title"></h3>
      <div style="width:100%; max-width:500px; margin:auto;">
        <canvas id="subPieChart"></canvas>
      </div>
      <div class="category-list" id="subCategoryList"></div>
    </div>
    <!-- Entries list panel -->
    <div id="entries-section" style="display:none; margin-top:1.8em; background:#f7faff; border-radius:14px; box-shadow:0 2px 12px #4f8cff11; padding:1.2em 1.2em; max-width:700px; margin-left:auto; margin-right:auto;">
      <div style="display:flex; align-items:center; gap:0.8em;">
        <h3 id="entries-title" style="margin:0; color:#2563eb;">Entries</h3>
        <input id="entriesFilter" type="text" placeholder="Filter description..." style="flex:1; padding:0.45em; border:1px solid #cbd5e1; border-radius:8px;" />
        <select id="entriesPageSize" style="padding:0.45em; border:1px solid #cbd5e1; border-radius:8px;">
          <option value="10">10</option>
          <option value="20" selected>20</option>
          <option value="50">50</option>
        </select>
      </div>
      <div style="overflow:auto; margin-top:0.8em;">
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr style="background:#eaf1fb; color:#2563eb;">
              <th style="text-align:left; padding:8px;">Date</th>
              <th style="text-align:left; padding:8px;">Description</th>
              <th style="text-align:right; padding:8px;">Amount</th>
              <th style="text-align:left; padding:8px;">Type</th>
              <th style="text-align:left; padding:8px;">Direction</th>
            </tr>
          </thead>
          <tbody id="entriesBody"></tbody>
        </table>
      </div>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:0.8em;">
        <div id="entriesInfo" style="color:#2563eb; font-weight:600;"></div>
        <div style="display:flex; gap:0.5em;">
          <button id="entriesPrev" class="btn btn-primary btn-sm">Prev</button>
          <button id="entriesNext" class="btn btn-primary btn-sm">Next</button>
          <button id="entriesClose" class="btn btn-neutral btn-sm">Close</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Mapping Editor Modal -->
  <div id="mappingModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:99;">
    <div style="max-width:1020px; width:94%; margin:4% auto; background:#fff; border-radius:12px; box-shadow:0 10px 40px #0003; max-height:88vh; overflow:auto; overscroll-behavior:contain;">
      <div style="padding:1em 1.2em; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between;">
        <h3 style="margin:0; color:#2563eb;">Manage Categories</h3>
        <div>
          <button id="closeMappingModal" class="btn btn-neutral btn-sm">Close</button>
        </div>
      </div>
      <div style="padding:0.8em 1.2em; display:flex; gap:0.6em; align-items:center;">
        <button id="tabVisualBtn" class="btn btn-primary btn-sm">Visual Editor</button>
        <button id="tabJsonBtn" class="btn btn-neutral btn-sm">JSON Editor</button>
        <span id="mappingStatus" style="margin-left:auto; color:#2563eb; font-weight:600;"></span>
      </div>
      <!-- Visual Editor -->
      <div id="visualEditorSection" style="padding:0.8em 1.2em 1.2em 1.2em; display:none;">
        <div style="display:flex; gap:1em; align-items:flex-start;">
          <!-- Left: Category list -->
          <div style="flex:0 0 280px; border:1px solid #e5e7eb; border-radius:10px; padding:0.7em; max-height:68vh; overflow:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5em;">
              <b style="color:#2563eb;">Main Categories</b>
              <button id="addMainCategoryBtn" class="btn btn-accent btn-sm">Add</button>
            </div>
            <div id="mainCategoryList" style="max-height:62vh; overflow:auto;"></div>
          </div>
          <!-- Right: Details -->
          <div style="flex:1; border:1px solid #e5e7eb; border-radius:10px; padding:0.9em; max-height:68vh; overflow:auto;">
            <div id="detailsPanel" style="display:none;">
              <div style="display:flex; gap:0.8em; align-items:center; flex-wrap:wrap;">
                <div style="flex:1; min-width:240px;">
                  <label style="display:block; font-weight:600; color:#374151;">Category Name</label>
                  <input id="mainCatNameInput" type="text" style="width:100%; padding:0.5em; border:1px solid #cbd5e1; border-radius:8px;" />
                </div>
                <div style="flex:1; min-width:180px;">
                  <label style="display:block; font-weight:600; color:#374151;">Short Name</label>
                  <input id="mainCatShortInput" type="text" style="width:100%; padding:0.5em; border:1px solid #cbd5e1; border-radius:8px;" />
                </div>
                <button id="deleteMainCategoryBtn" class="btn btn-danger btn-sm">Delete Category</button>
              </div>
              <div style="margin-top:0.8em;">
                <label style="display:block; font-weight:600; color:#374151;">Category Keywords</label>
                <div id="mainCatKeywords" style="display:flex; gap:0.4em; flex-wrap:wrap; margin:0.4em 0;"></div>
                <div style="display:flex; gap:0.5em;">
                  <input id="newMainKeyword" type="text" placeholder="Add keyword" style="flex:1; padding:0.5em; border:1px solid #cbd5e1; border-radius:8px;" />
                  <button id="addMainKeywordBtn" class="btn btn-primary btn-sm">Add</button>
                </div>
              </div>
              <hr style="margin:1em 0; border:none; border-top:1px solid #e5e7eb;" />
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <b style="color:#2563eb;">Subcategories</b>
                <button id="addSubCategoryBtn" class="btn btn-accent btn-sm">Add Subcategory</button>
              </div>
              <div id="subCategoryListPanel" style="margin-top:0.6em; max-height:52vh; overflow:auto;"></div>
              <div style="margin-top:1em; display:flex; gap:0.8em;">
                <button id="saveVisualBtn" class="btn btn-primary btn-sm">Save</button>
                <span id="visualValidationMsg" style="font-weight:600;"></span>
                <button id="toggleVisualWarningsBtn" class="btn btn-neutral btn-sm" style="display:none;">View details</button>
              </div>
              <div id="visualWarningsPanel" style="display:none; margin-top:0.6em; background:#fff7ed; border:1px solid #fed7aa; color:#7c2d12; border-radius:10px; padding:0.6em; max-height:160px; overflow:auto; font-family:Consolas, Menlo, monospace; font-size:12px;"></div>
            </div>
            <div id="noSelectionPanel" style="text-align:center; color:#6b7280;">Select a category to edit, or create a new one.</div>
          </div>
        </div>
      </div>
      <!-- JSON Editor -->
      <div id="jsonEditorSection" style="padding:0.8em 1.2em 1.2em 1.2em; display:none;">
        <div style="padding:0.2em 0.2em; display:flex; gap:0.8em; align-items:center; flex-wrap:wrap;">
          <input type="file" id="importJsonFile" accept=".json" />
          <button id="downloadMappingBtn" class="btn btn-neutral btn-sm">Download Current JSON</button>
        </div>
        <textarea id="mappingEditor" spellcheck="false" style="width:100%; height:420px; border:1px solid #cbd5e1; border-radius:10px; padding:0.8em; font-family:Consolas, 'SFMono-Regular', Menlo, Monaco, 'Ubuntu Mono', monospace; font-size:13px; line-height:1.5; resize:vertical;"></textarea>
        <div style="margin-top:0.8em; display:flex; gap:0.8em; align-items:center;">
          <button id="validateMappingBtn" class="btn btn-warn btn-sm">Validate</button>
          <button id="saveMappingBtn" class="btn btn-primary btn-sm">Save</button>
          <span id="validationMsg" style="color:#ef4444; font-weight:600;"></span>
          <button id="toggleWarningsBtn" class="btn btn-neutral btn-sm" style="display:none;">View details</button>
        </div>
        <div id="warningsPanel" style="display:none; margin-top:0.6em; background:#fff7ed; border:1px solid #fed7aa; color:#7c2d12; border-radius:10px; padding:0.6em; max-height:160px; overflow:auto; font-family:Consolas, Menlo, monospace; font-size:12px;"></div>
      </div>
    </div>
  </div>
  <footer>
    &copy; 2025 Expense Tracker &mdash; Designed for clarity and insight
  </footer>
  <script>
    // --- Family & Member selection ---
    let familyMembers = [];
    let selectedMemberIds = new Set();
    let primaryMemberId = null;
    function getSelectedMemberIdsString() {
      return Array.from(selectedMemberIds).join(',');
    }
    function getSelectedMemberNames() {
      const byId = new Map(familyMembers.map(m => [m.id, m]));
      const names = Array.from(selectedMemberIds).map(id => (byId.get(id)?.name || 'Unknown'));
      return names;
    }
    function updateSelectedMembersLabel() {
      const badge = document.getElementById('selectedMembersLabel');
      const txt = document.getElementById('selectedMembersText');
      if (!badge || !txt) return;
      if (!getToken()) { badge.style.display = 'none'; return; }
      const names = getSelectedMemberNames();
      if (names.length === 0) {
        const prim = familyMembers.find(m => m.id === primaryMemberId);
        txt.textContent = prim ? `Primary: ${prim.name}` : 'Primary';
      } else if (names.length === 1) {
        txt.textContent = `Member: ${names[0]}`;
      } else {
        txt.textContent = `Members: ${names.join(', ')}`;
      }
      badge.style.display = 'inline-flex';
    }
    async function loadFamily() {
      try {
        const res = await apiFetch('/my/family');
        const data = await res.json().catch(()=>({}));
        if (!res.ok) throw new Error(data && data.error ? data.error : 'Failed to load family');
        familyMembers = Array.isArray(data.members) ? data.members : [];
        primaryMemberId = data.primaryId || null;
        if (!selectedMemberIds.size && primaryMemberId) selectedMemberIds.add(primaryMemberId);
      } catch (e) {
        // If unauthorized or not available, keep empty
        console.warn('loadFamily:', e.message || e);
      }
    }
    async function openMembersModal() {
      if (!getToken()) { openAuthModal('login'); return; }
      // Build modal if not exists
      let modal = document.getElementById('membersModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'membersModal';
        modal.style.display = 'none'; modal.style.position='fixed'; modal.style.inset='0'; modal.style.background='rgba(0,0,0,0.35)'; modal.style.zIndex='120';
        modal.innerHTML = `
          <div style="max-width:480px; width:92%; margin:8% auto; background:#fff; border-radius:12px; box-shadow:0 10px 40px #0003;">
            <div style="padding:1em 1.2em; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between;">
              <h3 style="margin:0; color:#2563eb;">Select Members</h3>
              <button id="membersCloseBtn" class="btn btn-neutral btn-sm">Close</button>
            </div>
            <div style="padding:1.2em;">
              <div id="membersList" style="display:flex; flex-direction:column; gap:0.5em;"></div>
              <div style="display:flex; gap:0.6em; align-items:center; margin-top:0.8em;">
                <button id="membersAllBtn" class="btn btn-neutral btn-sm">Select All</button>
                <button id="membersClearBtn" class="btn btn-neutral btn-sm">Clear</button>
                <button id="membersApplyBtn" class="btn btn-primary btn-sm" style="margin-left:auto;">Apply</button>
              </div>
              <div style="margin-top:0.6em; color:#6b7280; font-weight:600;">Tip: Manage family in Profile â†’ Family</div>
            </div>
          </div>`;
        document.body.appendChild(modal);
        document.getElementById('membersCloseBtn').onclick = () => { modal.style.display = 'none'; };
        document.getElementById('membersAllBtn').onclick = () => {
          selectedMemberIds = new Set(familyMembers.map(m => m.id));
          renderMembersList();
        };
        document.getElementById('membersClearBtn').onclick = () => {
          selectedMemberIds = new Set(primaryMemberId ? [primaryMemberId] : []);
          renderMembersList();
        };
        document.getElementById('membersApplyBtn').onclick = async () => {
          modal.style.display = 'none';
          // Reload aggregated saved expenses with filters
          try {
            await fetchMapping();
            if (!selectedMemberIds.size && primaryMemberId) selectedMemberIds.add(primaryMemberId);
            const idsStr = getSelectedMemberIdsString();
            const url = idsStr ? ('/my/expenses?memberIds=' + encodeURIComponent(idsStr)) : '/my/expenses';
            const r = await apiFetch(url);
            const d = await r.json().catch(()=>({}));
            if (!r.ok) throw new Error(d && d.error ? d.error : 'Failed to load aggregated');
            chartData = d; window.chartData = d; currentType = null; currentParentCat = null; drillStack = [];
            await renderForMemberSelection(d);
            updateSelectedMembersLabel();
          } catch (e) { alert(e.message); }
        };
      }
      // Render list and open
      await loadFamily();
      renderMembersList();
      modal.style.display = 'block';
    }
    function renderMembersList() {
      const container = document.getElementById('membersList');
      if (!container) return;
      container.innerHTML = '';
      familyMembers.forEach(m => {
        const row = document.createElement('label');
        row.style.display = 'flex'; row.style.alignItems = 'center'; row.style.gap = '0.6em';
        const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = selectedMemberIds.has(m.id);
        cb.onchange = () => { if (cb.checked) selectedMemberIds.add(m.id); else selectedMemberIds.delete(m.id); };
        const nm = document.createElement('span'); nm.textContent = m.name + (m.isPrimary ? ' (Primary)' : ''); nm.style.fontWeight='600'; nm.style.color='#111827';
        row.appendChild(cb); row.appendChild(nm);
        container.appendChild(row);
      });
      if (!familyMembers.length) {
        const msg = document.createElement('div'); msg.style.color='#ef4444'; msg.style.fontWeight='600'; msg.textContent = 'No members yet. Add some in Profile.';
        container.appendChild(msg);
      }
    }
    // Reusable Confirm Modal
    (function initConfirmModal(){
      if (document.getElementById('confirmModal')) return;
      const m = document.createElement('div');
      m.id = 'confirmModal';
      m.style.display = 'none'; m.style.position='fixed'; m.style.inset='0'; m.style.background='rgba(0,0,0,0.35)'; m.style.zIndex='150';
      m.innerHTML = `
        <div style="max-width:420px; width:92%; margin:10% auto; background:#fff; border-radius:12px; box-shadow:0 12px 40px #0003; overflow:hidden;">
          <div style="padding:1em 1.2em; border-bottom:1px solid #e5e7eb;">
            <h3 style="margin:0; color:#111827;">Confirm</h3>
          </div>
          <div style="padding:1.2em; color:#374151;" id="confirmMessage"></div>
          <div style="padding:0.9em 1.2em; display:flex; gap:0.6em; justify-content:flex-end; border-top:1px solid #e5e7eb;">
            <button id="confirmCancelBtn" class="btn btn-neutral">Cancel</button>
            <button id="confirmOkBtn" class="btn btn-primary">OK</button>
          </div>
        </div>`;
        document.body.appendChild(m);
      let resolver = null;
      document.getElementById('confirmCancelBtn').onclick = () => { m.style.display='none'; resolver && resolver(false); };
      document.getElementById('confirmOkBtn').onclick = () => { m.style.display='none'; resolver && resolver(true); };
      window.showConfirm = function(message){
        document.getElementById('confirmMessage').textContent = message || '';
        m.style.display = 'block';
        return new Promise(resolve => { resolver = resolve; });
      };
    })();
        // --- API base (local vs hosted backend) ---
    const API_BASE = (window.location.hostname && window.location.hostname.endsWith('github.io'))
      ? ''
      : '';
    // --- Auth helpers ---
    function getToken() { return localStorage.getItem('token'); }
    function setToken(t) { if (t) localStorage.setItem('token', t); else localStorage.removeItem('token'); }
    function setUserEmail(e) { if (e) localStorage.setItem('userEmail', e); else localStorage.removeItem('userEmail'); }
    function authHeaders() {
      const t = getToken();
      return t ? { 'Authorization': 'Bearer ' + t } : {};
    }
    async function apiFetch(url, options = {}) {
      const opts = Object.assign({}, options);
      opts.headers = Object.assign({}, options.headers || {}, authHeaders());
      return fetch(API_BASE + url, opts);
    }
    function refreshAuthUI() {
      const email = localStorage.getItem('userEmail');
      const name = localStorage.getItem('userName');
      const has = !!getToken();
      const badge = document.getElementById('authBadge');
      const lbl = document.getElementById('authUserLabel');
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const profileBtn = document.getElementById('profileBtn');
      const membersBtn = document.getElementById('membersBtn');
      const selMembersBadge = document.getElementById('selectedMembersLabel');
      const selMembersText = document.getElementById('selectedMembersText');
      const memberRulesBtn = document.getElementById('memberRulesBtn');
      const avatar = document.getElementById('avatarCircle');
      const memberInvestmentBtn = document.getElementById('memberInvestmentBtn');
      if (has && (email || name)) {
        const greeting = name && name.trim() ? `Hello, ${name.trim()}` : `Hello, ${email}`;
        lbl.textContent = greeting;
        const initials = (name && name.trim()) ? name.trim().split(/\s+/).map(s=>s[0]).join('').slice(0,2).toUpperCase() : (email ? email[0].toUpperCase() : 'U');
        avatar.textContent = initials;
        badge.style.display = 'flex';
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline';
        profileBtn.style.display = 'inline';
        membersBtn.style.display = 'inline';
        if (selMembersBadge && selMembersText) {
          selMembersBadge.style.display = 'inline-flex';
        }
        if (memberRulesBtn) memberRulesBtn.style.display = 'inline';
        if (memberInvestmentBtn) memberInvestmentBtn.style.display = 'inline';
      } else {
        lbl.textContent = '';
        badge.style.display = 'none';
        loginBtn.style.display = 'inline';
        logoutBtn.style.display = 'none';
        profileBtn.style.display = 'none';
        if (membersBtn) membersBtn.style.display = 'none';
        if (selMembersBadge) selMembersBadge.style.display = 'none';
        if (memberRulesBtn) memberRulesBtn.style.display = 'none';
        if (memberInvestmentBtn) memberInvestmentBtn.style.display = 'none';
      }
    }

    // Mobile menu toggle
    (function initMobileMenu(){
      const menuBtn = document.getElementById('menuToggleBtn');
      const topbar = document.querySelector('.topbar');
      const actions = document.querySelector('.topbar-actions');
      if (!menuBtn || !topbar || !actions) return;
      menuBtn.onclick = () => {
        const open = topbar.classList.toggle('open');
        menuBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
      };
      actions.addEventListener('click', () => {
        if (topbar.classList.contains('open')) {
          topbar.classList.remove('open');
          menuBtn.setAttribute('aria-expanded', 'false');
        }
      });
    })();

    let chart, chartData, mapping;
    // Mapping editor context: global vs member-scoped
    let mappingEditContext = { mode: 'global', memberId: null, memberName: null };
    let timeChart;
    let inTimeDrill = false; // when drilling within time bar chart
    let entriesDateFilter = null; // { view: 'yearly'|'monthly', year: number, month: 0-11|null }
    let timeViewSelected = null; // 'monthly' | 'yearly'
    let timeYearSelected = null; // number
    let barDrillStack = []; // [{ level: 'category'|'subcategory', type, view, year, monthIndex, parentCat? }]
    let lastTimeSeries = null; // cache of { monthly, yearly }
    let selectedYearsForMain = new Set(); // global year filter for main donut & entries (empty = all years)
    let yearFilterMode = 'calendar'; // 'calendar' | 'financial' (Apr-Mar)
    let currentMainDataSnapshot = null; // last data object passed to showMainIncomeExpenseChart
    let currentExpenseAgg = null; // cached expense buckets for current main view
    let currentIncomeAgg = null; // cached income buckets for current main view
    let currentTaxAgg = null; // cached tax buckets (by subcategory)
    let drillStack = [];
    let currentType = null; // 'expense' | 'income' | null
    let currentParentCat = null;
    let lastTransfersData = null;
    let lastInvestmentsData = null;
    let transferParentCat = null;
    // Member-scoped transfers overlay
    let memberScopeActive = false; // active when exactly one member selected and rules exist
    let transfersOverlay = null; // { transfers, transfersOut, transfersIn, summary }
    let memberTransfersEntries = []; // synthesized entries for member transfers (for entries panel)
    let investmentsOverlay = null; // { investments, summary }
    let memberInvestmentsEntries = []; // synthesized entries for member investments (for entries panel)
    let investmentParentCat = null;
    let excludedEntryKeys = new Set(); // keys of entries to exclude from main entries when member scope active
    const COLORS = [
      '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF', '#8BC34A', '#E91E63', '#00BCD4', '#FFC107', '#795548', '#607D8B', '#9C27B0', '#F44336', '#3F51B5', '#009688', '#CDDC39', '#FFEB3B', '#FF9800'
    ];

    function formatINR(value) {
      const num = Number(value || 0);
      if (!isFinite(num)) return '0';
      return num.toLocaleString('en-IN', { maximumFractionDigits: 2, minimumFractionDigits: 0 });
    }

    // Center text plugin to avoid title overlap and add a premium feel
    const CenterTextPlugin = {
      id: 'centerText',
      beforeDraw(chart, args, opts) {
        if (!opts || !opts.lines || !chart.chartArea) return;
        const { ctx, chartArea: { left, right, top, bottom } } = chart;
        const x = (left + right) / 2;
        const y = (top + bottom) / 2;
        const lines = Array.isArray(opts.lines) ? opts.lines : [String(opts.lines)];
        const lineHeight = opts.lineHeight || 20;
        ctx.save();
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = opts.color || '#2563eb';
        ctx.font = opts.font || '700 15px Segoe UI';
        lines.forEach((line, i) => {
          ctx.fillText(line, x, y + (i - (lines.length - 1) / 2) * lineHeight);
        });
        ctx.restore();
        }
    };

    async function fetchMapping() {
      const res = await apiFetch('/mapping');
      mapping = await res.json();
    }

    // --- Member Transfer Rules UI & Logic ---
    function getSingleSelectedMemberId() {
      const ids = Array.from(selectedMemberIds);
      return ids.length === 1 ? ids[0] : null;
    }
    async function fetchMemberMapping(memberId) {
      if (!memberId) return {};
      const r = await apiFetch('/my/member-mapping/' + encodeURIComponent(memberId));
      const d = await r.json().catch(()=>({}));
      return r.ok && d && typeof d === 'object' ? d : {};
    }
    async function fetchInvestmentMapping(memberId) {
      if (!memberId) return {};
      const r = await apiFetch('/my/investment-mapping/' + encodeURIComponent(memberId));
      const d = await r.json().catch(()=>({}));
      return r.ok && d && typeof d === 'object' ? d : {};
    }
    // Local categorize helpers (mirror server)
    // Safer keyword matching: ordered token-prefix matching
    function tokenizeForMatch(s) {
      return String(s || '')
        .toLowerCase()
        .replace(/&/g, ' and ')
        .replace(/[^a-z0-9\s]/g, ' ')
        .trim()
        .split(/\s+/)
        .filter(Boolean);
    }
    function orderedPrefixTokenMatch(description, keyword) {
      const dt = tokenizeForMatch(description);
      const kt = tokenizeForMatch(keyword);
      if (!kt.length) return false;
      let i = 0;
      for (const tok of kt) {
        let found = false;
        while (i < dt.length && !found) {
          if (dt[i].startsWith(tok)) { found = true; i++; }
          else { i++; }
        }
        if (!found) return false;
      }
      return true;
    }
    function matchesKeywordLocal(description, keywords) {
      if (!Array.isArray(keywords) || !keywords.length) return false;
      const descStr = String(description || '').toLowerCase();
      return keywords.some(k => {
        const kwStr = String(k || '').toLowerCase();
        // Prefer robust ordered token-prefix matching
        if (orderedPrefixTokenMatch(description, k)) return true;
        // Fallback to simple substring match to catch phrasing/spacing variations
        return descStr.includes(kwStr);
      });
    }
    function matchesRuleLocal(amount, rule) {
      if (!rule) return false;
      if (rule.amountLessThan !== undefined && amount < rule.amountLessThan) return true;
      if (rule.amountGreaterThanOrEqual !== undefined && amount >= rule.amountGreaterThanOrEqual) return true;
      if (rule.amountEqualTo !== undefined && amount === rule.amountEqualTo) return true;
      return false;
    }
    function categorizeTransactionLocal(description, amount, mappingObj) {
      const descStr = typeof description === 'string' ? description.toLowerCase() : '';
      let best = { score: -1, main: 'Uncategorized', sub: undefined };
      const lenScore = (kw) => Math.min(String(kw).length, 40) / 40;
      for (const mainCat in mappingObj || {}) {
        const catObj = mappingObj[mainCat];
        const subs = Array.isArray(catObj?.subcategories) ? catObj.subcategories : [];
        let mainScore = -1;
        const isMainExcluded = Array.isArray(catObj?.excludeKeywords) && matchesKeywordLocal(description, catObj.excludeKeywords);
        if (!isMainExcluded && Array.isArray(catObj?.keywords)) {
          for (const kw of catObj.keywords) {
            const k = String(kw).toLowerCase();
            if (descStr.includes(k)) mainScore = Math.max(mainScore, 2 + lenScore(k));
          }
        }
        let subWinner = { sub: undefined, score: -1 };
        for (const sub of subs) {
          let kwMatch = false, kwBestScore = -1;
          const isSubExcluded = Array.isArray(sub.excludeKeywords) && matchesKeywordLocal(description, sub.excludeKeywords);
          if (!isSubExcluded && Array.isArray(sub.keywords)) {
            for (const kw of sub.keywords) {
              if (orderedPrefixTokenMatch(description, kw)) {
                kwMatch = true;
                kwBestScore = Math.max(kwBestScore, 3 + lenScore(String(kw)));
              }
            }
          }
          const hasRule = !!(sub && sub.rule && (sub.rule.amountLessThan !== undefined || sub.rule.amountGreaterThanOrEqual !== undefined || sub.rule.amountEqualTo !== undefined));
          const ruleMatch = hasRule && matchesRuleLocal(amount, sub.rule);
          const ruleWeight = hasRule && sub?.rule?.amountEqualTo !== undefined ? 2.8 : 2.5;
          const mode = (typeof sub.ruleMode === 'string') ? sub.ruleMode.toLowerCase() : (hasRule ? 'and' : 'or');
          let candidateScore = -1;
          if (isSubExcluded) candidateScore = -1;
          else if (mode === 'and') {
            const hasKeywords = Array.isArray(sub.keywords) && sub.keywords.length > 0;
            if (hasKeywords) {
              if (kwMatch && ruleMatch) candidateScore = Math.max(kwBestScore, 3.2) + 0.1;
            } else { if (ruleMatch) candidateScore = ruleWeight + 0.05; }
          } else {
            candidateScore = Math.max(kwBestScore, ruleMatch ? ruleWeight : -1);
          }
          if (candidateScore > subWinner.score) subWinner = { sub: sub.name, score: candidateScore };
        }
        const catScore = Math.max(mainScore, subWinner.score);
        if (catScore > best.score) best = { score: catScore, main: mainCat, sub: subWinner.sub };
      }
      return { main: best.main, sub: best.sub };
    }
    function deepClone(obj) { return JSON.parse(JSON.stringify(obj || {})); }
    function computeMemberTransfersFromEntries(entries, memberMap) {
      const agg = { transfers: {}, transfersOut: {}, transfersIn: {}, summary: { expense: 0, income: 0, transfers: 0, transfersOut: 0, transfersIn: 0 } };
      const matchedEntries = [];
      const add = (bucket, main, sub, amount) => {
        bucket[main] = (bucket[main] || 0) + amount;
        if (sub) bucket[`${main}::${sub}`] = (bucket[`${main}::${sub}`] || 0) + amount;
      };
      const list = Array.isArray(entries) ? entries : [];
      for (const e of list) {
        // Respect global year filter (calendar/financial) when active
        if (!matchesYearSelection(e)) continue;
        const amt = Number(e.amount || 0);
        if (!isFinite(amt) || amt <= 0) continue;
        const text = e.text || e.description || '';
        const cat = categorizeTransactionLocal(text, amt, memberMap || {});
        if (!cat || !cat.main || cat.main === 'Uncategorized') continue;
        const memberId = e && e.memberId ? e.memberId : null;
        // Treat all categories from member mapping as transfer categories
        let direction = e.direction;
        if (!direction) {
          if (e.type === 'expense') direction = 'out';
          else if (e.type === 'income') direction = 'in';
          else if (e.type === 'transfer') direction = e.direction || (amt >= 0 ? 'out' : 'in');
        }
        add(agg.transfers, cat.main, cat.sub, amt);
        if (direction === 'out') { add(agg.transfersOut, cat.main, cat.sub, amt); agg.summary.transfersOut += amt; }
        else { add(agg.transfersIn, cat.main, cat.sub, amt); agg.summary.transfersIn += amt; }
        agg.summary.transfers += amt;
        matchedEntries.push({ date: e.date, description: e.description, text, amount: amt, type: 'transfer', direction, main: cat.main, sub: cat.sub, memberId });
      }
      return { agg, matchedEntries };
    }
    function computeMemberInvestmentsFromEntries(entries, memberMap) {
      const agg = { investments: {}, summary: { total: 0 } };
      const matchedEntries = [];
      const add = (bucket, main, sub, amount) => {
        bucket[main] = (bucket[main] || 0) + amount;
        if (sub) bucket[`${main}::${sub}`] = (bucket[`${main}::${sub}`] || 0) + amount;
      };
      const list = Array.isArray(entries) ? entries : [];
      for (const e of list) {
        // Respect global year filter (calendar/financial) when active
        if (!matchesYearSelection(e)) continue;
        const amt = Number(e.amount || 0);
        if (!isFinite(amt) || amt <= 0) continue;
        const text = e.text || e.description || '';
        const cat = categorizeTransactionLocal(text, amt, memberMap || {});
        if (!cat || !cat.main || cat.main === 'Uncategorized') continue;
        const main = String(cat.main);
        const sub = cat.sub ? String(cat.sub) : undefined;
        const memberId = e && e.memberId ? e.memberId : null;
        // No special FD netting: aggregate exactly as mapped
        add(agg.investments, main, sub, amt);
        agg.summary.total += amt;
        matchedEntries.push({ date: e.date, description: e.description, text, amount: amt, type: 'investment', main, sub, memberId });
      }
      return { agg, matchedEntries };
    }
    function buildExcludedKeys(entries) {
      const s = new Set();
      const norm = (t) => String(t || '').trim().replace(/\s+/g, ' ').toLowerCase();
      for (const e of entries || []) {
        const text = e.text || e.description || '';
        const memberPart = e && e.memberId ? String(e.memberId) : '';
        const key = memberPart + '|' + norm(text) + '|' + String(Number(e.amount || 0));
        s.add(key);
      }
      return s;
    }
    function applyExclusionsToData(data, matchedEntries) {
      const out = deepClone(data);
      const subFromBucket = (bucket, main, sub, amt) => {
        if (!bucket) return;
        if (typeof bucket[main] === 'number') bucket[main] = Math.max(0, bucket[main] - amt);
        const k = `${main}::${sub}`;
        if (sub && typeof bucket[k] === 'number') bucket[k] = Math.max(0, bucket[k] - amt);
      };
      const norm = (s) => String(s || '').trim().replace(/\s+/g, ' ').toLowerCase();
      const tryFindSrc = (entry, list) => {
        const ea = Number(entry.amount || 0);
        const et = entry.text || entry.description || '';
        const net = norm(et);
        for (const x of list) {
          const xa = Number(x.amount || 0);
          if (xa !== ea) continue;
          if (entry.memberId && x.memberId && entry.memberId !== x.memberId) continue;
          const xt = x.text || x.description || '';
          const nxt = norm(xt);
          const xd = norm(x.description || '');
          const ed = norm(entry.description || '');
          if (nxt === net || xd === ed || nxt.includes(net) || net.includes(nxt) || nxt.includes(ed) || ed.includes(nxt)) {
            return x;
          }
        }
        return null;
      };
      for (const e of matchedEntries) {
        // Only subtract when original item wasnâ€™t a transfer already
        // Find matching entry in original by description+amount and type not 'transfer'
        // Best-effort: subtract from summary and category buckets based on e.type we derived from source entries
        const src = tryFindSrc(e, Array.isArray(data.entries) ? data.entries : []);
        const derivedType = src ? src.type : null;
        if (derivedType === 'expense') {
          subFromBucket(out.expense, src.main, src.sub, e.amount);
          if (out.summary && typeof out.summary.expense === 'number') out.summary.expense = Math.max(0, out.summary.expense - e.amount);
        } else if (derivedType === 'income') {
          subFromBucket(out.income, src.main, src.sub, e.amount);
          if (out.summary && typeof out.summary.income === 'number') out.summary.income = Math.max(0, out.summary.income - e.amount);
        } else {
          // Fallback: if we couldn't locate the exact source entry, adjust high-level totals
          // Use direction hint to decide which summary to reduce
          const dir = (e.direction === 'out') ? 'expense' : (e.direction === 'in' ? 'income' : null);
          if (dir && out.summary && typeof out.summary[dir] === 'number') {
            out.summary[dir] = Math.max(0, out.summary[dir] - e.amount);
            // Also reduce Uncategorized bucket as a safe default to avoid duplicates in main donut
            const bkt = dir === 'expense' ? out.expense : out.income;
            if (bkt && typeof bkt['Uncategorized'] === 'number') {
              bkt['Uncategorized'] = Math.max(0, bkt['Uncategorized'] - e.amount);
            }
          }
        }
      }
      return out;
    }
    async function renderForMemberSelection(baseData) {
      // Default: no overlay
      // Clear any open entries when switching selection
      try { document.getElementById('entries-section').style.display = 'none'; } catch {}
      // Reset transfers/investments UI before rebuilding
      hideTransfersUI();
      try { hideInvestmentsUI(); } catch {}
      memberScopeActive = false; transfersOverlay = null; investmentsOverlay = null; memberTransfersEntries = []; memberInvestmentsEntries = []; excludedEntryKeys = new Set();
      const ids = Array.from(selectedMemberIds);
      const memberId = ids.length === 1 ? ids[0] : null;
      if (!memberId) {
        // Multi-member selection: union exclusions across each member's transfer & investment mappings
        if (ids.length > 1) {
          try {
            const maps = await Promise.all(ids.map(id => fetchMemberMapping(id)));
            const invMaps = await Promise.all(ids.map(id => fetchInvestmentMapping(id)));
            let unionMatched = [];
            const seen = new Set();
            const perMemberViews = [];
            const perMemberInvestmentViews = [];
            // Build per-member charts and union exclusions
            const getMemberName = (id) => {
              const m = familyMembers.find(x => x.id === id);
              return m ? m.name : id;
            };
            for (let i = 0; i < maps.length; i++) {
              const m = maps[i];
              const id = ids[i];
              if (!m || !Object.keys(m).length) continue;
              const allEntries = Array.isArray(baseData.entries) ? baseData.entries : [];
              const memberEntries = allEntries.filter(e => !e.memberId || e.memberId === id);
              const { agg, matchedEntries } = computeMemberTransfersFromEntries(memberEntries, m);
              perMemberViews.push({ id, name: getMemberName(id), agg, matchedEntries });
              for (const e of matchedEntries) {
                const memberPart = e && e.memberId ? String(e.memberId) : '';
                const key = memberPart + '|' + (e.text || e.description || '') + '|' + String(e.amount);
                if (!seen.has(key)) { seen.add(key); unionMatched.push(e); }
              }
              const iMap = invMaps[i];
              if (iMap && Object.keys(iMap).length) {
                const allEntriesInv = Array.isArray(baseData.entries) ? baseData.entries : [];
                const memberEntriesInv = allEntriesInv.filter(e => !e.memberId || e.memberId === id);
                const { agg: iAgg, matchedEntries: iMatched } = computeMemberInvestmentsFromEntries(memberEntriesInv, iMap);
                perMemberInvestmentViews.push({ id, name: getMemberName(id), agg: iAgg, matchedEntries: iMatched });
                for (const e of iMatched) {
                  const memberPart = e && e.memberId ? String(e.memberId) : '';
                  const key = memberPart + '|' + (e.text || e.description || '') + '|' + String(e.amount);
                  if (!seen.has(key)) { seen.add(key); unionMatched.push(e); }
                }
              }
            }
            const adjusted = applyExclusionsToData(baseData, unionMatched);
            memberScopeActive = true; transfersOverlay = null; investmentsOverlay = null; memberTransfersEntries = []; memberInvestmentsEntries = [];
            excludedEntryKeys = buildExcludedKeys(unionMatched);
            showMainIncomeExpenseChart(adjusted);
            showTransfersChartsMulti(perMemberViews);
            showInvestmentsChartsMulti(perMemberInvestmentViews);
            return;
          } catch (e) {
            console.warn('Multi-member exclusions failed:', e.message || e);
            showMainIncomeExpenseChart(baseData);
            hideTransfersUI();
            return;
          }
        }
        // None selected
        excludedEntryKeys = new Set();
        showMainIncomeExpenseChart(baseData);
        hideTransfersUI();
        return;
      }
      try {
        const memberMap = await fetchMemberMapping(memberId);
        const invMap = await fetchInvestmentMapping(memberId);
        if ((!memberMap || !Object.keys(memberMap).length) && (!invMap || !Object.keys(invMap).length)) {
          excludedEntryKeys = new Set();
          showMainIncomeExpenseChart(baseData);
          // No rules -> hide transfers donut (member-specific only)
          hideTransfersUI(); hideInvestmentsUI();
          return;
        }
        let matchedAll = [];
        let adjusted = baseData;
        if (memberMap && Object.keys(memberMap).length) {
          const { agg, matchedEntries } = computeMemberTransfersFromEntries(baseData.entries || [], memberMap);
          transfersOverlay = Object.assign({}, agg, { entries: matchedEntries });
          memberTransfersEntries = matchedEntries;
          matchedAll = matchedAll.concat(matchedEntries);
          showTransfersChart(transfersOverlay.transfers);
        } else { hideTransfersUI(); }
        if (invMap && Object.keys(invMap).length) {
          const { agg: iAgg, matchedEntries: iMatched } = computeMemberInvestmentsFromEntries(baseData.entries || [], invMap);
          investmentsOverlay = Object.assign({}, iAgg, { entries: iMatched });
          memberInvestmentsEntries = iMatched;
          matchedAll = matchedAll.concat(iMatched);
          showInvestmentsChart(investmentsOverlay.investments);
        } else { hideInvestmentsUI(); }
        adjusted = applyExclusionsToData(baseData, matchedAll);
        memberScopeActive = true;
        excludedEntryKeys = buildExcludedKeys(matchedAll);
        showMainIncomeExpenseChart(adjusted);
      } catch (e) {
        console.warn('Member transfers/investments overlay failed:', e.message || e);
        excludedEntryKeys = new Set();
        showMainIncomeExpenseChart(baseData);
        hideTransfersUI(); hideInvestmentsUI();
      }
    }


    // Mapping editor helpers
    function setTab(tab) {
      const v = document.getElementById('visualEditorSection');
      const j = document.getElementById('jsonEditorSection');
      if (tab === 'visual') {
        v.style.display = 'block';
        j.style.display = 'none';
        document.getElementById('tabVisualBtn').style.background = '#2563eb';
        document.getElementById('tabJsonBtn').style.background = '#6b7280';
      } else {
        v.style.display = 'none';
        j.style.display = 'block';
        document.getElementById('tabVisualBtn').style.background = '#6b7280';
        document.getElementById('tabJsonBtn').style.background = '#2563eb';
      }
    }
    function openMappingModal(context) {
      if (context) mappingEditContext = context; // { mode: 'global'|'member', memberId?, memberName? }
      document.getElementById('mappingModal').style.display = 'block';
      const titleEl = document.querySelector('#mappingModal h3');
      if (titleEl) {
        if (mappingEditContext.mode === 'member' && mappingEditContext.memberName) {
          titleEl.textContent = 'Transfer Mapping â€” ' + mappingEditContext.memberName;
        } else if (mappingEditContext.mode === 'member-investment' && mappingEditContext.memberName) {
          titleEl.textContent = 'Investment Mapping â€” ' + mappingEditContext.memberName;
        } else {
          titleEl.textContent = 'Manage Categories';
        }
      }
      // Load mapping per context
      const url = (mappingEditContext.mode === 'member' && mappingEditContext.memberId)
        ? ('/my/member-mapping/' + encodeURIComponent(mappingEditContext.memberId))
        : (mappingEditContext.mode === 'member-investment' && mappingEditContext.memberId)
          ? ('/my/investment-mapping/' + encodeURIComponent(mappingEditContext.memberId))
          : '/mapping';
      apiFetch(url).then(r => r.json()).then(json => {
        mapping = json && typeof json === 'object' ? json : {};
        document.getElementById('mappingEditor').value = JSON.stringify(mapping, null, 2);
        document.getElementById('validationMsg').textContent = '';
        renderMainCategoryList();
        clearDetailsPanel();
        document.getElementById('mappingStatus').style.color = '#2563eb';
        document.getElementById('mappingStatus').textContent = (mappingEditContext.mode === 'member' || mappingEditContext.mode === 'member-investment') ? 'Loaded member mapping' : 'Loaded current mapping';
        setTab('visual');
      }).catch(async err => {
        // Fallback for static hosting (e.g., GitHub Pages) where the
        // /mapping API is not available: try loading the bundled
        // category-mapping.json file directly.
        let loadedFromStatic = false;
        try {
          const resp = await fetch('category-mapping.json');
          if (resp && resp.ok) {
            const json = await resp.json();
            mapping = json && typeof json === 'object' ? json : {};
            document.getElementById('mappingEditor').value = JSON.stringify(mapping, null, 2);
            document.getElementById('validationMsg').textContent = '';
            renderMainCategoryList();
            clearDetailsPanel();
            document.getElementById('mappingStatus').style.color = '#2563eb';
            document.getElementById('mappingStatus').textContent = 'Loaded static mapping (read-only)';
            setTab('visual');
            loadedFromStatic = true;
          }
        } catch (e) {
          // Ignore and fall through to error state
        }
        if (!loadedFromStatic) {
          document.getElementById('mappingStatus').style.color = '#ef4444';
          document.getElementById('mappingStatus').textContent = 'Failed to load mapping';
          setTab('json');
        }
      });
    }
    function closeMappingModal() {
      document.getElementById('mappingModal').style.display = 'none';
    }
    function validateEditorJson() {
      const txt = document.getElementById('mappingEditor').value;
      try {
        const obj = JSON.parse(txt);
        if (!obj || typeof obj !== 'object' || Array.isArray(obj)) throw new Error('Root must be an object.');
        document.getElementById('validationMsg').style.color = '#16a34a';
        document.getElementById('validationMsg').textContent = 'Valid JSON';
        return obj;
      } catch (e) {
        document.getElementById('validationMsg').style.color = '#ef4444';
        document.getElementById('validationMsg').textContent = 'Invalid JSON: ' + e.message;
        return null;
      }
    }
    async function saveEditorJson() {
      const obj = validateEditorJson();
      if (!obj) return;
      try {
        const url = (mappingEditContext.mode === 'member' && mappingEditContext.memberId)
          ? ('/my/member-mapping/' + encodeURIComponent(mappingEditContext.memberId))
          : (mappingEditContext.mode === 'member-investment' && mappingEditContext.memberId)
            ? ('/my/investment-mapping/' + encodeURIComponent(mappingEditContext.memberId))
            : '/mapping';
        const res = await apiFetch(url, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(obj)
        });
        const payload = await res.json().catch(() => ({}));
        if (!res.ok) {
          let msg = payload.error || 'Save failed';
          if (payload.errors && Array.isArray(payload.errors)) {
            msg += ' â€” ' + payload.errors.join('; ');
          }
          throw new Error(msg);
        }
        document.getElementById('mappingStatus').style.color = '#16a34a';
        document.getElementById('mappingStatus').textContent = 'Saved âœ”' + (payload.warnings && payload.warnings.length ? ` (Warnings: ${payload.warnings.length})` : '');
        mapping = obj; // update in-memory mapping for current session
        const valEl = document.getElementById('validationMsg');
        const toggleBtn = document.getElementById('toggleWarningsBtn');
        const panel = document.getElementById('warningsPanel');
        if (payload.warnings && payload.warnings.length) {
          valEl.style.color = '#f59e0b';
          valEl.textContent = `Warnings: ${payload.warnings.length}`;
          toggleBtn.style.display = 'inline-block';
          panel.innerHTML = payload.warnings.map(w => {
            return (typeof w === 'string')
              ? `<div>â€¢ ${w}</div>`
              : `<div>â€¢ Keyword '<b>${w.keyword}</b>' overlaps in ${w.locations.map(l => l.sub ? `${l.main}/${l.sub}` : l.main).join(', ')}</div>`;
          }).join('');
        } else {
          valEl.textContent = '';
          toggleBtn.style.display = 'none';
          panel.style.display = 'none';
          panel.innerHTML = '';
        }
        // Refresh visual editor with latest mapping
        renderMainCategoryList();
        clearDetailsPanel();
        // If saving member mapping and the same member is selected, refresh overlay
        if ((mappingEditContext.mode === 'member' || mappingEditContext.mode === 'member-investment') && getSingleSelectedMemberId() === mappingEditContext.memberId && chartData) {
          await renderForMemberSelection(chartData);
        }
      } catch (e) {
        document.getElementById('mappingStatus').style.color = '#ef4444';
        document.getElementById('mappingStatus').textContent = 'Save failed: ' + e.message;
      }
    }
    // Toggle JSON warnings panel
    (function(){
      const btn = document.getElementById('toggleWarningsBtn');
      const panel = document.getElementById('warningsPanel');
      if (btn) {
        btn.onclick = function(){
          const show = panel.style.display !== 'block';
          panel.style.display = show ? 'block' : 'none';
          btn.textContent = show ? 'Hide details' : 'View details';
        };
      }
    })();
    function downloadCurrentMapping() {
      const blob = new Blob([document.getElementById('mappingEditor').value || '{}'], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'category-mapping.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    function importJsonFile(file) {
      const reader = new FileReader();
      reader.onload = () => {
        const text = reader.result;
        document.getElementById('mappingEditor').value = text;
        document.getElementById('validationMsg').textContent = '';
      };
      reader.readAsText(file);
    }

    // Visual editor logic
    let selectedMainCat = null;
    function chip(label, onRemove) {
      const span = document.createElement('span');
      span.textContent = label;
      span.style.background = '#eaf1fb';
      span.style.color = '#2563eb';
      span.style.padding = '0.25em 0.55em';
      span.style.borderRadius = '999px';
      span.style.display = 'inline-flex';
      span.style.alignItems = 'center';
      span.style.gap = '6px';
      span.style.boxShadow = '0 1px 3px #4f8cff22';
      const btn = document.createElement('button');
      btn.textContent = 'Ã—';
      btn.style.background = '#d1d5db';
      btn.style.borderRadius = '999px';
      btn.style.padding = '0 6px';
      btn.style.cursor = 'pointer';
      btn.onclick = () => onRemove();
      span.appendChild(btn);
      return span;
    }
    function renderMainCategoryList() {
      const list = document.getElementById('mainCategoryList');
      list.innerHTML = '';
      Object.keys(mapping).forEach(name => {
        const row = document.createElement('div');
        row.style.padding = '0.35em 0.5em';
        row.style.borderRadius = '8px';
        row.style.cursor = 'pointer';
        row.textContent = name;
        row.onclick = () => selectMainCategory(name);
        if (selectedMainCat === name) {
          row.style.background = '#eaf1fb';
          row.style.color = '#2563eb';
          row.style.fontWeight = '600';
        }
        list.appendChild(row);
      });
    }
    function clearDetailsPanel() {
      selectedMainCat = null;
      document.getElementById('detailsPanel').style.display = 'none';
      document.getElementById('noSelectionPanel').style.display = 'block';
    }
    function selectMainCategory(name) {
      selectedMainCat = name;
      renderMainCategoryList();
      const cat = mapping[name] || { shortName: '', keywords: [], subcategories: [] };
      document.getElementById('detailsPanel').style.display = 'block';
      document.getElementById('noSelectionPanel').style.display = 'none';
      document.getElementById('mainCatNameInput').value = name;
      document.getElementById('mainCatShortInput').value = cat.shortName || '';
      // Keywords
      const kwWrap = document.getElementById('mainCatKeywords');
      kwWrap.innerHTML = '';
      (cat.keywords || []).forEach((kw, idx) => {
        kwWrap.appendChild(chip(String(kw), () => {
          cat.keywords.splice(idx, 1);
          mapping[name] = cat;
          selectMainCategory(name);
        }));
      });
      // Exclude Keywords (main)
      let exWrap = document.getElementById('mainCatExcludeKeywords');
      if (!exWrap) {
        const container = document.createElement('div');
        container.innerHTML = `
          <div style="margin-top:0.8em;">
            <label style="display:block; font-weight:600; color:#374151;">Category Exclude Keywords</label>
            <div id="mainCatExcludeKeywords" style="display:flex; gap:0.4em; flex-wrap:wrap; margin:0.4em 0;"></div>
            <div style="display:flex; gap:0.5em;">
              <input id="newMainExcludeKeyword" type="text" placeholder="Add exclude keyword" style="flex:1; padding:0.5em; border:1px solid #cbd5e1; border-radius:8px;" />
              <button id="addMainExcludeKeywordBtn" class="btn btn-primary btn-sm">Add</button>
            </div>
          </div>
        `;
        kwWrap.parentElement.appendChild(container);
        exWrap = container.querySelector('#mainCatExcludeKeywords');
      } else {
        exWrap.innerHTML = '';
      }
      (cat.excludeKeywords || []).forEach((kw, idx) => {
        exWrap.appendChild(chip(String(kw), () => {
          cat.excludeKeywords.splice(idx, 1);
          mapping[name] = cat;
          selectMainCategory(name);
        }));
      });
      // Subcategories
      const subPanel = document.getElementById('subCategoryListPanel');
      subPanel.innerHTML = '';
      (cat.subcategories || []).forEach((sub, i) => {
        const box = document.createElement('div');
        box.style.border = '1px solid #e5e7eb';
        box.style.borderRadius = '8px';
        box.style.padding = '0.6em';
        box.style.marginBottom = '0.6em';
        box.innerHTML = `
          <div style="display:flex; gap:0.6em; align-items:center; flex-wrap:wrap;">
            <div style="flex:1; min-width:200px;">
              <label style="display:block; font-weight:600; color:#374151;">Name</label>
              <input data-sub="name" data-idx="${i}" type="text" value="${sub.name || ''}" style="width:100%; padding:0.45em; border:1px solid #cbd5e1; border-radius:8px;" />
            </div>
            <div style="flex:1; min-width:160px;">
              <label style="display:block; font-weight:600; color:#374151;">Short Name</label>
              <input data-sub="shortName" data-idx="${i}" type="text" value="${sub.shortName || ''}" style="width:100%; padding:0.45em; border:1px solid #cbd5e1; border-radius:8px;" />
            </div>
            <button data-action="deleteSub" data-idx="${i}" class="btn btn-danger btn-sm">Delete</button>
          </div>
          <div style="margin-top:0.6em;">
            <label style="display:block; font-weight:600; color:#374151;">Keywords</label>
            <div id="subKw-${i}" style="display:flex; gap:0.4em; flex-wrap:wrap; margin:0.4em 0;"></div>
            <div style="display:flex; gap:0.5em;">
              <input data-sub="newKeyword" data-idx="${i}" type="text" placeholder="Add keyword" style="flex:1; padding:0.45em; border:1px solid #cbd5e1; border-radius:8px;" />
              <button data-action="addSubKeyword" data-idx="${i}" class="btn btn-primary btn-sm">Add</button>
            </div>
          </div>
          <div style="margin-top:0.6em;">
            <label style="display:block; font-weight:600; color:#374151;">Exclude Keywords</label>
            <div id="subExKw-${i}" style="display:flex; gap:0.4em; flex-wrap:wrap; margin:0.4em 0;"></div>
            <div style="display:flex; gap:0.5em;">
              <input data-sub="newExcludeKeyword" data-idx="${i}" type="text" placeholder="Add exclude keyword" style="flex:1; padding:0.45em; border:1px solid #cbd5e1; border-radius:8px;" />
              <button data-action="addSubExcludeKeyword" data-idx="${i}" class="btn btn-primary btn-sm">Add</button>
            </div>
          </div>
          <div style="display:flex; gap:0.6em; align-items:center; flex-wrap:wrap; margin-top:0.6em;">
            <div>
              <label style="display:block; font-weight:600; color:#374151;">amountLessThan</label>
              <input data-sub="amountLessThan" data-idx="${i}" type="number" value="${sub.rule?.amountLessThan ?? ''}" style="width:140px; padding:0.45em; border:1px solid #cbd5e1; border-radius:8px;" />
            </div>
            <div>
              <label style="display:block; font-weight:600; color:#374151;">amountGreaterThanOrEqual</label>
              <input data-sub="amountGreaterThanOrEqual" data-idx="${i}" type="number" value="${sub.rule?.amountGreaterThanOrEqual ?? ''}" style="width:140px; padding:0.45em; border:1px solid #cbd5e1; border-radius:8px;" />
            </div>
            <div>
              <label style="display:block; font-weight:600; color:#374151;">amountEqualTo</label>
              <input data-sub="amountEqualTo" data-idx="${i}" type="number" value="${sub.rule?.amountEqualTo ?? ''}" style="width:140px; padding:0.45em; border:1px solid #cbd5e1; border-radius:8px;" />
            </div>
          </div>
        `;
        subPanel.appendChild(box);
        // Render sub keywords chips
        const subKwWrap = box.querySelector(`#subKw-${i}`);
        (sub.keywords || []).forEach((kw, idx2) => {
          subKwWrap.appendChild(chip(String(kw), () => {
            sub.keywords.splice(idx2, 1);
            mapping[name].subcategories[i] = sub;
            selectMainCategory(name);
          }));
        });
        // Render sub exclude keywords chips
        const subExWrap = box.querySelector(`#subExKw-${i}`);
        (sub.excludeKeywords || []).forEach((kw, idx2) => {
          subExWrap.appendChild(chip(String(kw), () => {
            sub.excludeKeywords.splice(idx2, 1);
            mapping[name].subcategories[i] = sub;
            selectMainCategory(name);
          }));
        });
        // Bind actions
        box.querySelectorAll('input[data-sub]').forEach(inp => {
          inp.onchange = (e) => {
            const key = e.target.getAttribute('data-sub');
            const idx = Number(e.target.getAttribute('data-idx'));
            const sc = mapping[name].subcategories[idx];
            if (key === 'name') sc.name = e.target.value;
            else if (key === 'shortName') sc.shortName = e.target.value;
            else if (key === 'newKeyword') { /* handled by add button */ }
            else if (key === 'newExcludeKeyword') { /* handled by add button */ }
            else {
              sc.rule = sc.rule || {};
              const val = e.target.value === '' ? undefined : Number(e.target.value);
              if (val === undefined || isNaN(val)) delete sc.rule[key]; else sc.rule[key] = val;
            }
            mapping[name].subcategories[idx] = sc;
          };
        });
        box.querySelector('[data-action="addSubKeyword"]').onclick = () => {
          const idx = Number(box.querySelector('[data-action="addSubKeyword"]').getAttribute('data-idx'));
          const input = box.querySelector('input[data-sub="newKeyword"]');
          const val = input.value.trim();
          if (!val) return;
          const sc = mapping[name].subcategories[idx];
          sc.keywords = sc.keywords || [];
          sc.keywords.push(val);
          input.value = '';
          selectMainCategory(name);
        };
        box.querySelector('[data-action="addSubExcludeKeyword"]').onclick = () => {
          const idx = Number(box.querySelector('[data-action="addSubExcludeKeyword"]').getAttribute('data-idx'));
          const input = box.querySelector('input[data-sub="newExcludeKeyword"]');
          const val = input.value.trim();
          if (!val) return;
          const sc = mapping[name].subcategories[idx];
          sc.excludeKeywords = sc.excludeKeywords || [];
          sc.excludeKeywords.push(val);
          input.value = '';
          selectMainCategory(name);
        };
        box.querySelector('[data-action="deleteSub"]').onclick = () => {
          mapping[name].subcategories.splice(i, 1);
          selectMainCategory(name);
        };
      });
      // Bind main inputs
      document.getElementById('mainCatNameInput').onchange = (e) => {
        const newName = e.target.value.trim();
        if (!newName || newName === selectedMainCat) return;
        if (mapping[newName]) {
          setVisualMsg('Category name already exists', true);
          e.target.value = selectedMainCat;
          return;
        }
        // rename key
        const val = mapping[selectedMainCat];
        delete mapping[selectedMainCat];
        mapping[newName] = val;
        selectedMainCat = newName;
        renderMainCategoryList();
        selectMainCategory(newName);
      };
      document.getElementById('mainCatShortInput').onchange = (e) => {
        const cat = mapping[selectedMainCat];
        cat.shortName = e.target.value;
        mapping[selectedMainCat] = cat;
      };
      document.getElementById('addMainKeywordBtn').onclick = () => {
        const input = document.getElementById('newMainKeyword');
        const val = input.value.trim();
        if (!val) return;
        const cat = mapping[selectedMainCat];
        cat.keywords = cat.keywords || [];
        cat.keywords.push(val);
        input.value = '';
        selectMainCategory(selectedMainCat);
      };
      const addExBtn = document.getElementById('addMainExcludeKeywordBtn');
      if (addExBtn) {
        addExBtn.onclick = () => {
          const input = document.getElementById('newMainExcludeKeyword');
          const val = input.value.trim();
          if (!val) return;
          const cat = mapping[selectedMainCat];
          cat.excludeKeywords = cat.excludeKeywords || [];
          cat.excludeKeywords.push(val);
          input.value = '';
          selectMainCategory(selectedMainCat);
        };
      }
      document.getElementById('deleteMainCategoryBtn').onclick = () => {
        if (!selectedMainCat) return;
        delete mapping[selectedMainCat];
        clearDetailsPanel();
        renderMainCategoryList();
      };
      document.getElementById('addSubCategoryBtn').onclick = () => {
        const cat = mapping[selectedMainCat];
        cat.subcategories = Array.isArray(cat.subcategories) ? cat.subcategories : [];
        cat.subcategories.push({ name: 'New Subcategory', shortName: '', keywords: [], excludeKeywords: [], rule: {} });
        mapping[selectedMainCat] = cat;
        selectMainCategory(selectedMainCat);
      };
      document.getElementById('saveVisualBtn').onclick = saveVisualMapping;
      setVisualMsg('');
    }
    function setVisualMsg(msg, isError) {
      const el = document.getElementById('visualValidationMsg');
      el.textContent = msg || '';
      el.style.color = isError ? '#ef4444' : '#16a34a';
    }
    function saveVisualMapping() {
      // Basic validations
      const names = Object.keys(mapping);
      const nameSet = new Set(names.map(n => n.toLowerCase()));
      if (nameSet.size !== names.length) {
        setVisualMsg('Duplicate main category names found', true);
        return;
      }
      for (const mc of names) {
        const subs = mapping[mc].subcategories || [];
        const sNames = subs.map(s => (s.name || '').toLowerCase());
        const sSet = new Set(sNames);
        if (sSet.size !== sNames.length) {
          setVisualMsg(`Duplicate subcategory names in ${mc}`, true);
          return;
        }
      }
      const url = (mappingEditContext.mode === 'member' && mappingEditContext.memberId)
        ? ('/my/member-mapping/' + encodeURIComponent(mappingEditContext.memberId))
        : (mappingEditContext.mode === 'member-investment' && mappingEditContext.memberId)
          ? ('/my/investment-mapping/' + encodeURIComponent(mappingEditContext.memberId))
          : '/mapping';
      apiFetch(url, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(mapping)
      }).then(async res => {
        const payload = await res.json().catch(() => ({}));
        if (!res.ok) {
          let msg = payload.error || 'Save failed';
          if (payload.errors && Array.isArray(payload.errors)) {
            msg += ' â€” ' + payload.errors.join('; ');
          }
          throw new Error(msg);
        }
        document.getElementById('mappingStatus').style.color = '#16a34a';
        document.getElementById('mappingStatus').textContent = 'Saved âœ”' + (payload.warnings && payload.warnings.length ? ` (Warnings: ${payload.warnings.length})` : '');
        const toggleBtn = document.getElementById('toggleVisualWarningsBtn');
        const panel = document.getElementById('visualWarningsPanel');
        if (payload.warnings && payload.warnings.length) {
          setVisualMsg(`Warnings: ${payload.warnings.length}`, false);
          toggleBtn.style.display = 'inline-block';
          panel.innerHTML = payload.warnings.map(w => {
            return (typeof w === 'string')
              ? `<div>â€¢ ${w}</div>`
              : `<div>â€¢ Keyword '<b>${w.keyword}</b>' overlaps in ${w.locations.map(l => l.sub ? `${l.main}/${l.sub}` : l.main).join(', ')}</div>`;
          }).join('');
        } else {
          setVisualMsg('Saved âœ”', false);
          toggleBtn.style.display = 'none';
          panel.style.display = 'none';
          panel.innerHTML = '';
        }
        // If saving member mapping and the same member is selected, refresh overlay
        if ((mappingEditContext.mode === 'member' || mappingEditContext.mode === 'member-investment') && getSingleSelectedMemberId() === mappingEditContext.memberId && chartData) {
          await renderForMemberSelection(chartData);
        }
      }).catch(err => {
        setVisualMsg('Save failed: ' + err.message, true);
        document.getElementById('mappingStatus').style.color = '#ef4444';
        document.getElementById('mappingStatus').textContent = 'Save failed';
      });
    }
    // Toggle Visual warnings panel
    (function(){
      const btn = document.getElementById('toggleVisualWarningsBtn');
      const panel = document.getElementById('visualWarningsPanel');
      if (btn) {
        btn.onclick = function(){
          const show = panel.style.display !== 'block';
          panel.style.display = show ? 'block' : 'none';
          btn.textContent = show ? 'Hide details' : 'View details';
        };
      }
    })();

    function getSubcategories(category) {
      if (!mapping[category]) return [];
      return mapping[category];
    }

    let inSubChart = false;
    let subChart;
    let lastSubCat = null;
    let lastSubData = null;
    // Cache the last rendered breakdown dataset to avoid recomputation on Back
    let lastBreakdownData = null; // snapshot of data.expense or data.income used in showCategoryBreakdown
    let lastBreakdownType = null; // 'expense' | 'income'
    let currentEntries = [];
    let entriesPage = 1;
    let entriesPageSize = 20;
    // Show main pie: Income vs Expense (with Tax treated as income deduction), then drilldown to sources
    function showMainIncomeExpenseChart(data) {
      // Remember the latest data snapshot driving the main donut
      currentMainDataSnapshot = data || chartData || null;
      // Build year filter controls based on available entry years
      try { rebuildYearFilterControls(currentMainDataSnapshot); } catch (e) { console.warn('Year filter build failed:', e); }

      const ctx = document.getElementById('pieChart').getContext('2d');
      if (chart) chart.destroy();
      // Compute totals and category buckets from entries so donut matches time analysis and year filters.
      // Tax is treated as a separate bucket that is deducted from income and not counted as expense.
      const totals = computeMainTotalsFromEntries(currentMainDataSnapshot);
      const grossIncome = totals.incomeTotal || 0;
      const taxTotal = totals.taxTotal || 0;
      const netIncome = Math.max(0, grossIncome - taxTotal);
      const mainData = [totals.expenseTotal, netIncome];
      currentExpenseAgg = totals.expenseAgg || {};
      currentIncomeAgg = totals.incomeAgg || {};
      currentTaxAgg = totals.taxAgg || {};
      const mainLabels = ['Expense', 'Net Income'];
      currentType = null;
      currentParentCat = null;
      drillStack = [];
      chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: mainLabels,
          datasets: [{
            data: mainData,
            backgroundColor: [COLORS[0], COLORS[1]],
            cutout: '58%'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: false },
            legend: { display: false },
            datalabels: {
              color: '#222',
              backgroundColor: 'rgba(255,255,255,0.85)',
              borderColor: '#cbd5e1',
              borderWidth: 1,
              borderRadius: 6,
              padding: 2,
              font: (ctx) => {
                const data = ctx.dataset.data;
                const value = data[ctx.dataIndex];
                const total = data.reduce((a,b)=>a+b,0);
                const pct = value / total;
                return { weight: 'bold', size: Math.round(12 + pct * 4) };
              },
              formatter: function(value, context) {
                const percent = (value / (mainData[0] + mainData[1]) * 100).toFixed(1);
                const label = mainLabels[context.dataIndex];
                return `${label}\n${percent}%`;
              },
              anchor: 'center',
              align: 'center',
              offset: 0,
              display: true,
              clip: false,
              clamp: true
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.parsed;
                  const percent = ((value / (mainData[0] + mainData[1])) * 100).toFixed(1);
                  const label = mainLabels[context.dataIndex];
                  return `${label}: â‚¹${formatINR(value)} (${percent}%)`;
                }
              }
            },
            centerText: {
              lines: ['Income vs Expense'],
              font: '700 16px Segoe UI',
              color: '#2563eb'
            }
          },
          onClick: (e, elements) => {
            if (elements.length) {
              const idx = elements[0].index;
              if (idx === 0) {
                // Expense clicked
                drillStack.push({ view: 'main' });
                showCategoryBreakdown(currentExpenseAgg || {}, 'Expense Breakdown', 'expense');
              } else if (idx === 1) {
                // Income clicked
                drillStack.push({ view: 'main' });
                showCategoryBreakdown(currentIncomeAgg || {}, 'Income Breakdown', 'income');
              }
            }
          }
        },
        plugins: [ChartDataLabels, CenterTextPlugin]
      });
      // Show summary
      document.getElementById('summary').innerHTML = `
       <b>Tax (deducted from income):</b> â‚¹${formatINR(taxTotal)}`;
      // Show legend
      const legendBase = mainLabels.map((label, i) => {
        const value = mainData[i];
        const percent = (value / (mainData[0] + mainData[1]) * 100).toFixed(1);
        return `<li><span class=\"category-color\" style=\"background:${COLORS[i % COLORS.length]}\"></span> <b>${label}</b>: â‚¹${formatINR(value)} (${percent}%)</li>`;
      }).join('');
      // Add a clickable Tax pill so you can inspect Tax entries,
      // without making Tax a separate slice in the main donut.
      let taxLegend = '';
      if (taxTotal > 0) {
        const pctOfIncome = grossIncome > 0 ? ((taxTotal / grossIncome) * 100).toFixed(1) : '0.0';
        const color = COLORS[2 % COLORS.length];
        taxLegend = `<li class=\"legend-item\" data-type=\"expense\" data-key=\"Tax\" style=\"cursor:pointer;\" title=\"Tap to view Tax entries\"><span class=\"category-color\" style=\"background:${color}\"></span> <b>Tax (deducted from income)</b>: â‚¹${formatINR(taxTotal)} (${pctOfIncome}% of income)</li>`;
      }
      document.getElementById('categoryList').innerHTML = `<ul>${legendBase}${taxLegend}</ul>`;
      document.getElementById('subchart-section').style.display = 'none';
      inSubChart = false;
      document.getElementById('drillback').style.display = 'none';
      document.getElementById('categoryEntriesBtn').style.display = 'none';

      // Also render transfers donut if available (respect member-scoped overlay)
      const transfersBase = transfersOverlay || data;
      showTransfersChart(transfersBase.transfers);

      // Build and show time analysis
      try { initAndRenderTimeAnalysis(data); } catch (e) { console.error('Time analysis failed:', e); }
    }

    // Show breakdown for expense or income
    function showCategoryBreakdown(data, title, type) {
      const ctx = document.getElementById('pieChart').getContext('2d');
      if (chart) chart.destroy();
      currentType = type;
      currentParentCat = null;
      // Snapshot breakdown dataset for stable Back behavior
      try { lastBreakdownData = deepClone(data); lastBreakdownType = type; } catch { lastBreakdownData = data; lastBreakdownType = type; }
      let aggData = {};
      for (const k in data) {
        if (!k.includes('::')) aggData[k] = data[k];
      }
      const total = Object.values(aggData).reduce((a, b) => a + b, 0);
      let keys = Object.keys(aggData);
      let labels = keys.map(cat => (mapping[cat] && mapping[cat].shortName) ? mapping[cat].shortName : cat);
      chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: Object.values(aggData),
            backgroundColor: keys.map((_, i) => COLORS[i % COLORS.length]),
            cutout: '56%'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: false },
            legend: { display: false },
            datalabels: {
              color: '#222',
              backgroundColor: 'rgba(255,255,255,0.85)',
              borderColor: '#cbd5e1',
              borderWidth: 1,
              borderRadius: 6,
              padding: 2,
              font: (ctx) => {
                const data = ctx.dataset.data;
                const value = data[ctx.dataIndex];
                const total = data.reduce((a,b)=>a+b,0);
                const pct = value / total;
                return { weight: 'bold', size: Math.round(11 + pct * 5) };
              },
              formatter: function(value, context) {
                const percent = total ? ((value / total) * 100).toFixed(1) : 0;
                const label = labels[context.dataIndex];
                return `${label}\n${percent}%`;
              },
              anchor: 'center',
              align: 'center',
              offset: 0,
              display: (ctx) => {
                const data = ctx.dataset.data;
                const value = data[ctx.dataIndex];
                const total = data.reduce((a,b)=>a+b,0);
                const pct = (value / total) * 100;
                return pct >= 2; // hide extremely small slices
              },
              clip: false,
              clamp: true
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.parsed;
                  const percent = total ? ((value / total) * 100).toFixed(1) : 0;
                  const key = keys[context.dataIndex]; // full category name
                  return `${key}: â‚¹${formatINR(value)} (${percent}%)`;
                }
              }
            },
            centerText: {
              lines: [title],
              font: '700 15px Segoe UI',
              color: '#2563eb'
            }
          },
          onClick: (e, elements) => {
            if (elements.length) {
              const idx = elements[0].index;
              const catKey = keys[idx];
              const hasSub = Object.keys(data || {}).some(k => k.startsWith(catKey + '::'));
              if (hasSub) {
                drillStack.push({ view: 'breakdown', type });
                showSubCategoryBreakdown(data, catKey, type);
              } else {
                // No subcategories â€” open all entries for this main category
                showEntriesForCategory(type, catKey, false);
              }
            }
          }
        },
        plugins: [ChartDataLabels, CenterTextPlugin]
      });
      // Show summary
      document.getElementById('summary').innerHTML = `<b>Total ${type === 'expense' ? 'Expense' : 'Income'}:</b> â‚¹${formatINR(total)}`;
      // Show legend
      const legend = keys.map((cat, i) => {
        const value = aggData[cat];
        const percent = total ? ((value / total) * 100).toFixed(1) : 0;
        return `<li class=\"legend-item\" data-type=\"${type}\" data-key=\"${cat}\" style=\"cursor:pointer;\" title=\"Tap to view entries\"><span class=\"category-color\" style=\"background:${COLORS[i % COLORS.length]}\"></span> <b>${cat}</b>: â‚¹${formatINR(value)} (${percent}%)</li>`;
      }).join('');
      document.getElementById('categoryList').innerHTML = `<ul>${legend}</ul>`;
      document.getElementById('subchart-section').style.display = 'none';
      document.getElementById('entries-section').style.display = 'none';
      inSubChart = false;
      document.getElementById('drillback').style.display = 'inline';
      document.getElementById('categoryEntriesBtn').style.display = 'none';
    }

    // Show subcategory breakdown for a main category
    function showSubCategoryBreakdown(data, parentCat, type) {
      let subData = {};
      for (const k in data) {
        if (k.startsWith(parentCat + '::')) {
          subData[k.replace(parentCat + '::', '')] = data[k];
        }
      }
      const total = Object.values(subData).reduce((a, b) => a + b, 0);
      if (Object.keys(subData).length === 0) {
        document.getElementById('subchart-section').style.display = 'none';
        return;
      }
      // Replace the main pie with subcategory breakdown
      const ctx = document.getElementById('pieChart').getContext('2d');
      if (chart) chart.destroy();
      currentParentCat = parentCat;
      const subKeys = Object.keys(subData);
      const subLabels = subKeys.map(cat => (mapping[parentCat] && mapping[parentCat].subcategories) ? (mapping[parentCat].subcategories.find(s => s.name === cat)?.shortName || cat) : cat);
      chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: subLabels,
          datasets: [{
            data: Object.values(subData),
            backgroundColor: subKeys.map((_, i) => COLORS[i % COLORS.length]),
            cutout: '54%'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: false },
            legend: { display: false },
            datalabels: {
              color: '#222',
              backgroundColor: 'rgba(255,255,255,0.85)',
              borderColor: '#cbd5e1',
              borderWidth: 1,
              borderRadius: 6,
              padding: 2,
              font: (ctx) => {
                const data = ctx.dataset.data;
                const value = data[ctx.dataIndex];
                const total = data.reduce((a,b)=>a+b,0);
                const pct = value / total;
                return { weight: 'bold', size: Math.round(11 + pct * 5) };
              },
              formatter: function(value, context) {
                const percent = total ? ((value / total) * 100).toFixed(1) : 0;
                const label = subLabels[context.dataIndex];
                return `${label}\n${percent}%`;
              },
              anchor: 'center',
              align: 'center',
              offset: 0,
              display: (ctx) => {
                const data = ctx.dataset.data;
                const value = data[ctx.dataIndex];
                const total = data.reduce((a,b)=>a+b,0);
                const pct = (value / total) * 100;
                return pct >= 2;
              },
              clip: false,
              clamp: true
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.parsed;
                  const percent = total ? ((value / total) * 100).toFixed(1) : 0;
                  const key = subKeys[context.dataIndex];
                  let fullName = key;
                  if (mapping[parentCat] && Array.isArray(mapping[parentCat].subcategories)) {
                    const sub = mapping[parentCat].subcategories.find(s => s.name === key);
                    if (sub) fullName = sub.name;
                  }
                  return `${fullName}: â‚¹${formatINR(value)} (${percent}%)`;
                }
              }
            },
            centerText: {
              lines: [`${parentCat} Breakdown`],
              font: '700 15px Segoe UI',
              color: '#2563eb'
            }
          }
          ,
          onClick: (e, elements) => {
            if (elements.length) {
              const idx = elements[0].index;
              const subKey = subKeys[idx];
              showEntriesForSubcategory(type, parentCat, subKey, false);
            }
          }
        },
        plugins: [ChartDataLabels, CenterTextPlugin]
      });
      // Update legend and summary
      const legend = subKeys.map((cat, i) => {
        const value = subData[cat];
        const percent = total ? ((value / total) * 100).toFixed(1) : 0;
        return `<li class=\"legend-item\" data-type=\"${type}\" data-parent=\"${parentCat}\" data-key=\"${cat}\" style=\"cursor:pointer;\" title=\"Tap to view entries\"><span class=\"category-color\" style=\"background:${COLORS[i % COLORS.length]}\"></span> <b>${cat}</b>: â‚¹${formatINR(value)} (${percent}%)</li>`;
      }).join('');
      document.getElementById('categoryList').innerHTML = `<ul>${legend}</ul>`;
      document.getElementById('summary').innerHTML = `<b>Total ${type === 'expense' ? 'Expense' : 'Income'} (${parentCat}):</b> â‚¹${formatINR(total)}`;
      // Hide secondary subchart UI (not needed when using main pie for drilldown)
      document.getElementById('subchart-section').style.display = 'none';
      document.getElementById('entries-section').style.display = 'none';
      inSubChart = true;
      document.getElementById('drillback').style.display = 'inline';
      document.getElementById('categoryEntriesBtn').style.display = 'inline';
    }

    // Render separate Transfers donut (outside expense/income)
    function showTransfersChart(data) {
      try {
        const hasItems = data && Object.keys(data || {}).some(k => !k.includes('::'));
        if (!hasItems) {
          document.getElementById('transfers-section').style.display = 'none';
          return;
        }
        lastTransfersData = data;
        transferParentCat = null;
        const ctx = document.getElementById('transfersPieChart').getContext('2d');
        if (window.transfersChart) window.transfersChart.destroy();
        let tAgg = {};
        for (const k in data) {
          if (!k.includes('::')) tAgg[k] = data[k];
        }
        const total = Object.values(tAgg).reduce((a, b) => a + b, 0);
        const keys = Object.keys(tAgg);
        const labels = keys.map(cat => (mapping[cat] && mapping[cat].shortName) ? mapping[cat].shortName : cat);
        window.transfersChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: labels,
            datasets: [{
              data: Object.values(tAgg),
              backgroundColor: keys.map((_, i) => COLORS[i % COLORS.length]),
              cutout: '56%'
            }]
          },
          options: {
            responsive: true,
            plugins: {
              title: { display: false },
              legend: { display: false },
              datalabels: {
                color: '#222',
                backgroundColor: 'rgba(255,255,255,0.85)',
                borderColor: '#cbd5e1',
                borderWidth: 1,
                borderRadius: 6,
                padding: 2,
                font: (ctx) => {
                  const data = ctx.dataset.data;
                  const value = data[ctx.dataIndex];
                  const total = data.reduce((a,b)=>a+b,0);
                  const pct = value / total;
                  return { weight: 'bold', size: Math.round(11 + pct * 5) };
                },
                formatter: function(value, context) {
                  const percent = total ? ((value / total) * 100).toFixed(1) : 0;
                  const label = labels[context.dataIndex];
                  return `${label}\n${percent}%`;
                },
                anchor: 'center',
                align: 'center',
                offset: 0,
                display: (ctx) => {
                  const data = ctx.dataset.data;
                  const value = data[ctx.dataIndex];
                  const total = data.reduce((a,b)=>a+b,0);
                  const pct = (value / total) * 100;
                  return pct >= 2;
                },
                clip: false,
                clamp: true
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const value = context.parsed;
                    const percent = total ? ((value / total) * 100).toFixed(1) : 0;
                    const key = keys[context.dataIndex];
                    const base = transfersOverlay || chartData || {};
                    const out = (base && base.transfersOut) ? (base.transfersOut[key] || 0) : 0;
                    const inc = (base && base.transfersIn) ? (base.transfersIn[key] || 0) : 0;
                      return `${key}: â‚¹${formatINR(value)} (${percent}%)\nOutgoing: â‚¹${formatINR(out)}\nIncoming: â‚¹${formatINR(inc)}`;
                  }
                }
              },
              centerText: {
                lines: ['Transfers'],
                font: '700 15px Segoe UI',
                color: '#2563eb'
              }
            },
            onClick: (e, elements) => {
              if (elements.length) {
                const idx = elements[0].index;
                const catKey = keys[idx];
                const hasSub = Object.keys(data || {}).some(k => k.startsWith(catKey + '::'));
                if (hasSub) {
                  transferParentCat = catKey;
                  showTransfersSubBreakdown(data, catKey);
                } else {
                  // No subcategories â€” open all transfer entries for this main category
                  showEntriesForCategory('transfer', catKey, true);
                }
              }
            }
          },
           plugins: [ChartDataLabels, CenterTextPlugin]
        });
        // Show legend and summary
        const base = transfersOverlay || chartData || {};
        const legend = keys.map((cat, i) => {
          const value = tAgg[cat];
          const percent = total ? ((value / total) * 100).toFixed(1) : 0;
          const out = (base && base.transfersOut) ? (base.transfersOut[cat] || 0) : 0;
          const inc = (base && base.transfersIn) ? (base.transfersIn[cat] || 0) : 0;
          return `<li class=\"legend-item\" data-type=\"transfer\" data-key=\"${cat}\" style=\"cursor:pointer;\" title=\"Tap to view entries\"><span class=\"category-color\" style=\"background:${COLORS[i % COLORS.length]}\"></span> <b>${cat}</b>: â‚¹${formatINR(value)} (${percent}%) â€” Out: â‚¹${formatINR(out)} | In: â‚¹${formatINR(inc)}</li>`;
        }).join('');
        document.getElementById('transfersCategoryList').innerHTML = `<ul>${legend}</ul>`;
        const outSum = (base && base.summary) ? (base.summary.transfersOut || 0) : 0;
        const inSum = (base && base.summary) ? (base.summary.transfersIn || 0) : 0;
        document.getElementById('transfersSummary').innerHTML = `<b>Total Transfers:</b> â‚¹${formatINR(total)} &nbsp; <b>Outgoing:</b> â‚¹${formatINR(outSum)} &nbsp; <b>Incoming:</b> â‚¹${formatINR(inSum)}`;
        document.getElementById('transfers-section').style.display = 'block';
        document.getElementById('transfersBack').style.display = 'none';
        document.getElementById('transfersCategoryEntriesBtn').style.display = 'none';
      } catch (e) {
        console.error('Failed to render transfers chart:', e);
        document.getElementById('transfers-section').style.display = 'none';
      }
    }

    // Render separate Investments donut (outside expense/income)
    function showInvestmentsChart(data) {
      try {
        const hasItems = data && Object.keys(data || {}).some(k => !k.includes('::'));
        if (!hasItems) { document.getElementById('investments-section').style.display = 'none'; return; }
        lastInvestmentsData = data;
        investmentParentCat = null;
        const ctx = document.getElementById('investmentsPieChart').getContext('2d');
        if (window.investmentsChart) window.investmentsChart.destroy();
        let iAgg = {};
        for (const k in data) { if (!k.includes('::')) iAgg[k] = data[k]; }
        const total = Object.values(iAgg).reduce((a,b)=>a+b,0);
        const keys = Object.keys(iAgg);
        const labels = keys.map(cat => (mapping[cat] && mapping[cat].shortName) ? mapping[cat].shortName : cat);
        window.investmentsChart = new Chart(ctx, {
          type: 'doughnut',
          data: { labels, datasets: [{ data: Object.values(iAgg), backgroundColor: keys.map((_,i)=>COLORS[i%COLORS.length]), cutout: '56%' }] },
          options: {
            responsive: true,
            plugins: {
              title: { display: false }, legend: { display: false },
              datalabels: {
                color:'#222', backgroundColor:'rgba(255,255,255,0.85)', borderColor:'#cbd5e1', borderWidth:1, borderRadius:6, padding:2,
                font:(ctx)=>{ const data=ctx.dataset.data; const value=data[ctx.dataIndex]; const tot=data.reduce((a,b)=>a+b,0); const pct=value/tot; return { weight:'bold', size: Math.round(11 + pct * 5) }; },
                formatter:(value,context)=>{ const percent = total ? ((value/total)*100).toFixed(1) : 0; const label = labels[context.dataIndex]; return `${label}\n${percent}%`; },
                anchor:'center', align:'center', offset:0, display:(ctx)=>{ const data=ctx.dataset.data; const value=data[ctx.dataIndex]; const tot=data.reduce((a,b)=>a+b,0); const pct=(value/tot)*100; return pct>=2; }, clip:false, clamp:true
              },
              tooltip: { callbacks: { label: function(context){ const value=context.parsed; const percent = total ? ((value/total)*100).toFixed(1):0; const key = keys[context.dataIndex]; return `${key}: â‚¹${formatINR(value)} (${percent}%)`; } } },
              centerText: { lines: ['Investments'], font: '700 15px Segoe UI', color:'#7c3aed' }
            },
            onClick: (e,elements)=>{
              if (elements.length){
                const idx = elements[0].index; const catKey = keys[idx];
                const hasSub = Object.keys(data || {}).some(k => k.startsWith(catKey + '::'));
                if (hasSub) { investmentParentCat = catKey; showInvestmentsSubBreakdown(data, catKey); }
                else { showEntriesForCategory('investment', catKey, false); }
              }
            }
          },
          plugins: [ChartDataLabels, CenterTextPlugin]
        });
        const legend = keys.map((cat,i)=>{ const value=iAgg[cat]; const percent = total ? ((value/total)*100).toFixed(1):0; return `<li class=\"legend-item\" data-type=\"investment\" data-key=\"${cat}\" style=\"cursor:pointer;\" title=\"Tap to view entries\"><span class=\"category-color\" style=\"background:${COLORS[i%COLORS.length]}\"></span> <b>${cat}</b>: â‚¹${formatINR(value)} (${percent}%)</li>`; }).join('');
        document.getElementById('investmentsCategoryList').innerHTML = `<ul>${legend}</ul>`;
        document.getElementById('investmentsSummary').innerHTML = `<b>Total Investments:</b> â‚¹${formatINR(total)}`;
        document.getElementById('investments-section').style.display = 'block';
        document.getElementById('investmentsBack').style.display = 'none';
        document.getElementById('investmentsCategoryEntriesBtn').style.display = 'none';
      } catch (e) {
        console.error('Failed to render investments chart:', e);
        document.getElementById('investments-section').style.display = 'none';
      }
    }

    function showInvestmentsSubBreakdown(data, parentCat) {
      let subData = {};
      for (const k in data) { if (k.startsWith(parentCat + '::')) { subData[k.replace(parentCat + '::','')] = data[k]; } }
      const total = Object.values(subData).reduce((a,b)=>a+b,0);
      if (Object.keys(subData).length === 0) return;
      const ctx = document.getElementById('investmentsPieChart').getContext('2d');
      if (window.investmentsChart) window.investmentsChart.destroy();
      const subKeys = Object.keys(subData);
      const subLabels = subKeys.map(cat => (mapping[parentCat] && mapping[parentCat].subcategories) ? (mapping[parentCat].subcategories.find(s => s.name === cat)?.shortName || cat) : cat);
      window.investmentsChart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: subLabels, datasets: [{ data: Object.values(subData), backgroundColor: subKeys.map((_,i)=>COLORS[i%COLORS.length]), cutout: '54%' }] },
        options: {
          responsive:true,
          plugins: {
            title:{ display:false }, legend:{ display:false },
            datalabels: { color:'#222', backgroundColor:'rgba(255,255,255,0.85)', borderColor:'#cbd5e1', borderWidth:1, borderRadius:6, padding:2,
              font:(ctx)=>{ const data=ctx.dataset.data; const value=data[ctx.dataIndex]; const tot=data.reduce((a,b)=>a+b,0); const pct=value/tot; return { weight:'bold', size: Math.round(11 + pct * 5) }; },
              formatter:(value,context)=>{ const percent = total ? ((value/total)*100).toFixed(1):0; const label = subLabels[context.dataIndex]; return `${label}\n${percent}%`; },
              anchor:'center', align:'center', offset:0, display:(ctx)=>{ const data=ctx.dataset.data; const value=data[ctx.dataIndex]; const tot=data.reduce((a,b)=>a+b,0); const pct=(value/tot)*100; return pct>=2; }, clip:false, clamp:true },
            tooltip:{ callbacks:{ label:function(context){ const value=context.parsed; const percent = total ? ((value/total)*100).toFixed(1):0; const key=subKeys[context.dataIndex]; let fullName=key; if (mapping[parentCat] && Array.isArray(mapping[parentCat].subcategories)){ const sub = mapping[parentCat].subcategories.find(s=>s.name===key); if (sub) fullName=sub.name; } return `${fullName}: â‚¹${formatINR(value)} (${percent}%)`; } } },
            centerText:{ lines:[`${parentCat} Investments`], font:'700 15px Segoe UI', color:'#7c3aed' }
          },
          onClick:(e,elements)=>{ if (elements.length){ const idx=elements[0].index; const subKey=subKeys[idx]; showEntriesForSubcategory('investment', parentCat, subKey, false); } }
        },
        plugins: [ChartDataLabels, CenterTextPlugin]
      });
      const legend = subKeys.map((cat,i)=>{ const value=subData[cat]; const percent = total ? ((value/total)*100).toFixed(1):0; return `<li class=\"legend-item\" data-type=\"investment\" data-parent=\"${parentCat}\" data-key=\"${cat}\" style=\"cursor:pointer;\" title=\"Tap to view entries\"><span class=\"category-color\" style=\"background:${COLORS[i%COLORS.length]}\"></span> <b>${cat}</b>: â‚¹${formatINR(value)} (${percent}%)</li>`; }).join('');
      document.getElementById('investmentsCategoryList').innerHTML = `<ul>${legend}</ul>`;
      document.getElementById('investmentsSummary').innerHTML = `<b>Total ${parentCat} Investments:</b> â‚¹${formatINR(total)}`;
      document.getElementById('investmentsBack').style.display = 'inline';
      document.getElementById('investmentsCategoryEntriesBtn').style.display = 'inline';
    }

    // Multi-member Investments: render individual donuts per selected member
    function showInvestmentsChartsMulti(views) {
      try {
        const sec = document.getElementById('investments-section'); if (!sec) return;
        const titleEl = document.getElementById('investments-title'); const canvasEl = document.getElementById('investmentsPieChart');
        const listEl = document.getElementById('investmentsCategoryList'); const sumEl = document.getElementById('investmentsSummary');
        const backEl = document.getElementById('investmentsBack'); const entriesBtnEl = document.getElementById('investmentsCategoryEntriesBtn');
        if (titleEl) { titleEl.textContent = 'Investments Breakdown (Per Member)'; titleEl.style.display = 'block'; }
        if (canvasEl) canvasEl.parentElement && (canvasEl.parentElement.style.display = 'none');
        if (listEl) listEl.style.display = 'none'; if (sumEl) sumEl.style.display = 'none'; if (backEl) backEl.style.display = 'none'; if (entriesBtnEl) entriesBtnEl.style.display = 'none';
        let cont = document.getElementById('multiInvestmentsContainer'); if (!cont) { cont = document.createElement('div'); cont.id='multiInvestmentsContainer'; sec.appendChild(cont); }
        cont.style.display = 'block'; cont.innerHTML = '';
        const grid = document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(auto-fit, minmax(300px, 1fr))'; grid.style.gap='1em'; cont.appendChild(grid);
        window.multiInvestmentsCharts = [];
        let grandTotal = 0;
        views.forEach(v => {
          const card = document.createElement('div'); card.style.background='#ffffff'; card.style.border='1px solid #e5e7eb'; card.style.borderRadius='12px'; card.style.boxShadow='0 2px 12px #8b5cf611'; card.style.padding='0.8em';
          const hdr = document.createElement('div'); hdr.style.display='flex'; hdr.style.justifyContent='space-between'; hdr.style.alignItems='center'; hdr.style.marginBottom='0.6em';
          const nameEl = document.createElement('div'); nameEl.style.fontWeight='700'; nameEl.style.color='#111827'; nameEl.textContent = v.name || v.id;
          const sumEl2 = document.createElement('div'); sumEl2.style.color='#7c3aed'; sumEl2.style.fontWeight='700';
          const total = Object.keys(v.agg.investments || {}).filter(k=>!k.includes('::')).map(k=>v.agg.investments[k]).reduce((a,b)=>a+b,0);
          sumEl2.textContent = `Total: â‚¹${formatINR(total)}`;
          hdr.appendChild(nameEl); hdr.appendChild(sumEl2); card.appendChild(hdr);
          grandTotal += total;
          const canvas = document.createElement('canvas'); canvas.width=400; canvas.height=400; card.appendChild(canvas); grid.appendChild(card);
          let iAgg = {}; for (const k in v.agg.investments || {}) { if (!k.includes('::')) iAgg[k] = v.agg.investments[k]; }
          const keys = Object.keys(iAgg); const labels = keys.map(cat => (mapping[cat] && mapping[cat].shortName) ? mapping[cat].shortName : cat);
          const localCtx = canvas.getContext('2d'); const totalVal = Object.values(iAgg).reduce((a,b)=>a+b,0);
          const chartInst = new Chart(localCtx, { type:'doughnut', data:{ labels, datasets:[{ data:Object.values(iAgg), backgroundColor: keys.map((_,i)=>COLORS[i%COLORS.length]), cutout:'56%' }] }, options:{ responsive:true, plugins:{ title:{display:false}, legend:{display:false}, datalabels:{ color:'#222', backgroundColor:'rgba(255,255,255,0.85)', borderColor:'#cbd5e1', borderWidth:1, borderRadius:6, padding:2, font:(ctx)=>{ const data=ctx.dataset.data; const value=data[ctx.dataIndex]; const tot=data.reduce((a,b)=>a+b,0); const pct=value/tot; return { weight:'bold', size: Math.round(11 + pct * 5) }; }, formatter:(value,context)=>{ const percent = totalVal ? ((value/totalVal)*100).toFixed(1) : 0; const label = labels[context.dataIndex]; return `${label}\n${percent}%`; }, anchor:'center', align:'center', display:(ctx)=>{ const data=ctx.dataset.data; const value=data[ctx.dataIndex]; const tot=data.reduce((a,b)=>a+b,0); const pct=(value/tot)*100; return pct>=2; }, clip:false, clamp:true }, centerText:{ lines:['Investments'], font:'700 15px Segoe UI', color:'#7c3aed' } }, onClick:(e,elements)=>{ if (elements.length){ const idx=elements[0].index; const catKey=keys[idx]; const hasSub = Object.keys(v.agg.investments || {}).some(k => k.startsWith(catKey + '::')); memberInvestmentsEntries = v.matchedEntries; if (hasSub) { investmentParentCat = catKey; showInvestmentsSubBreakdown(v.agg.investments, catKey); } else { showEntriesForCategory('investment', catKey, false); } } } }, plugins:[ChartDataLabels, CenterTextPlugin] });
          window.multiInvestmentsCharts.push(chartInst);
          const legend = document.createElement('div'); legend.className='category-list'; legend.style.marginTop='0.6em'; const ul = document.createElement('ul'); let idx=0; keys.forEach(k => { const value=iAgg[k] || 0; const percent = totalVal ? ((value/totalVal)*100).toFixed(1) : 0; const li=document.createElement('li'); const color=COLORS[idx%COLORS.length]; idx++; li.innerHTML = `<span class="category-color" style="background:${color}"></span> <b>${k}</b>: â‚¹${formatINR(value)} (${percent}%)`; ul.appendChild(li); }); legend.appendChild(ul); card.appendChild(legend);
        });
        const footer = document.createElement('div'); footer.className='summary'; footer.innerHTML = `<b>Total Investments:</b> â‚¹${formatINR(grandTotal)}`; cont.appendChild(footer); sec.style.display='block';
      } catch (e) {
        console.error('Failed to render multi investments charts:', e);
        document.getElementById('investments-section').style.display = 'none';
      }
    }

    // Transfers subcategory drilldown
    function showTransfersSubBreakdown(data, parentCat) {
      let subData = {};
      for (const k in data) {
        if (k.startsWith(parentCat + '::')) {
          subData[k.replace(parentCat + '::', '')] = data[k];
        }
      }
      const total = Object.values(subData).reduce((a, b) => a + b, 0);
      if (Object.keys(subData).length === 0) {
        // No subcategories, keep main transfers view
        return;
      }
      const ctx = document.getElementById('transfersPieChart').getContext('2d');
      if (window.transfersChart) window.transfersChart.destroy();
      const subKeys = Object.keys(subData);
      const subLabels = subKeys.map(cat => (mapping[parentCat] && mapping[parentCat].subcategories) ? (mapping[parentCat].subcategories.find(s => s.name === cat)?.shortName || cat) : cat);
      window.transfersChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: subLabels,
          datasets: [{
            data: Object.values(subData),
            backgroundColor: subKeys.map((_, i) => COLORS[i % COLORS.length]),
            cutout: '54%'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: false },
            legend: { display: false },
            datalabels: {
              color: '#222',
              backgroundColor: 'rgba(255,255,255,0.85)',
              borderColor: '#cbd5e1',
              borderWidth: 1,
              borderRadius: 6,
              padding: 2,
              font: (ctx) => {
                const data = ctx.dataset.data;
                const value = data[ctx.dataIndex];
                const total = data.reduce((a,b)=>a+b,0);
                const pct = value / total;
                return { weight: 'bold', size: Math.round(11 + pct * 5) };
              },
              formatter: function(value, context) {
                const percent = total ? ((value / total) * 100).toFixed(1) : 0;
                const label = subLabels[context.dataIndex];
                return `${label}\n${percent}%`;
              },
              anchor: 'center',
              align: 'center',
              offset: 0,
              display: (ctx) => {
                const data = ctx.dataset.data;
                const value = data[ctx.dataIndex];
                const total = data.reduce((a,b)=>a+b,0);
                const pct = (value / total) * 100;
                return pct >= 2;
              },
              clip: false,
              clamp: true
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.parsed;
                  const percent = total ? ((value / total) * 100).toFixed(1) : 0;
                  const key = subKeys[context.dataIndex];
                  let fullName = key;
                  if (mapping[parentCat] && Array.isArray(mapping[parentCat].subcategories)) {
                    const sub = mapping[parentCat].subcategories.find(s => s.name === key);
                    if (sub) fullName = sub.name;
                  }
                  const base = transfersOverlay || chartData || {};
                  const out = (base && base.transfersOut) ? (base.transfersOut[parentCat + '::' + key] || 0) : 0;
                  const inc = (base && base.transfersIn) ? (base.transfersIn[parentCat + '::' + key] || 0) : 0;
                  return `${fullName}: â‚¹${formatINR(value)} (${percent}%)\nOutgoing: â‚¹${formatINR(out)}\nIncoming: â‚¹${formatINR(inc)}`;
                }
              }
            },
            centerText: {
              lines: [`${parentCat} Transfers`],
              font: '700 15px Segoe UI',
              color: '#2563eb'
            }
          },
          onClick: (e, elements) => {
            if (elements.length) {
              const idx = elements[0].index;
              const subKey = subKeys[idx];
              showEntriesForSubcategory('transfer', parentCat, subKey, true);
            }
          }
        },
        plugins: [ChartDataLabels, CenterTextPlugin]
      });
      // Update legend and summary
      const legend = subKeys.map((cat, i) => {
        const value = subData[cat];
        const percent = total ? ((value / total) * 100).toFixed(1) : 0;
        const base = transfersOverlay || chartData || {};
        const out = (base && base.transfersOut) ? (base.transfersOut[parentCat + '::' + cat] || 0) : 0;
        const inc = (base && base.transfersIn) ? (base.transfersIn[parentCat + '::' + cat] || 0) : 0;
        return `<li class=\"legend-item\" data-type=\"transfer\" data-parent=\"${parentCat}\" data-key=\"${cat}\" style=\"cursor:pointer;\" title=\"Tap to view entries\"><span class=\"category-color\" style=\"background:${COLORS[i % COLORS.length]}\"></span> <b>${cat}</b>: â‚¹${formatINR(value)} (${percent}%) â€” Out: â‚¹${formatINR(out)} | In: â‚¹${formatINR(inc)}</li>`;
      }).join('');
      document.getElementById('transfersCategoryList').innerHTML = `<ul>${legend}</ul>`;
      const base = transfersOverlay || chartData || {};
      const outSum = subKeys.reduce((acc, k) => acc + ((base && base.transfersOut) ? (base.transfersOut[parentCat + '::' + k] || 0) : 0), 0);
      const inSum = subKeys.reduce((acc, k) => acc + ((base && base.transfersIn) ? (base.transfersIn[parentCat + '::' + k] || 0) : 0), 0);
      document.getElementById('transfersSummary').innerHTML = `<b>Total ${parentCat} Transfers:</b> â‚¹${formatINR(total)} &nbsp; <b>Outgoing:</b> â‚¹${formatINR(outSum)} &nbsp; <b>Incoming:</b> â‚¹${formatINR(inSum)}`;
      document.getElementById('transfersBack').style.display = 'inline';
      document.getElementById('transfersCategoryEntriesBtn').style.display = 'inline';
    }

    // Multi-member Transfers: render individual donuts per selected member
    function showTransfersChartsMulti(views) {
      try {
        const sec = document.getElementById('transfers-section');
        if (!sec) return;
        // Prepare existing single-member elements
        const titleEl = document.getElementById('transfers-title');
        const canvasEl = document.getElementById('transfersPieChart');
        const listEl = document.getElementById('transfersCategoryList');
        const sumEl = document.getElementById('transfersSummary');
        const backEl = document.getElementById('transfersBack');
        const entriesBtnEl = document.getElementById('transfersCategoryEntriesBtn');
        if (titleEl) { titleEl.textContent = 'Transfers Breakdown (Per Member)'; titleEl.style.display = 'block'; }
        if (canvasEl) canvasEl.parentElement && (canvasEl.parentElement.style.display = 'none');
        if (listEl) listEl.style.display = 'none';
        if (sumEl) sumEl.style.display = 'none';
        if (backEl) backEl.style.display = 'none';
        if (entriesBtnEl) entriesBtnEl.style.display = 'none';
        // Create or reuse container for multi-member charts
        let cont = document.getElementById('multiTransfersContainer');
        if (!cont) {
          cont = document.createElement('div');
          cont.id = 'multiTransfersContainer';
          sec.appendChild(cont);
        }
        cont.style.display = 'block';
        cont.innerHTML = '';
        const grid = document.createElement('div');
        grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(auto-fit, minmax(300px, 1fr))'; grid.style.gap='1em';
        cont.appendChild(grid);
        window.multiTransfersCharts = [];
        let grandTotal = 0, grandOut = 0, grandIn = 0;
        views.forEach(v => {
          const card = document.createElement('div');
          card.style.background='#ffffff'; card.style.border='1px solid #e5e7eb'; card.style.borderRadius='12px'; card.style.boxShadow='0 2px 12px #4f8cff11'; card.style.padding='0.8em';
          const hdr = document.createElement('div'); hdr.style.display='flex'; hdr.style.justifyContent='space-between'; hdr.style.alignItems='center'; hdr.style.marginBottom='0.6em';
          const nameEl = document.createElement('div'); nameEl.style.fontWeight='700'; nameEl.style.color='#111827'; nameEl.textContent = v.name || v.id;
          const sumEl = document.createElement('div'); sumEl.style.color='#2563eb'; sumEl.style.fontWeight='700';
          const total = Object.keys(v.agg.transfers || {}).filter(k=>!k.includes('::')).map(k=>v.agg.transfers[k]).reduce((a,b)=>a+b,0);
          const outSum = v.agg.summary.transfersOut || 0; const inSum = v.agg.summary.transfersIn || 0;
          sumEl.textContent = `Total: â‚¹${formatINR(total)} â€” Out: â‚¹${formatINR(outSum)} | In: â‚¹${formatINR(inSum)}`;
          hdr.appendChild(nameEl); hdr.appendChild(sumEl); card.appendChild(hdr);
          grandTotal += total; grandOut += outSum; grandIn += inSum;
          const canvas = document.createElement('canvas');
          canvas.width = 400; canvas.height = 400; card.appendChild(canvas);
          grid.appendChild(card);
          // Build chart data: main transfer categories only
          let tAgg = {};
          for (const k in v.agg.transfers || {}) { if (!k.includes('::')) tAgg[k] = v.agg.transfers[k]; }
          const keys = Object.keys(tAgg);
          const labels = keys.map(cat => (mapping[cat] && mapping[cat].shortName) ? mapping[cat].shortName : cat);
          const localCtx = canvas.getContext('2d');
          const totalVal = Object.values(tAgg).reduce((a,b)=>a+b,0);
          const chartInst = new Chart(localCtx, {
            type: 'doughnut',
            data: { labels, datasets: [{ data: Object.values(tAgg), backgroundColor: keys.map((_,i)=>COLORS[i%COLORS.length]), cutout: '56%' }] },
            options: {
              responsive: true,
              plugins: {
                title: { display: false }, legend: { display: false },
                datalabels: {
                  color:'#222', backgroundColor:'rgba(255,255,255,0.85)', borderColor:'#cbd5e1', borderWidth:1, borderRadius:6, padding:2,
                  font:(ctx)=>{ const data=ctx.dataset.data; const value=data[ctx.dataIndex]; const tot=data.reduce((a,b)=>a+b,0); const pct=value/tot; return { weight:'bold', size: Math.round(11 + pct * 5) }; },
                  formatter:(value,context)=>{ const percent = totalVal ? ((value/totalVal)*100).toFixed(1) : 0; const label = labels[context.dataIndex]; return `${label}\n${percent}%`; },
                  anchor:'center', align:'center', display:(ctx)=>{ const data=ctx.dataset.data; const value=data[ctx.dataIndex]; const tot=data.reduce((a,b)=>a+b,0); const pct=(value/tot)*100; return pct>=2; }, clip:false, clamp:true
                },
                centerText: { lines: ['Transfers'], font: '700 15px Segoe UI', color:'#2563eb' }
              },
              onClick: (e,elements)=>{
                if (elements.length){
                  const idx = elements[0].index; const catKey = keys[idx];
                  // Swap source entries to this member and open entries
                  memberTransfersEntries = v.matchedEntries;
                  const hasSub = Object.keys(v.agg.transfers || {}).some(k => k.startsWith(catKey + '::'));
                  if (hasSub) { transferParentCat = catKey; showTransfersSubBreakdown(v.agg.transfers, catKey); }
                  else { showEntriesForCategory('transfer', catKey, true); }
                }
              }
            },
            plugins: [ChartDataLabels, CenterTextPlugin]
          });
          window.multiTransfersCharts.push(chartInst);
          // Build per-member legend with Out/In details
          const legend = document.createElement('div'); legend.className = 'category-list'; legend.style.marginTop='0.6em';
          const ul = document.createElement('ul');
          let idx = 0;
          keys.forEach(k => {
            const value = tAgg[k] || 0;
            const percent = totalVal ? ((value / totalVal) * 100).toFixed(1) : 0;
            const out = (v.agg.transfersOut || {})[k] || 0;
            const inc = (v.agg.transfersIn || {})[k] || 0;
            const li = document.createElement('li');
            const color = COLORS[idx % COLORS.length]; idx++;
            li.innerHTML = `<span class="category-color" style="background:${color}"></span> <b>${k}</b>: â‚¹${formatINR(value)} (${percent}%) â€” Out: â‚¹${formatINR(out)} | In: â‚¹${formatINR(inc)}`;
            ul.appendChild(li);
          });
          legend.appendChild(ul);
          card.appendChild(legend);
        });
        // Overall summary footer across selected members
        const footer = document.createElement('div'); footer.className = 'summary';
        footer.innerHTML = `<b>Total Transfers:</b> â‚¹${formatINR(grandTotal)} &nbsp; <b>Outgoing:</b> â‚¹${formatINR(grandOut)} &nbsp; <b>Incoming:</b> â‚¹${formatINR(grandIn)}`;
        cont.appendChild(footer);
        sec.style.display = 'block';
      } catch (e) {
        console.error('Failed to render multi transfers charts:', e);
        document.getElementById('transfers-section').style.display = 'none';
      }
    }

    function showEntriesForSubcategory(type, parentCat, subKey, isTransfer) {
      // Filter entries from chartData.entries or overlays
      const sourceEntries = (isTransfer && memberScopeActive) ? memberTransfersEntries : (type==='investment' && memberScopeActive) ? memberInvestmentsEntries : (chartData && Array.isArray(chartData.entries) ? chartData.entries : []);
      const all = sourceEntries;
      const shouldExclude = memberScopeActive && (type === 'expense' || type === 'income') && !isTransfer && excludedEntryKeys && excludedEntryKeys.size;
      const mkKey = (e) => {
        const norm = (t) => String(t || '').trim().replace(/\s+/g, ' ').toLowerCase();
        const text = e.text || e.description || '';
        const memberPart = e && e.memberId ? String(e.memberId) : '';
        return memberPart + '|' + norm(text) + '|' + String(Number(e.amount || 0));
      };
      currentEntries = all.filter(e => {
        const mainMatch = String(e.main || '').toLowerCase() === String(parentCat || '').toLowerCase();
        // Treat missing/empty sub as 'Uncategorized' so the bar labeled 'Uncategorized' works
        const eSubNorm = (e.sub === undefined || e.sub === null || String(e.sub).trim() === '') ? 'Uncategorized' : String(e.sub);
        const subMatch = eSubNorm.toLowerCase() === String(subKey || '').toLowerCase();
        const typeMatch = isTransfer ? (e.type === 'transfer') : (e.type === type);
        const dateMatch = matchesDateFilter(e, entriesDateFilter);
        if (!(typeMatch && mainMatch && subMatch && dateMatch)) return false;
        if (!matchesYearSelection(e)) return false;
        if (shouldExclude && excludedEntryKeys.has(mkKey(e))) return false;
        return true;
      });
      entriesPage = 1;
      const titleType = isTransfer ? 'Transfers' : (type === 'investment' ? 'Investments' : (type === 'expense' ? 'Expense' : 'Income'));
      document.getElementById('entries-title').textContent = `${titleType} Entries â€” ${parentCat} / ${subKey}`;
      document.getElementById('entries-section').style.display = 'block';
      renderEntriesPage();
    }

    function showEntriesForCategory(type, parentCat, isTransfer) {
      const sourceEntries = (isTransfer && memberScopeActive) ? memberTransfersEntries : (type==='investment' && memberScopeActive) ? memberInvestmentsEntries : (chartData && Array.isArray(chartData.entries) ? chartData.entries : []);
      const all = sourceEntries;
      const p = String(parentCat || '').toLowerCase();
      const shouldExclude = memberScopeActive && (type === 'expense' || type === 'income') && !isTransfer && excludedEntryKeys && excludedEntryKeys.size;
      const mkKey = (e) => {
        const norm = (t) => String(t || '').trim().replace(/\s+/g, ' ').toLowerCase();
        const text = e.text || e.description || '';
        const memberPart = e && e.memberId ? String(e.memberId) : '';
        return memberPart + '|' + norm(text) + '|' + String(Number(e.amount || 0));
      };
      currentEntries = all.filter(e => {
        const mainMatch = String(e.main || '').toLowerCase() === p;
        if (!mainMatch) return false;
        const typeMatch = isTransfer ? (e.type === 'transfer') : (e.type === type);
        if (!typeMatch) return false;
        if (!matchesDateFilter(e, entriesDateFilter)) return false;
        if (!matchesYearSelection(e)) return false;
        const isTaxMain = String(e.main || '').toLowerCase() === 'tax';
        // Do not let member-specific exclusions hide Tax entries; for all other
        // categories, continue to respect excludedEntryKeys.
        if (shouldExclude && !isTaxMain && excludedEntryKeys.has(mkKey(e))) return false;
        return true;
      });
      entriesPage = 1;
      const titleType = isTransfer ? 'Transfers' : (type === 'investment' ? 'Investments' : (type === 'expense' ? 'Expense' : 'Income'));
      document.getElementById('entries-title').textContent = `${titleType} Entries â€” ${parentCat}`;
      document.getElementById('entries-section').style.display = 'block';
      renderEntriesPage();
    }
    
    function renderEntriesPage() {
      const pageSizeSel = document.getElementById('entriesPageSize');
      entriesPageSize = Number(pageSizeSel.value) || 20;
      const filterText = (document.getElementById('entriesFilter').value || '').toLowerCase();
      const filtered = currentEntries.filter(e => String(e.description || '').toLowerCase().includes(filterText));
      const total = filtered.length;
      const pages = Math.max(1, Math.ceil(total / entriesPageSize));
      if (entriesPage > pages) entriesPage = pages;
      const start = (entriesPage - 1) * entriesPageSize;
      const slice = filtered.slice(start, start + entriesPageSize);

      const tbody = document.getElementById('entriesBody');
      tbody.innerHTML = slice.map(e => {
        const amt = Number(e.amount || 0);
        const dir = e.direction ? (e.direction === 'out' ? 'Outgoing' : 'Incoming') : '';
        const dt = parseToDate(e.date);
        const dateStr = dt ? dt.toLocaleDateString('en-GB', { year: 'numeric', month: 'short', day: '2-digit' }) : (e.date || '');
        return `<tr style=\"border-bottom:1px solid #e5e7eb;\"><td style=\"padding:8px;\">${dateStr}</td><td style=\"padding:8px;\">${(e.description || '').toString()}</td><td style=\"padding:8px; text-align:right;\">â‚¹${formatINR(amt)}</td><td style=\"padding:8px;\">${e.type}</td><td style=\"padding:8px;\">${dir}</td></tr>`;
      }).join('');
      document.getElementById('entriesInfo').textContent = `Showing ${start + 1}â€“${Math.min(start + entriesPageSize, total)} of ${total}`;
    }

    document.getElementById('entriesPrev').onclick = function() { if (entriesPage > 1) { entriesPage--; renderEntriesPage(); } };
    document.getElementById('entriesNext').onclick = function() { entriesPage++; renderEntriesPage(); };
    document.getElementById('entriesClose').onclick = function() { document.getElementById('entries-section').style.display = 'none'; };
    document.getElementById('entriesPageSize').onchange = renderEntriesPage;
    document.getElementById('entriesFilter').oninput = function() { entriesPage = 1; renderEntriesPage(); };
    // Delegated handlers for legend lists (click + dblclick for desktop/mobile)
    (function(){
      const catList = document.getElementById('categoryList');
      const transList = document.getElementById('transfersCategoryList');
      const invList = document.getElementById('investmentsCategoryList');
      function handleActivate(ev, isTransfer) {
        const li = ev.target && ev.target.closest && ev.target.closest('li.legend-item');
        if (!li) return;
        const type = li.getAttribute('data-type') || (isTransfer ? 'transfer' : 'expense');
        const parent = li.getAttribute('data-parent');
        const key = li.getAttribute('data-key');
        if (!key) return;
        if (parent) {
          showEntriesForSubcategory(type, parent, key, !!isTransfer);
        } else {
          showEntriesForCategory(type, key, !!isTransfer);
        }
      }
      if (catList) {
        catList.onclick = (ev) => handleActivate(ev, false);
        catList.ondblclick = (ev) => handleActivate(ev, false);
      }
      if (transList) {
        transList.onclick = (ev) => handleActivate(ev, true);
        transList.ondblclick = (ev) => handleActivate(ev, true);
      }
      if (invList) {
        invList.onclick = (ev) => handleActivate(ev, false);
        invList.ondblclick = (ev) => handleActivate(ev, false);
      }
    })();

    document.getElementById('transfersBack').onclick = function() {
      if (lastTransfersData) {
        showTransfersChart(lastTransfersData);
        document.getElementById('transfersCategoryEntriesBtn').style.display = 'none';
      }
    };
    document.getElementById('investmentsBack').onclick = function() {
      if (lastInvestmentsData) {
        showInvestmentsChart(lastInvestmentsData);
        document.getElementById('investmentsCategoryEntriesBtn').style.display = 'none';
      }
    };
    function hideTransfersUI() {
      try {
        const sec = document.getElementById('transfers-section');
        if (sec) sec.style.display = 'none';
        const list = document.getElementById('transfersCategoryList');
        const sum = document.getElementById('transfersSummary');
        const back = document.getElementById('transfersBack');
        const btn = document.getElementById('transfersCategoryEntriesBtn');
        const title = document.getElementById('transfers-title');
        const canvas = document.getElementById('transfersPieChart');
        const multi = document.getElementById('multiTransfersContainer');
        if (list) list.innerHTML = '';
        if (sum) sum.innerHTML = '';
        if (back) back.style.display = 'none';
        if (btn) btn.style.display = 'none';
        if (title) { title.textContent = 'Transfers Breakdown'; title.style.display = 'block'; }
        if (canvas && canvas.parentElement) { canvas.parentElement.style.display = 'block'; }
        if (list) list.style.display = 'block';
        if (sum) sum.style.display = 'block';
        if (multi) { multi.innerHTML = ''; multi.style.display = 'none'; }
        if (window.transfersChart) { window.transfersChart.destroy(); window.transfersChart = null; }
        if (Array.isArray(window.multiTransfersCharts)) { try { window.multiTransfersCharts.forEach(ch => ch && ch.destroy && ch.destroy()); } catch {} window.multiTransfersCharts = []; }
        lastTransfersData = null;
      } catch {}
    }
      function hideInvestmentsUI() {
        try {
          const sec = document.getElementById('investments-section'); if (sec) sec.style.display = 'none';
          const list = document.getElementById('investmentsCategoryList');
          const sum = document.getElementById('investmentsSummary');
          const back = document.getElementById('investmentsBack');
          const btn = document.getElementById('investmentsCategoryEntriesBtn');
          const title = document.getElementById('investments-title');
          const canvas = document.getElementById('investmentsPieChart');
          const multi = document.getElementById('multiInvestmentsContainer');
          if (list) list.innerHTML = '';
          if (sum) sum.innerHTML = '';
          if (back) back.style.display = 'none';
          if (btn) btn.style.display = 'none';
          if (title) { title.textContent = 'Investments Breakdown'; title.style.display = 'block'; }
          if (canvas && canvas.parentElement) { canvas.parentElement.style.display = 'block'; }
          if (list) list.style.display = 'block';
          if (sum) sum.style.display = 'block';
          if (multi) { multi.innerHTML = ''; multi.style.display = 'none'; }
          if (window.investmentsChart) { window.investmentsChart.destroy(); window.investmentsChart = null; }
          if (Array.isArray(window.multiInvestmentsCharts)) { try { window.multiInvestmentsCharts.forEach(ch => ch && ch.destroy && ch.destroy()); } catch {} window.multiInvestmentsCharts = []; }
          lastInvestmentsData = null; investmentParentCat = null;
        } catch {}
      }
    function showSubChart(data, parentCat, mainChartData, updateLast) {
      // Show only subcategories for parentCat
      let subData = {};
      for (const k in data) {
        if (k.startsWith(parentCat + '::')) {
          subData[k.replace(parentCat + '::', '')] = data[k];
        }
      }
      const total = Object.values(subData).reduce((a, b) => a + b, 0);
      if (Object.keys(subData).length === 0) {
        document.getElementById('subchart-section').style.display = 'none';
        return;
      }
      // If updateLast is true, update the static sub pie (chart2)
      if (updateLast) {
        lastSubCat = parentCat;
        lastSubData = subData;
      }
      // chart1: show sub pie in main chart area
      document.getElementById('subchart-section').style.display = 'block';
      document.getElementById('subchart-title').innerText = parentCat + ' breakdown';
      const ctx = document.getElementById('subPieChart').getContext('2d');
      if (subChart) subChart.destroy();
      // Store original keys for datalabels reference
      let subKeys = Object.keys(subData);
      // Use shortNames for subcategory labels if available
      let subLabels = subKeys.map(cat => {
        if (mapping[parentCat] && mapping[parentCat].subcategories) {
          const sub = mapping[parentCat].subcategories.find(s => s.name === cat);
          return (sub && sub.shortName) ? sub.shortName : cat;
        }
        return cat;
      });
      subChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: subLabels,
          datasets: [{
            data: Object.values(subData),
            backgroundColor: subKeys.map((_, i) => COLORS[i % COLORS.length])
          }]
        },
        options: {
          responsive: true,
          layout: {
            padding: {
              top: 60,
              bottom: 60,
              left: 80,
              right: 80
            }
          },
          plugins: {
            title: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  // Use original key for full name
                  let idx = context.dataIndex;
                  let key = Object.keys(subData)[idx];
                  let fullLabel = key;
                  if (mapping[parentCat] && mapping[parentCat].subcategories) {
                    const sub = mapping[parentCat].subcategories.find(s => s.name === key);
                    if (sub) fullLabel = sub.name;
                  }
                  const value = context.parsed;
                  const percent = total ? ((value / total) * 100).toFixed(1) : 0;
                  return `${fullLabel}: â‚¹${formatINR(value)} (${percent}%)`;
                }
              }
            },
            legend: {
              display: false
            },
            datalabels: {
              color: '#222',
              font: { weight: 'bold', size: 12 },
              formatter: function(value, context) {
                const percent = total ? ((value / total) * 100).toFixed(1) : 0;
                // Use original key to get shortName
                let key = subKeys[context.dataIndex];
                let label = subLabels[context.dataIndex];
                return percent >= 4 ? `${label} ${percent}%` : '';
              },
              anchor: 'end',
              align: 'end',
              offset: 8,
              clamp: false,
              clip: false,
              display: 'auto',
            }
          }
        },
        plugins: [ChartDataLabels]
      });
      // Show legend for subcategories
      const legend = Object.keys(subData).map((cat, i) => {
        const value = subData[cat];
        const percent = total ? ((value / total) * 100).toFixed(1) : 0;
        return `<li><span class=\"category-color\" style=\"background:${COLORS[i % COLORS.length]}\"></span> <b>${cat}</b>: â‚¹${formatINR(value)} (${percent}%)</li>`;
      }).join('');
      document.getElementById('subCategoryList').innerHTML = `<ul>${legend}</ul>`;
      inSubChart = true;
      // chart2: static sub pie (always visible if lastSubCat)
      renderStaticSubPie();
    }

    function renderStaticSubPie() {
      const staticSection = document.getElementById('static-main-section');
      if (!staticSection) return;
      if (!lastSubCat || !lastSubData) {
        staticSection.style.display = 'none';
        return;
      }
      staticSection.style.display = 'block';
      document.getElementById('static-main-title').innerText = lastSubCat + ' breakdown (pinned)';
      const staticCtx = document.getElementById('staticMainPieChart').getContext('2d');
      if (window.staticMainPie) window.staticMainPie.destroy();
      window.staticMainPie = new Chart(staticCtx, {
        type: 'pie',
        data: {
          labels: Object.keys(lastSubData),
          datasets: [{
            data: Object.values(lastSubData),
            backgroundColor: Object.keys(lastSubData).map((_, i) => COLORS[i % COLORS.length])
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: false },
            legend: { display: false },
            datalabels: {
              color: '#222',
              font: { weight: 'bold', size: 14 },
              formatter: function(value, context) {
                const label = context.chart.data.labels[context.dataIndex];
                const total = Object.values(lastSubData).reduce((a, b) => a + b, 0);
                const percent = total ? ((value / total) * 100).toFixed(1) : 0;
                return percent >= 4 ? `${label}\n${percent}%` : '';
              },
              anchor: 'end',
              align: 'end',
              offset: 8,
              clamp: true
            }
          }
        },
        plugins: [ChartDataLabels]
      });
      // Show legend for static sub pie
      const staticLegend = Object.keys(lastSubData).map((cat, i) => {
        const value = lastSubData[cat];
        const percent = Object.values(lastSubData).reduce((a, b) => a + b, 0) ? ((value / Object.values(lastSubData).reduce((a, b) => a + b, 0)) * 100).toFixed(1) : 0;
        return `<li><span class=\"category-color\" style=\"background:${COLORS[i % COLORS.length]}\"></span> <b>${cat}</b>: â‚¹${formatINR(value)} (${percent}%)</li>`;
      }).join('');
      document.getElementById('staticMainCategoryList').innerHTML = `<ul>${staticLegend}</ul>`;
    }

    // --- Time analysis (Monthly/Yearly bar) ---
    // Build a stable entry key (member+text+amount) consistent with exclusions
    function mkEntryKey(e) {
      const norm = (t) => String(t || '').trim().replace(/\s+/g, ' ').toLowerCase();
      const text = e.text || e.description || '';
      const memberPart = e && e.memberId ? String(e.memberId) : '';
      return memberPart + '|' + norm(text) + '|' + String(Number(e.amount || 0));
    }

    // Compute main Expense/Income totals and category buckets from entries so that
    // the donut chart matches the time-analysis bar chart and respects member/year filters.
    // Special rule: entries whose main category is "Tax" are treated as a separate
    // bucket that is deducted from income (for net income) and NOT included in
    // expense totals or expense breakdowns.
    function computeMainTotalsFromEntries(data) {
      const list = (data && Array.isArray(data.entries)) ? data.entries : [];
      let expense = 0;
      let income = 0;
      let taxTotal = 0;
      const expenseAgg = {};
      const incomeAgg = {};
      const taxAgg = {};
      const shouldExclude = memberScopeActive && excludedEntryKeys && excludedEntryKeys.size;
      for (const e of list) {
        if (e.type !== 'expense' && e.type !== 'income') continue;
        if (!matchesYearSelection(e)) continue;
        const amt = Number(e.amount || 0);
        if (!isFinite(amt) || amt <= 0) continue;
        const main = e.main || 'Uncategorized';
        const sub = e.sub;
        const isTaxMain = main === 'Tax';
        // Member-scoped exclusions (transfers/investments) should not affect Tax totals,
        // so we only skip non-Tax entries when they appear in the excluded set.
        if (!isTaxMain && shouldExclude && excludedEntryKeys.has(mkEntryKey(e))) continue;
        if (e.type === 'expense') {
          if (main === 'Tax') {
            taxTotal += amt;
            taxAgg[main] = (taxAgg[main] || 0) + amt;
            if (sub) {
              const key = main + '::' + sub;
              taxAgg[key] = (taxAgg[key] || 0) + amt;
            }
          } else {
            expense += amt;
            expenseAgg[main] = (expenseAgg[main] || 0) + amt;
            if (sub) {
              const key = main + '::' + sub;
              expenseAgg[key] = (expenseAgg[key] || 0) + amt;
            }
          }
        } else {
          income += amt;
          incomeAgg[main] = (incomeAgg[main] || 0) + amt;
          if (sub) {
            const key = main + '::' + sub;
            incomeAgg[key] = (incomeAgg[key] || 0) + amt;
          }
        }
      }
      return { expenseTotal: expense, incomeTotal: income, expenseAgg, incomeAgg, taxTotal, taxAgg };
    }
    function parseToDate(val) {
      if (!val && val !== 0) return null;
      if (val instanceof Date) return isNaN(val) ? null : val;
      // Excel numeric serials (possibly as string or with fractional time)
      const n = Number(val);
      if (isFinite(n) && String(val).trim() !== '' && /^(?:\d+)(?:\.\d+)?$/.test(String(val).trim())) {
        const ms = Math.round((n - 25569) * 86400 * 1000);
        const d = new Date(ms);
        return isNaN(d) ? null : d;
      }
      const s = String(val).trim();
      if (!s) return null;
      // dd/mm/yyyy or dd-mm-yyyy (prioritize over native parsing)
      let m = s.match(/^([0-3]?\d)[\/\-]([0-1]?\d)[\/\-](\d{2,4})$/);
      if (m) {
        const day = parseInt(m[1],10);
        const mon = parseInt(m[2],10) - 1;
        let yr = parseInt(m[3],10);
        // Two-digit year like 26/07/24 -> 2024
        if (yr < 100) yr = 2000 + yr;
        const d = new Date(yr, mon, day);
        return isNaN(d) ? null : d;
      }
      // dd-MMM-yy or dd-MMM-yyyy
      m = s.match(/^([0-3]?\d)[\- ]([A-Za-z]{3})[\- ](\d{2,4})$/);
      if (m) {
        const day = parseInt(m[1],10);
        const monStr = m[2].toLowerCase();
        const monMap = { jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11 };
        const mon = monMap[monStr];
        let yr = parseInt(m[3],10);
        if (yr < 100) yr = 2000 + yr;
        if (mon !== undefined) {
          const d = new Date(yr, mon, day);
          return isNaN(d) ? null : d;
        }
      }
      // yyyy-mm-dd or yyyy/mm/dd
      m = s.match(/^(\d{4})[\-\/](\d{1,2})[\-\/](\d{1,2})$/);
      if (m) {
        const yr = parseInt(m[1],10), mon = parseInt(m[2],10)-1, day = parseInt(m[3],10);
        const d = new Date(yr, mon, day);
        return isNaN(d) ? null : d;
      }
      // Finally, try native parse
      {
        const d = new Date(s);
        return isNaN(d) ? null : d;
      }
    }

    function buildTimeSeries(entries) {
      const monthly = new Map(); // key: YYYY-MM
      const yearly = new Map();  // key: YYYY
      (entries || []).forEach(e => {
        const dt = parseToDate(e.date);
        if (!dt) return;
        const y = dt.getFullYear();
        const m = (dt.getMonth() + 1).toString().padStart(2,'0');
        const kM = `${y}-${m}`;
        const kY = `${y}`;
        const isExp = e.type === 'expense';
        const isInc = e.type === 'income';
        const amt = Number(e.amount || 0);
        if (!isNaN(amt)) {
          if (!monthly.has(kM)) monthly.set(kM, { expense:0, income:0 });
          if (!yearly.has(kY)) yearly.set(kY, { expense:0, income:0 });
          // Do not treat Tax as an expense in time-series views
          const isTax = (e.main || '') === 'Tax';
          if (isExp && !isTax) { monthly.get(kM).expense += amt; yearly.get(kY).expense += amt; }
          if (isInc) { monthly.get(kM).income += amt; yearly.get(kY).income += amt; }
        }
      });
      return { monthly, yearly };
    }

    function getFinancialYear(d) {
      const y = d.getFullYear();
      const m = d.getMonth(); // 0=Jan
      return m >= 3 ? y : (y - 1);
    }

    // Helper: does an entry fall within the currently selected years for the main donut?
    function matchesYearSelection(entry) {
      if (!selectedYearsForMain || !selectedYearsForMain.size) return true; // no filter => all years
      const d = parseToDate(entry.date);
      if (!d) return false;
      const y = (yearFilterMode === 'financial') ? getFinancialYear(d) : d.getFullYear();
      return selectedYearsForMain.has(y);
    }

    // Helpers for time-drill
    function matchesDateFilter(entry, filter) {
      if (!filter) return true;
      const d = parseToDate(entry.date);
      if (!d) return false;
      const y = d.getFullYear();
      const m = d.getMonth(); // 0-based
      if (filter.view === 'yearly') {
        return y === filter.year;
      }
      // monthly view
      return y === filter.year && m === filter.month;
    }

    function aggregateByCategory(entries, type) {
      const out = {};
      (entries || []).forEach(e => {
        if (e.type !== type) return;
        const amt = Number(e.amount || 0);
        if (isNaN(amt)) return;
        const main = e.main || 'Uncategorized';
        out[main] = (out[main] || 0) + amt;
        const sub = e.sub;
        if (sub) {
          const key = main + '::' + sub;
          out[key] = (out[key] || 0) + amt;
        }
      });
      return out;
    }

    function filterEntriesPeriodType(view, year, monthIndex, type) {
      const all = (chartData && Array.isArray(chartData.entries)) ? chartData.entries : [];
      const filter = { view, year, month: view === 'monthly' ? monthIndex : null };
      let out = all.filter(e => e.type === type && matchesDateFilter(e, filter));
      // Exclude member-scoped transfer/investment overlays from main expense/income time views
      const shouldExclude = memberScopeActive && (type === 'expense' || type === 'income') && excludedEntryKeys && excludedEntryKeys.size;
      if (shouldExclude) out = out.filter(e => !excludedEntryKeys.has(mkEntryKey(e)));
      // Also exclude Tax from expense views so it does not appear as an outgoing expense
      if (type === 'expense') out = out.filter(e => (e.main || '') !== 'Tax');
      return out;
    }

    function renderTimeCategoryBar(view, year, monthIndex, type) {
      inTimeDrill = true;
      entriesDateFilter = { view, year, month: view === 'monthly' ? monthIndex : null };
      const filtered = filterEntriesPeriodType(view, year, monthIndex, type);
      renderCategoryBarChart(filtered, type, year, monthIndex);
      barDrillStack.push({ level: 'category', type, view, year, monthIndex });
    }

    function renderCategoryBarChart(entries, type, year, monthIndex) {
      const ctx = document.getElementById('timeBarChart').getContext('2d');
      if (timeChart) { timeChart.destroy(); timeChart = null; }
      const agg = {};
      (entries || []).forEach(e => {
        const main = e.main || 'Uncategorized';
        const amt = Number(e.amount || 0);
        if (!isNaN(amt)) agg[main] = (agg[main] || 0) + amt;
      });
      const keys = Object.keys(agg);
      const labels = keys.map(cat => (mapping && mapping[cat] && mapping[cat].shortName) ? mapping[cat].shortName : cat);
      const data = keys.map(k => agg[k]);
      const titleType = type === 'expense' ? 'Expense' : 'Income';
      const monName = (monthIndex != null) ? ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][monthIndex] : null;
      const title = `${titleType} by Category â€” ${monName ? monName + ' ' + year : year}`;
      document.getElementById('timeSummary').textContent = `${titleType}: â‚¹${formatINR(data.reduce((a,b)=>a+b,0))}`;
      timeChart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: titleType, data, backgroundColor: '#60a5fa', borderRadius: 6 }] },
        options: {
          responsive: true,
          plugins: { legend: { display: false }, title: { display: true, text: title, color:'#2563eb', font: { weight: 'bold', size: 14 } } },
          scales: { y: { beginAtZero: true, ticks: { callback: (v)=> 'â‚¹' + formatINR(v) } } },
          onClick: (e, elements) => {
            if (!elements || !elements.length) return;
            const idx = elements[0].index;
            const parentCat = keys[idx];
            renderSubcategoryBarChart(entries, type, year, monthIndex, parentCat);
            barDrillStack.push({ level: 'subcategory', type, view: (monthIndex!=null?'monthly':'yearly'), year, monthIndex, parentCat });
          }
        }
      });
      // Also render textual legend list below, similar to pie charts
      const total = data.reduce((a,b)=>a+b,0) || 0;
      const legend = keys.map((cat, i) => {
        const value = data[i] || 0;
        const percent = total ? ((value / total) * 100).toFixed(1) : '0.0';
        return `<li class="legend-item" data-type="${type}" data-key="${cat}" style="cursor:pointer;" title="Tap to view entries"><span class="category-color" style="background:${COLORS[i % COLORS.length]}"></span> <b>${cat}</b>: â‚¹${formatINR(value)} (${percent}%)</li>`;
      }).join('');
      document.getElementById('categoryList').innerHTML = `<ul>${legend}</ul>`;
      const canvas = document.getElementById('timeBarChart');
      // Keep double-click for desktop; rely on legend taps for mobile
      canvas.ondblclick = (ev) => {
        const el = timeChart.getElementsAtEventForMode(ev, 'nearest', { intersect: true }, true)[0];
        if (!el) return;
        const idx = el.index;
        const parentCat = keys[idx];
        showEntriesForCategory(type, parentCat, false);
      };
    }

    function renderSubcategoryBarChart(entries, type, year, monthIndex, parentCat) {
      const ctx = document.getElementById('timeBarChart').getContext('2d');
      if (timeChart) { timeChart.destroy(); timeChart = null; }
      const subAgg = {};
      (entries || []).forEach(e => {
        if ((e.main || '') === parentCat) {
          const sub = e.sub || 'Uncategorized';
          const amt = Number(e.amount || 0);
          if (!isNaN(amt)) subAgg[sub] = (subAgg[sub] || 0) + amt;
        }
      });
      const keys = Object.keys(subAgg);
      const labels = keys.map(sub => {
        if (mapping && mapping[parentCat] && Array.isArray(mapping[parentCat].subcategories)) {
          const found = mapping[parentCat].subcategories.find(s => s.name === sub);
          return (found && found.shortName) ? found.shortName : sub;
        }
        return sub;
      });
      const data = keys.map(k => subAgg[k]);
      const titleType = type === 'expense' ? 'Expense' : 'Income';
      const monName = (monthIndex != null) ? ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][monthIndex] : null;
      const title = `${parentCat} â€” ${titleType} by Subcategory â€” ${monName ? monName + ' ' + year : year}`;
      document.getElementById('timeSummary').textContent = `${titleType}: â‚¹${formatINR(data.reduce((a,b)=>a+b,0))}`;
      timeChart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: `${titleType} â€” ${parentCat}`, data, backgroundColor: '#34d399', borderRadius: 6 }] },
        options: {
          responsive: true,
          plugins: { legend: { display: false }, title: { display: true, text: title, color:'#2563eb', font: { weight: 'bold', size: 14 } } },
          scales: { y: { beginAtZero: true, ticks: { callback: (v)=> 'â‚¹' + formatINR(v) } } },
          onClick: (e, elements) => {
            // Single click does nothing further at subcategory level
          }
        }
      });
      // Render subcategory legend list for time subcategory view
      const total = data.reduce((a,b)=>a+b,0) || 0;
      const legend = keys.map((cat, i) => {
        const value = data[i] || 0;
        const percent = total ? ((value / total) * 100).toFixed(1) : '0.0';
        return `<li class=\"legend-item\" data-type=\"${type}\" data-parent=\"${parentCat}\" data-key=\"${cat}\" style=\"cursor:pointer;\" title=\"Tap to view entries\"><span class=\"category-color\" style=\"background:${COLORS[i % COLORS.length]}\"></span> <b>${cat}</b>: â‚¹${formatINR(value)} (${percent}%)</li>`;
      }).join('');
      document.getElementById('categoryList').innerHTML = `<ul>${legend}</ul>`;
      const canvas = document.getElementById('timeBarChart');
      // At subcategory level, allow single tap to open entries
      canvas.onclick = (ev) => {
        const el = timeChart.getElementsAtEventForMode(ev, 'nearest', { intersect: true }, true)[0];
        if (!el) return;
        const idx = el.index;
        const subKey = keys[idx];
        showEntriesForSubcategory(type, parentCat, subKey, false);
      };
      canvas.ondblclick = canvas.onclick;
    }

    function timeBarGoBack() {
      if (!barDrillStack.length) return;
      const top = barDrillStack.pop();
      if (top.level === 'subcategory') {
        // Go back to category level
        const entries = filterEntriesPeriodType(top.view, top.year, top.monthIndex, top.type);
        renderCategoryBarChart(entries, top.type, top.year, top.monthIndex);
      } else if (top.level === 'category') {
        // Back to root time chart, preserve selection
        inTimeDrill = false;
        entriesDateFilter = null;
        const view = timeViewSelected || 'monthly';
        const year = timeYearSelected || Number((document.getElementById('timeYearSelect').value || '')) || null;
        renderTimeChart(lastTimeSeries, view, year);
      }
    }

    function initAndRenderTimeAnalysis(data) {
      const raw = (data && Array.isArray(data.entries)) ? data.entries : [];
      // Ensure time series matches main chart scope by excluding overlaid entries
      const shouldExclude = memberScopeActive && excludedEntryKeys && excludedEntryKeys.size;
      let entries = shouldExclude
        ? raw.filter(e => {
            if (e.type !== 'expense' && e.type !== 'income') return false;
            const isTaxMain = (e.main || '') === 'Tax';
            // Never exclude Tax entries from the time-series input; they will
            // be handled specially in buildTimeSeries (not counted as expense).
            if (isTaxMain) return true;
            return !excludedEntryKeys.has(mkEntryKey(e));
          })
        : raw;
      // Also respect the global year filter used by the main donut
      entries = entries.filter(e => (e.type === 'expense' || e.type === 'income') && matchesYearSelection(e));
      const { monthly, yearly } = buildTimeSeries(entries);
      lastTimeSeries = { monthly, yearly };
      const section = document.getElementById('time-section');
      const yearSel = document.getElementById('timeYearSelect');
      const yearLbl = document.getElementById('timeYearLabel');
      const viewSel = document.getElementById('timeViewSelect');
      // Build year options
      const years = Array.from(yearly.keys()).map(y => Number(y)).sort((a,b)=>a-b);
      yearSel.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
      // Preserve previously selected view and year if possible
      if (timeViewSelected && (timeViewSelected === 'monthly' || timeViewSelected === 'yearly')) {
        viewSel.value = timeViewSelected;
      }
      if (years.length) {
        if (timeYearSelected !== null && years.includes(Number(timeYearSelected))) {
          yearSel.value = String(timeYearSelected);
        } else {
          yearSel.value = String(years[years.length-1]);
          timeYearSelected = years[years.length-1];
        }
      }
      const render = () => renderTimeChart({ monthly, yearly }, viewSel.value, Number(yearSel.value));
      viewSel.onchange = () => {
        timeViewSelected = viewSel.value;
        const v = viewSel.value;
        const showYear = v === 'monthly' && years.length;
        yearSel.style.display = showYear ? 'inline' : 'none';
        yearLbl.style.display = showYear ? 'inline' : 'none';
        render();
      };
      yearSel.onchange = () => {
        timeYearSelected = Number(yearSel.value);
        render();
      };
      // Show/hide controls
      const showYear = (viewSel.value === 'monthly') && years.length;
      yearSel.style.display = showYear ? 'inline' : 'none';
      yearLbl.style.display = showYear ? 'inline' : 'none';
      section.style.display = (years.length || monthly.size) ? 'block' : 'none';
      render();
      // Ensure globals reflect current selection
      timeViewSelected = viewSel.value;
      timeYearSelected = Number(yearSel.value) || timeYearSelected;
    }

    function renderTimeChart(series, view, year) {
      const COLORS_E = '#ef4444'; // expense red
      const COLORS_I = '#10b981'; // income green
      const ctx = document.getElementById('timeBarChart').getContext('2d');
      if (timeChart) { timeChart.destroy(); timeChart = null; }
      lastTimeSeries = series;
      let labels = [], exp = [], inc = [];
      let title = '';
      if (view === 'yearly') {
        const entries = Array.from(series.yearly.entries()).sort((a,b)=> Number(a[0]) - Number(b[0]));
        labels = entries.map(([y]) => y);
        exp = entries.map(([,v]) => v.expense || 0);
        inc = entries.map(([,v]) => v.income || 0);
        title = 'Expense vs Income by Year';
      } else {
        // monthly for selected year
        const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        labels = months;
        exp = new Array(12).fill(0);
        inc = new Array(12).fill(0);
        Array.from(series.monthly.entries()).forEach(([k,v]) => {
          const y = Number(k.slice(0,4));
          const m = Number(k.slice(5,7));
          if (!year || y === year) {
            exp[m-1] += v.expense || 0;
            inc[m-1] += v.income || 0;
          }
        });
        title = `Expense vs Income by Month${year? ' â€” '+year: ''}`;
      }
      const totalExp = exp.reduce((a,b)=>a+b,0);
      const totalInc = inc.reduce((a,b)=>a+b,0);
      document.getElementById('timeSummary').textContent = `Expense: â‚¹${formatINR(totalExp)} | Income: â‚¹${formatINR(totalInc)}`;
      timeChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Expense', data: exp, backgroundColor: COLORS_E, borderRadius: 6 },
            { label: 'Income', data: inc, backgroundColor: COLORS_I, borderRadius: 6 }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: title, color:'#2563eb', font: { weight: 'bold', size: 14 } }
          },
          scales: {
            y: { beginAtZero: true, ticks: { callback: (v)=> 'â‚¹' + formatINR(v) } }
          },
          onClick: (e, elements) => {
            if (!elements || !elements.length) return;
            const el = elements[0];
            const idx = el.index;
            const dsi = el.datasetIndex; // 0 expense, 1 income
            const type = dsi === 0 ? 'expense' : 'income';
            if (view === 'yearly') {
              const y = Number(labels[idx]);
              if (!isNaN(y)) renderTimeCategoryBar('yearly', y, null, type);
            } else {
              const monIdx = idx; // 0-11
              const y = Number(year);
              if (!isNaN(y) && monIdx >= 0 && monIdx < 12) {
                renderTimeCategoryBar('monthly', y, monIdx, type);
              }
            }
          }
        }
      });
    }

    // --- Year filter controls for main donut ---
    function rebuildYearFilterControls(data) {
      const bar = document.getElementById('yearFilterBar');
      const host = document.getElementById('yearFilterOptions');
      const clearBtn = document.getElementById('yearFilterClear');
      const modeSel = document.getElementById('yearFilterModeSelect');
      if (!bar || !host) return;
      if (modeSel) {
        modeSel.value = yearFilterMode;
        modeSel.onchange = function() {
          const v = modeSel.value === 'financial' ? 'financial' : 'calendar';
          if (yearFilterMode !== v) {
            yearFilterMode = v;
            // Reset selection to "all" when switching modes
            selectedYearsForMain = new Set();
            if (chartData) {
              // Re-render full view (main donut + transfers/investments) for current member selection
              (async () => { await renderForMemberSelection(chartData); })();
              return;
            }
            if (currentMainDataSnapshot) {
              showMainIncomeExpenseChart(currentMainDataSnapshot);
              return;
            }
          }
        };
      }
      const list = (data && Array.isArray(data.entries)) ? data.entries : [];
      const yearsSet = new Set();
      for (const e of list) {
        const d = parseToDate(e.date);
        if (!d) continue;
        const y = (yearFilterMode === 'financial') ? getFinancialYear(d) : d.getFullYear();
        yearsSet.add(y);
      }
      const years = Array.from(yearsSet).sort((a, b) => a - b);
      host.innerHTML = '';
      if (!years.length) {
        bar.style.display = 'none';
        return;
      }
      // Keep only years that still exist in the new dataset
      if (selectedYearsForMain && selectedYearsForMain.size) {
        const kept = new Set();
        years.forEach(y => { if (selectedYearsForMain.has(y)) kept.add(y); });
        selectedYearsForMain = kept;
      }
      const effectiveSelected = (selectedYearsForMain && selectedYearsForMain.size)
        ? new Set(Array.from(selectedYearsForMain))
        : new Set(years); // all years selected by default
      years.forEach(y => {
        const label = document.createElement('label');
        label.className = 'year-toggle';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = String(y);
        cb.checked = effectiveSelected.has(y);
        cb.style.margin = '0';
        cb.onchange = updateSelectedYearsFromControls;
        label.appendChild(cb);
        const span = document.createElement('span');
        span.textContent = (yearFilterMode === 'financial') ? `FY ${y}-${y + 1}` : String(y);
        label.appendChild(span);
        if (cb.checked) label.classList.add('year-toggle-active');
        host.appendChild(label);
      });
      bar.style.display = 'flex';
      if (clearBtn) {
        clearBtn.onclick = function() {
          const checkboxes = host.querySelectorAll('input[type="checkbox"]');
          checkboxes.forEach(cb => { cb.checked = true; });
          selectedYearsForMain = new Set(); // empty => all years
          if (chartData) {
            (async () => { await renderForMemberSelection(chartData); })();
          } else if (currentMainDataSnapshot) {
            showMainIncomeExpenseChart(currentMainDataSnapshot);
          }
        };
      }
    }

    function updateSelectedYearsFromControls() {
      const host = document.getElementById('yearFilterOptions');
      if (!host) return;
      const checkboxes = Array.from(host.querySelectorAll('input[type="checkbox"]'));
      const activeYears = checkboxes.filter(cb => cb.checked).map(cb => Number(cb.value));
      const total = checkboxes.length;
      // If all years are checked, treat as no filter
      selectedYearsForMain = (activeYears.length === total) ? new Set() : new Set(activeYears);
      // Update visual toggle state
      checkboxes.forEach(cb => {
        const label = cb.parentElement;
        if (!label) return;
        if (cb.checked) label.classList.add('year-toggle-active');
        else label.classList.remove('year-toggle-active');
      });
      if (currentMainDataSnapshot) {
        if (chartData) {
          (async () => { await renderForMemberSelection(chartData); })();
        } else {
          showMainIncomeExpenseChart(currentMainDataSnapshot);
        }
      }
    }

    // Navigation handled via Back button; click-outside disabled for clarity

    function drillDown(category) {
      // Only drill down if there are subcategories for this main category
      const hasSub = Object.keys(chartData.summary).some(k => k.startsWith(category + '::'));
      if (!hasSub) return;
      drillStack.push({
        data: chartData.summary,
        title: 'Expenses',
        isSub: false,
        parentCat: null
      });
      showChart(chartData.summary, category + ' breakdown', true, category);
      document.getElementById('drillback').style.display = 'inline';
    }

    function goBack() {
      if (currentParentCat) {
        const title = currentType === 'expense' ? 'Expense Breakdown' : 'Income Breakdown';
        // Use cached breakdown snapshot to avoid recalculating buckets like 'Uncategorized'
        const snap = (lastBreakdownType === currentType && lastBreakdownData) ? lastBreakdownData : chartData[currentType];
        showCategoryBreakdown(snap, title, currentType);
        currentParentCat = null;
        if (drillStack.length) drillStack.pop();
        document.getElementById('categoryEntriesBtn').style.display = 'none';
        return;
      }
      if (currentType) {
        if (inTimeDrill) { inTimeDrill = false; entriesDateFilter = null; }
        (async () => { await renderForMemberSelection(chartData); })();
        currentType = null;
        lastBreakdownData = null; lastBreakdownType = null;
        if (drillStack.length) drillStack.pop();
        document.getElementById('drillback').style.display = 'none';
        document.getElementById('categoryEntriesBtn').style.display = 'none';
      }
    }
    document.getElementById('drillback').onclick = goBack;

    document.getElementById('categoryEntriesBtn').onclick = function(e) {
      e.stopPropagation();
      if (currentParentCat && currentType) {
        showEntriesForCategory(currentType, currentParentCat, false);
      }
    };

    document.getElementById('transfersCategoryEntriesBtn').onclick = function(e) {
      e.stopPropagation();
      if (transferParentCat) {
        showEntriesForCategory('transfer', transferParentCat, true);
      }
    };
    document.getElementById('investmentsCategoryEntriesBtn').onclick = function(e) {
      e.stopPropagation();
      if (investmentParentCat) {
        showEntriesForCategory('investment', investmentParentCat, false);
      }
    };

    // Click outside the main pie acts like Back (ignore controls, legends & entries panel)
    document.addEventListener('click', function(e) {
      const pie = document.getElementById('pieChart');
      const legendBox = document.getElementById('categoryList');
      const target = e.target;
      const ignore = (
        target.id === 'categoryEntriesBtn' ||
        target.id === 'drillback' ||
        target.closest('#entries-section') ||
        target.closest('#categoryList') ||
        target.closest('#mappingModal')
      );
      // If we are in a drilldown state and click is outside the pie canvas
      if (!ignore && (currentParentCat || currentType) && target !== pie && !pie.contains(target) && !(legendBox && legendBox.contains(target))) {
        goBack();
      }
    });

    // Click outside transfers pie returns from sub breakdown (ignore controls, legends & entries panel)
    document.addEventListener('click', function(e) {
      const tpie = document.getElementById('transfersPieChart');
      const tlegend = document.getElementById('transfersCategoryList');
      const target = e.target;
      const ignore = (
        target.id === 'transfersCategoryEntriesBtn' ||
        target.id === 'transfersBack' ||
        target.closest('#entries-section') ||
        target.closest('#transfersCategoryList') ||
        target.closest('#mappingModal')
      );
      if (!ignore && transferParentCat && tpie && target !== tpie && !tpie.contains(target) && !(tlegend && tlegend.contains(target))) {
        showTransfersChart(lastTransfersData);
        transferParentCat = null;
      }
    });

    // Click outside investments pie returns from sub breakdown (ignore controls, legends & entries panel)
    document.addEventListener('click', function(e) {
      const ipie = document.getElementById('investmentsPieChart');
      const ileg = document.getElementById('investmentsCategoryList');
      const target = e.target;
      const ignore = (
        target.id === 'investmentsCategoryEntriesBtn' ||
        target.id === 'investmentsBack' ||
        target.closest('#entries-section') ||
        target.closest('#investmentsCategoryList') ||
        target.closest('#mappingModal')
      );
      if (!ignore && investmentParentCat && ipie && target !== ipie && !ipie.contains(target) && !(ileg && ileg.contains(target))) {
        showInvestmentsChart(lastInvestmentsData);
        investmentParentCat = null;
      }
    });

    // Click outside time bar chart acts like Back only during drilldown
    document.addEventListener('click', function(e) {
      const tbar = document.getElementById('timeBarChart');
      const target = e.target;
      const insideTime = target === tbar || (tbar && tbar.contains(target)) || (target.closest && target.closest('#time-section'));
      const ignore = target.closest && (target.closest('#entries-section') || target.closest('#mappingModal'));
      if (!ignore && inTimeDrill && tbar && !insideTime) {
        timeBarGoBack();
      }
    });

    document.getElementById('uploadForm').onsubmit = async function(e) {
      e.preventDefault();
      const fileInput = document.getElementById('fileInput');
      const mainFilesLabel = document.getElementById('mainFilesLabel');
      if (!fileInput.files.length) {
        if (mainFilesLabel) { mainFilesLabel.style.color = '#ef4444'; mainFilesLabel.textContent = 'Please select file(s)'; }
        return;
      }
      const formData = new FormData();
      const files = Array.from(fileInput.files);
      const isMulti = files.length > 1;
      if (isMulti) {
        files.forEach(f => formData.append('files', f));
      } else {
        formData.append('file', files[0]);
      }
      await fetchMapping();
      try {
        const hasToken = !!localStorage.getItem('token');
        const endpoint = isMulti ? '/upload-multi' : '/upload';
        const res = await apiFetch(endpoint, { method: 'POST', body: formData });
        if (!res.ok) {
          throw new Error('Upload failed: ' + res.status);
        }
        const data = await res.json();
        const reportOrAgg = (data && data.report) ? data.report : data;
        chartData = reportOrAgg;
        window.chartData = reportOrAgg; // ensure global access for any legacy references
        currentType = null;
        currentParentCat = null;
        drillStack = [];
        await renderForMemberSelection(reportOrAgg);
      } catch (err) {
        console.error('Error uploading file:', err);
        alert('Error uploading file: ' + err.message);
      }
    };
    // Annotated Excel (comments) generator - independent of main upload flow
    (function initAnnotateExcel(){
      const btn = document.getElementById('annotateExcelBtn');
      if (!btn) return;
      const resultDiv = document.getElementById('annotateExcelResult');
      let lastUrl = null;

      function clearAnnotatedExcelUI() {
        if (lastUrl) {
          try { URL.revokeObjectURL(lastUrl); } catch (_) {}
          lastUrl = null;
        }
        if (resultDiv) {
          resultDiv.innerHTML = '';
          resultDiv.style.display = 'none';
        }
      }

      // Expose so the main Reset button can also clear it
      window.clearAnnotatedExcelUI = clearAnnotatedExcelUI;

      btn.onclick = async function() {
        const fileInput = document.getElementById('fileInput');
        const mainFilesLabel = document.getElementById('mainFilesLabel');
        if (!fileInput.files.length) {
          if (mainFilesLabel) { mainFilesLabel.style.color = '#ef4444'; mainFilesLabel.textContent = 'Please select a file first'; }
          return;
        }
        if (fileInput.files.length > 1) {
          alert('Please select a single Excel file for adding comments.');
          return;
        }
        // Ask which member's mappings (if any) should be used for comments
        let memberIdForComments = null;
        if (getToken && getToken()) {
          try { await loadFamily(); } catch (e) { console.warn('loadFamily for annotate-excel failed:', e); }
          const singleId = (typeof getSingleSelectedMemberId === 'function') ? getSingleSelectedMemberId() : null;
          if (singleId) {
            const byId = new Map(familyMembers.map(m => [m.id, m]));
            const memberName = byId.get(singleId)?.name || 'Selected member';
            if (window.showConfirm) {
              const ok = await window.showConfirm(
                `Generate Excel comments using exclusive mappings for member "${memberName}"?` +
                '\n\nOK = use this member\'s transfer and investment mappings.\nCancel = use only general mapping.'
              );
              if (ok) memberIdForComments = singleId;
            } else {
              memberIdForComments = singleId;
            }
          } else if (Array.isArray(familyMembers) && familyMembers.length) {
            if (window.showConfirm) {
              const proceed = await window.showConfirm(
                'No single member is selected for Excel comments.\n\nOK = continue with only general mapping.\nCancel = go back and choose exactly one member via the Members button.'
              );
              if (!proceed) return;
            }
          }
        }
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        try {
          const endpoint = memberIdForComments
            ? ('/annotate-excel?memberId=' + encodeURIComponent(memberIdForComments))
            : '/annotate-excel';
          const res = await apiFetch(endpoint, { method: 'POST', body: formData });
          if (!res.ok) {
            throw new Error('Server returned ' + res.status);
          }
          const blob = await res.blob();
          if (lastUrl) {
            try { URL.revokeObjectURL(lastUrl); } catch (_) {}
          }
          const url = URL.createObjectURL(blob);
          lastUrl = url;
          const originalName = fileInput.files[0].name || 'statement.xlsx';
          const downloadName = 'annotated-' + originalName;
          if (resultDiv) {
            resultDiv.innerHTML = '';
            const viewLink = document.createElement('a');
            viewLink.href = url;
            viewLink.target = '_blank';
            viewLink.textContent = 'View annotated Excel';
            const sep = document.createTextNode(' | ');
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = downloadName;
            downloadLink.textContent = 'Download annotated Excel';
            const sep2 = document.createTextNode(' | ');
            const clearLink = document.createElement('a');
            clearLink.href = '#';
            clearLink.textContent = 'Clear';
            clearLink.onclick = function(e) {
              e.preventDefault();
              clearAnnotatedExcelUI();
            };
            resultDiv.appendChild(viewLink);
            resultDiv.appendChild(sep);
            resultDiv.appendChild(downloadLink);
            resultDiv.appendChild(sep2);
            resultDiv.appendChild(clearLink);
            resultDiv.style.display = 'block';
          } else {
            const a = document.createElement('a');
            a.href = url;
            a.download = downloadName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
          }
        } catch (err) {
          console.error('Error generating annotated Excel:', err);
          alert('Error generating annotated Excel: ' + err.message);
        }
      };
    })();
    // Main file select UX
    document.getElementById('selectMainFilesBtn').onclick = () => {
      const fileInput = document.getElementById('fileInput');
      fileInput.click();
    };
    document.getElementById('fileInput').onchange = () => {
      const fi = document.getElementById('fileInput');
      const lbl = document.getElementById('mainFilesLabel');
      const n = (fi.files || []).length;
      lbl.style.color = '#6b7280';
      lbl.textContent = n ? `${n} file(s) selected` : 'No files selected';
    };
    // Reset button handler
    function resetAppUI() {
      const fileInput = document.getElementById('fileInput');
      if (fileInput) fileInput.value = '';
      const mainFilesLabel = document.getElementById('mainFilesLabel');
      if (mainFilesLabel) {
        mainFilesLabel.style.color = '#6b7280';
        mainFilesLabel.textContent = 'No files selected';
      }
      if (typeof chart !== 'undefined' && chart) { chart.destroy(); chart = null; }
      const pieCanvas = document.getElementById('pieChart');
      if (pieCanvas) { const ctx = pieCanvas.getContext('2d'); ctx && ctx.clearRect(0, 0, pieCanvas.width, pieCanvas.height); }
      if (typeof subChart !== 'undefined' && subChart) { subChart.destroy(); subChart = null; }
      if (window.staticMainPie) { window.staticMainPie.destroy(); window.staticMainPie = null; }
      document.getElementById('summary').innerHTML = '';
      document.getElementById('categoryList').innerHTML = '';
      document.getElementById('subchart-section').style.display = 'none';
      document.getElementById('subCategoryList').innerHTML = '';
      document.getElementById('entries-section').style.display = 'none';
      document.getElementById('entriesBody').innerHTML = '';
      document.getElementById('entriesInfo').textContent = '';
      document.getElementById('entries-title').textContent = 'Entries';
      const f = document.getElementById('entriesFilter'); if (f) f.value = '';
      currentEntries = [];
      entriesPage = 1;
      document.getElementById('transfers-section').style.display = 'none';
      document.getElementById('transfersCategoryList').innerHTML = '';
      document.getElementById('transfersSummary').innerHTML = '';
      document.getElementById('transfersBack').style.display = 'none';
      if (window.transfersChart) { window.transfersChart.destroy(); window.transfersChart = null; }
      document.getElementById('investments-section').style.display = 'none';
      document.getElementById('investmentsCategoryList').innerHTML = '';
      document.getElementById('investmentsSummary').innerHTML = '';
      document.getElementById('investmentsBack').style.display = 'none';
      if (window.investmentsChart) { window.investmentsChart.destroy(); window.investmentsChart = null; }
      document.getElementById('static-main-section') && (document.getElementById('static-main-section').style.display = 'none');
      drillStack = [];
      chartData = null;
      lastSubCat = null;
      lastSubData = null;
      lastTransfersData = null;
      transferParentCat = null;
      lastInvestmentsData = null;
      investmentParentCat = null;
      inSubChart = false;
      document.getElementById('drillback').style.display = 'none';
      document.getElementById('categoryEntriesBtn').style.display = 'none';
      document.getElementById('transfersCategoryEntriesBtn').style.display = 'none';
      // Time analysis reset
      if (timeChart) { timeChart.destroy(); timeChart = null; }
      const tsec = document.getElementById('time-section'); if (tsec) tsec.style.display = 'none';
      inTimeDrill = false;
      entriesDateFilter = null;
      timeViewSelected = null;
      timeYearSelected = null;
      // Reset year filter UI/state for main donut
      selectedYearsForMain = new Set();
      const ybar = document.getElementById('yearFilterBar');
      const yopts = document.getElementById('yearFilterOptions');
      if (ybar) ybar.style.display = 'none';
      if (yopts) yopts.innerHTML = '';
      if (typeof window.clearAnnotatedExcelUI === 'function') {
        window.clearAnnotatedExcelUI();
      }
      updateSelectedMembersLabel();
    }
    document.getElementById('resetBtn').onclick = resetAppUI;

    // Mapping modal bindings
    document.getElementById('manageMappingBtn').onclick = () => openMappingModal({ mode: 'global', memberId: null, memberName: null });
    document.getElementById('closeMappingModal').onclick = closeMappingModal;
    document.getElementById('tabVisualBtn').onclick = () => setTab('visual');
    document.getElementById('tabJsonBtn').onclick = () => setTab('json');
    document.getElementById('validateMappingBtn').onclick = validateEditorJson;
    document.getElementById('saveMappingBtn').onclick = saveEditorJson;
    document.getElementById('downloadMappingBtn').onclick = downloadCurrentMapping;
    document.getElementById('importJsonFile').onchange = function(e) {
      if (e.target.files && e.target.files[0]) {
        importJsonFile(e.target.files[0]);
      }
    };
    document.getElementById('addMainCategoryBtn').onclick = () => {
      let base = 'New Category';
      let name = base;
      let i = 1;
      while (mapping[name]) { name = base + ' ' + i++; }
      mapping[name] = { shortName: '', keywords: [], subcategories: [] };
      renderMainCategoryList();
      selectMainCategory(name);
    };
    // Bind Members button
    document.getElementById('membersBtn').onclick = () => openMembersModal();
    // Transfer Mapping (member-specific) â€” reuse visual editor modal
    (function initMemberRulesModal(){
      const btn = document.getElementById('memberRulesBtn');
      if (!btn) return;
      btn.onclick = async () => {
        if (!getToken()) { openAuthModal('login'); return; }
        const memberId = getSingleSelectedMemberId();
        if (!memberId) { alert('Select exactly one member to manage mapping.'); return; }
        // Find member name for title
        const byId = new Map(familyMembers.map(m => [m.id, m]));
        const memberName = byId.get(memberId)?.name || 'Member';
        openMappingModal({ mode: 'member', memberId, memberName });
      };
    })();
    // Investment Mapping (member-specific)
    (function initMemberInvestmentModal(){
      const btn = document.getElementById('memberInvestmentBtn');
      if (!btn) return;
      btn.onclick = async () => {
        if (!getToken()) { openAuthModal('login'); return; }
        const memberId = getSingleSelectedMemberId();
        if (!memberId) { alert('Select exactly one member to manage investment mapping.'); return; }
        const byId = new Map(familyMembers.map(m => [m.id, m]));
        const memberName = byId.get(memberId)?.name || 'Member';
        openMappingModal({ mode: 'member-investment', memberId, memberName });
      };
    })();
    // Load family on startup (if authenticated) and default selection to primary
    (async function initFamilySelection(){
      if (getToken()) {
        await loadFamily();
        if (!selectedMemberIds.size && primaryMemberId) selectedMemberIds.add(primaryMemberId);
        updateSelectedMembersLabel();
      }
    })();
  </script>
  <!-- Auth Modal -->
  <div id="authModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:100;">
    <div style="max-width:420px; width:92%; margin:8% auto; background:#fff; border-radius:12px; box-shadow:0 10px 40px #0003; overflow:hidden;">
      <div style="padding:1em 1.2em; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between;">
        <h3 id="authTitle" style="margin:0; color:#2563eb;">Login</h3>
        <button id="authCloseBtn" class="btn btn-neutral">Close</button>
      </div>
      <div style="padding:1.2em; display:flex; flex-direction:column; gap:0.6em;">
        <input id="authName" type="text" placeholder="Name (for register)" style="display:none; padding:0.6em; border:1px solid #cbd5e1; border-radius:8px;" />
        <input id="authEmail" type="email" placeholder="Email" style="padding:0.6em; border:1px solid #cbd5e1; border-radius:8px;" />
        <input id="authPassword" type="password" placeholder="Password (min 6)" style="padding:0.6em; border:1px solid #cbd5e1; border-radius:8px;" />
        <div style="display:flex; gap:0.6em; align-items:center;">
          <button id="authSubmitBtn" class="btn btn-primary">Login</button>
          <button id="authToggleBtn" class="btn btn-neutral">Switch to Register</button>
          <span id="authMsg" style="margin-left:auto; font-weight:600;"></span>
        </div>
      </div>
    </div>
  </div>
  <script>
    // Uploads Manager Modal
    function buildUploadsManagerModal() {
      if (document.getElementById('uploadsModal')) return; // already exists
      const modal = document.createElement('div');
      modal.id = 'uploadsModal';
      modal.style.display = 'none';
      modal.style.position = 'fixed';
      modal.style.inset = '0';
      modal.style.background = 'rgba(0,0,0,0.35)';
      modal.style.zIndex = '100';
      modal.innerHTML = `
        <div style="max-width:720px; width:94%; margin:4% auto; background:#fff; border-radius:14px; box-shadow:0 12px 40px #0003; max-height:88vh; overflow:auto; overscroll-behavior:contain;">
          <div style="padding:1em 1.2em; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between;">
            <h3 style="margin:0; color:#111827;">Manage Uploads</h3>
            <button id="uploadsCloseBtn" class="btn btn-neutral btn-sm" title="Close">âœ•</button>
          </div>
          <div style="padding:1.2em; display:flex; flex-direction:column; gap:1em;">
            <div id="uploadsDropzone" style="border:2px dashed #cbd5e1; border-radius:12px; padding:1.2em; text-align:center; background:#f9fafb;">
              <div style="font-weight:700; color:#374151; margin-bottom:0.5em;">Upload Multiple Excel Files</div>
              <div style="color:#6b7280; margin-bottom:0.8em;">Drag & drop or choose files (.xlsx, .xls)</div>
              <input id="uploadsFileInput" type="file" accept=".xlsx,.xls" multiple style="display:none;" />
              <button id="uploadsChooseBtn" class="btn btn-primary btn-sm">Choose Files</button>
            </div>
            <div id="uploadsFileList" style="display:none;">
              <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:0.6em;">
                <div style="font-weight:700; color:#374151;">Selected Files</div>
                <button id="uploadsClearBtn" class="btn btn-neutral btn-sm">Clear</button>
              </div>
              <div id="uploadsFilesContainer" style="display:flex; flex-direction:column; gap:0.5em;"></div>
            </div>
            <div style="display:flex; align-items:center; gap:0.6em;">
              <button id="uploadsSaveBtn" class="btn btn-accent">Save All to Profile</button>
              <span id="uploadsMsg" style="font-weight:700; color:#2563eb;"></span>
            </div>
            <hr style="border:none; border-top:1px solid #e5e7eb;" />
            <div>
              <div style="display:flex; gap:0.6em; align-items:center; margin-bottom:0.5em; flex-wrap:wrap;">
                <button id="uploadsLoadAggBtn" class="btn btn-primary btn-sm">Load aggregated saved expenses</button>
                <button id="uploadsLoadSelectedBtn" class="btn btn-accent btn-sm">Load Selected</button>
                <button id="uploadsReparseSelectedBtn" class="btn btn-neutral btn-sm">Reparse Selected</button>
                <button id="uploadsDeleteSelectedBtn" class="btn btn-neutral btn-sm">Delete Selected</button>
                <button id="uploadsSelectAllBtn" class="btn btn-neutral btn-sm">Select All</button>
                <button id="uploadsClearSelectionBtn" class="btn btn-neutral btn-sm">Clear Selection</button>
                <div style="display:flex; align-items:center; gap:0.4em;">
                  <label for="uploadsMemberFilter" style="color:#374151; font-weight:600;">Filter by Member</label>
                  <select id="uploadsMemberFilter" style="padding:0.35em 0.5em; border:1px solid #cbd5e1; border-radius:8px; font-size:12px;"></select>
                </div>
                <span id="uploadsAggMsg" style="font-weight:700; color:#2563eb; margin-left:auto;"></span>
              </div>
              <div id="uploadsSavedList" style="display:flex; flex-direction:column; gap:0.5em;"></div>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      // Events
      document.getElementById('uploadsCloseBtn').onclick = () => { modal.style.display = 'none'; };
      const chooseBtn = document.getElementById('uploadsChooseBtn');
      const fileInput = document.getElementById('uploadsFileInput');
      const dropzone = document.getElementById('uploadsDropzone');
      const fileList = document.getElementById('uploadsFileList');
      const filesContainer = document.getElementById('uploadsFilesContainer');
      const clearBtn = document.getElementById('uploadsClearBtn');
      chooseBtn.onclick = () => fileInput.click();
      clearBtn.onclick = () => { fileInput.value = ''; filesContainer.innerHTML = ''; fileList.style.display = 'none'; };
      function showFiles(files) {
        filesContainer.innerHTML = '';
        const arr = Array.from(files);
        if (!arr.length) { fileList.style.display = 'none'; return; }
        fileList.style.display = 'block';
        arr.forEach(f => {
          const row = document.createElement('div');
          row.style.display = 'flex'; row.style.alignItems = 'center'; row.style.justifyContent = 'space-between';
          row.style.border = '1px solid #e5e7eb'; row.style.borderRadius = '8px'; row.style.padding = '0.5em 0.7em';
          row.innerHTML = `<div style="font-weight:600; color:#111827;">${f.name}<\/div><div style="color:#6b7280; font-size:12px;">${Math.round(f.size/1024)} KB<\/div>`;
          filesContainer.appendChild(row);
        });
      }
      fileInput.onchange = () => showFiles(fileInput.files);
      dropzone.ondragover = (e) => { e.preventDefault(); dropzone.style.borderColor = '#2563eb'; };
      dropzone.ondragleave = () => { dropzone.style.borderColor = '#cbd5e1'; };
      dropzone.ondrop = (e) => { e.preventDefault(); dropzone.style.borderColor = '#cbd5e1'; fileInput.files = e.dataTransfer.files; showFiles(fileInput.files); };
      document.getElementById('uploadsSaveBtn').onclick = async () => {
        const msg = document.getElementById('uploadsMsg');
        msg.style.color = '#2563eb'; msg.textContent = 'Uploading...';
        try {
          if (!localStorage.getItem('token')) { openAuthModal('login'); msg.textContent=''; return; }
          const files = fileInput.files;
          if (!files || !files.length) { msg.style.color = '#ef4444'; msg.textContent = 'Please select files.'; return; }
          const formData = new FormData();
          Array.from(files).forEach(f => formData.append('files', f));
          const res = await apiFetch('/my/uploads-multi', { method: 'POST', body: formData });
          const data = await res.json().catch(()=>({}));
          if (!res.ok) throw new Error(data && data.error ? data.error : 'Failed to save uploads');
          const errCount = Array.isArray(data.errors) ? data.errors.length : 0;
          msg.style.color = errCount ? '#f59e0b' : '#16a34a';
          msg.textContent = errCount ? `Saved with ${errCount} error(s)` : 'Saved';
          // Refresh saved list and load aggregated
          await refreshUploadsSavedList();
          await fetchMapping();
          const aggRes = await apiFetch('/my/expenses');
          const agg = await aggRes.json().catch(()=>({}));
          if (aggRes.ok) { chartData = agg; window.chartData = agg; currentType = null; currentParentCat = null; drillStack = [];
            await renderForMemberSelection(agg);
          }
          } catch (e) {
          msg.style.color = '#ef4444'; msg.textContent = e.message;
        }
      };
      const selectedSavedIds = new Set();
      document.getElementById('uploadsLoadAggBtn').onclick = async () => {
        const msg = document.getElementById('uploadsAggMsg');
        msg.style.color = '#2563eb'; msg.textContent = 'Loading...';
        try {
          await fetchMapping();
          const idsStr = getSelectedMemberIdsString();
          const r = await apiFetch(idsStr ? ('/my/expenses?memberIds=' + encodeURIComponent(idsStr)) : '/my/expenses');
          const d = await r.json().catch(()=>({}));
          if (!r.ok) throw new Error(d && d.error ? d.error : 'Failed to load aggregated');
          chartData = d; window.chartData = d; currentType = null; currentParentCat = null; drillStack = [];
          await renderForMemberSelection(d);
          msg.textContent = '';
        } catch (e) { msg.style.color = '#ef4444'; msg.textContent = e.message; }
      };
      document.getElementById('uploadsLoadSelectedBtn').onclick = async () => {
        const ids = Array.from(selectedSavedIds);
        const msg = document.getElementById('uploadsAggMsg');
        if (!ids.length) { msg.style.color = '#ef4444'; msg.textContent = 'No items selected'; return; }
        msg.style.color = '#2563eb'; msg.textContent = 'Loading selected...';
        try {
          await fetchMapping();
          const r = await apiFetch('/my/uploads/aggregate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ids }) });
          const d = await r.json().catch(()=>({}));
          if (!r.ok) throw new Error(d && d.error ? d.error : 'Failed to load selected');
          chartData = d; window.chartData = d; currentType = null; currentParentCat = null; drillStack = [];
          (async ()=>{ await renderForMemberSelection(d); })();
          document.getElementById('uploadsModal').style.display = 'none';
          msg.textContent = '';
        } catch (e) { msg.style.color = '#ef4444'; msg.textContent = e.message; }
      };
      document.getElementById('uploadsDeleteSelectedBtn').onclick = async () => {
        const ids = Array.from(selectedSavedIds);
        const msg = document.getElementById('uploadsAggMsg');
        if (!ids.length) { msg.style.color = '#ef4444'; msg.textContent = 'No items selected'; return; }
        const ok = await window.showConfirm('Delete selected uploads?');
        if (!ok) return;
        msg.style.color = '#2563eb'; msg.textContent = 'Deleting...';
        try {
          const r = await apiFetch('/my/uploads', { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ids }) });
          const d = await r.json().catch(()=>({}));
          if (!r.ok) throw new Error(d && d.error ? d.error : 'Failed to delete');
          selectedSavedIds.clear();
          await refreshUploadsSavedList();
          msg.textContent = '';
        } catch (e) { msg.style.color = '#ef4444'; msg.textContent = e.message; }
      };
      document.getElementById('uploadsReparseSelectedBtn').onclick = async () => {
        const ids = Array.from(selectedSavedIds);
        const msg = document.getElementById('uploadsAggMsg');
        if (!ids.length) { msg.style.color = '#ef4444'; msg.textContent = 'No items selected'; return; }
        msg.style.color = '#2563eb'; msg.textContent = 'Reparsing...';
        try {
          for (const id of ids) {
            const r = await apiFetch('/my/uploads/' + id + '/reparse', { method: 'PUT' });
            const d = await r.json().catch(()=>({}));
            if (!r.ok) throw new Error(d && d.error ? d.error : 'Failed to reparse one or more uploads');
          }
          await refreshUploadsSavedList();
          msg.textContent = '';
        } catch (e) { msg.style.color = '#ef4444'; msg.textContent = e.message; }
      };
      document.getElementById('uploadsSelectAllBtn').onclick = () => {
        document.querySelectorAll('#uploadsSavedList input[type="checkbox"]').forEach(cb => { cb.checked = true; selectedSavedIds.add(cb.value); });
      };
      document.getElementById('uploadsClearSelectionBtn').onclick = () => {
        selectedSavedIds.clear();
        document.querySelectorAll('#uploadsSavedList input[type="checkbox"]').forEach(cb => { cb.checked = false; });
      };
      // Populate member filter
      async function populateUploadsMemberFilter() {
        await loadFamily();
        const sel = document.getElementById('uploadsMemberFilter');
        if (!sel) return;
        const prev = sel.value; // remember current selection
        sel.innerHTML = '';
        const optAll = document.createElement('option'); optAll.value = 'all'; optAll.textContent = 'All'; sel.appendChild(optAll);
        const optNone = document.createElement('option'); optNone.value = ''; optNone.textContent = '(Unassigned)'; sel.appendChild(optNone);
        familyMembers.forEach(m => { const o = document.createElement('option'); o.value = m.id; o.textContent = m.name + (m.isPrimary ? ' â˜…' : ''); sel.appendChild(o); });
        sel.onchange = () => refreshUploadsSavedList();
        sel.value = prev || 'all'; // restore selection (default to All)
      }
      async function refreshUploadsSavedList() {
        const list = document.getElementById('uploadsSavedList');
        const msgEl = document.getElementById('uploadsAggMsg');
        list.innerHTML = '';
        try {
          const r = await apiFetch('/my/uploads');
          const items = await r.json().catch(()=>[]);
          if (!r.ok) throw new Error(items && items.error ? items.error : 'Failed to load saved uploads');
          if (!items.length) { msgEl.textContent = 'No saved uploads yet'; return; } else { msgEl.textContent = ''; }
          const filterVal = (document.getElementById('uploadsMemberFilter') && document.getElementById('uploadsMemberFilter').value) || 'all';
          items.forEach(it => {
            if (filterVal !== 'all') {
              if (filterVal === '' && it.memberId) return; // show unassigned only
              if (filterVal !== '' && it.memberId !== filterVal) return; // show matching member only
            }
            const row = document.createElement('div');
            row.style.display = 'flex'; row.style.alignItems = 'center'; row.style.justifyContent = 'space-between';
            row.style.border = '1px solid #e5e7eb'; row.style.borderRadius = '8px'; row.style.padding = '0.5em 0.7em';
            const left = document.createElement('div');
            left.style.display = 'flex'; left.style.alignItems = 'center'; left.style.gap = '0.6em';
            const cb = document.createElement('input'); cb.type = 'checkbox'; cb.value = it.id;
            cb.onchange = () => { if (cb.checked) selectedSavedIds.add(it.id); else selectedSavedIds.delete(it.id); };
            const meta = document.createElement('div');
            meta.innerHTML = `<div style=\"font-weight:700; color:#111827;\">${it.originalName || '(unnamed)'}<\/div>
                              <div style=\"font-size:12px; color:#6b7280;\">${new Date(it.createdAt).toLocaleString()}<\/div>
                              <div style=\"font-size:12px; color:#374151;\">Expense: ${Math.round((it.summary?.expense||0)*100)/100}, Income: ${Math.round((it.summary?.income||0)*100)/100}<\/div>`;
            left.appendChild(cb); left.appendChild(meta);
            const actions = document.createElement('div'); actions.style.display = 'flex'; actions.style.gap = '0.5em'; actions.style.alignItems='center';
            // Member assignment dropdown
            const sel = document.createElement('select');
            sel.style.padding = '0.35em 0.5em'; sel.style.border = '1px solid #cbd5e1'; sel.style.borderRadius = '8px'; sel.style.fontSize='12px';
            const optNone = document.createElement('option'); optNone.value=''; optNone.textContent='(Unassigned)'; sel.appendChild(optNone);
            familyMembers.forEach(m => { const o = document.createElement('option'); o.value = m.id; o.textContent = m.name + (m.isPrimary ? ' â˜…' : ''); sel.appendChild(o); });
            sel.value = it.memberId || '';
            sel.onchange = async () => {
              try {
                const body = sel.value ? { memberId: sel.value } : { memberId: null };
                const rr = await apiFetch('/my/uploads/' + it.id + '/member', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                const dd = await rr.json().catch(()=>({}));
                if (!rr.ok) throw new Error(dd && dd.error ? dd.error : 'Failed to set member');
              } catch (e) { alert(e.message); }
            };
            const loadBtn = document.createElement('button'); loadBtn.className='btn btn-primary btn-sm'; loadBtn.textContent='Load';
            loadBtn.onclick = async () => {
              try {
              await fetchMapping();
                const r = await apiFetch('/my/uploads/' + it.id);
                const d = await r.json().catch(()=>({}));
                if (!r.ok) throw new Error(d && d.error ? d.error : 'Failed to load report');
                chartData = d.report; window.chartData = d.report; currentType = null; currentParentCat = null; drillStack = [];
                await renderForMemberSelection(d.report);
                document.getElementById('uploadsModal').style.display = 'none';
              } catch (e) { alert(e.message); }
            };
            const reparseBtn = document.createElement('button'); reparseBtn.className='btn btn-neutral btn-sm'; reparseBtn.textContent='Reparse';
            reparseBtn.onclick = async () => {
              try {
                const rr = await apiFetch('/my/uploads/' + it.id + '/reparse', { method: 'PUT' });
                const dd = await rr.json().catch(()=>({}));
                if (!rr.ok) throw new Error(dd && dd.error ? dd.error : 'Failed to reparse');
                await refreshUploadsSavedList();
              } catch (e) { alert(e.message); }
            };
            const delBtn = document.createElement('button'); delBtn.className='btn btn-neutral btn-sm'; delBtn.textContent='Delete';
            delBtn.onclick = async () => {
              const ok = await showConfirm('Delete this saved upload?');
              if (!ok) return;
              try {
                const r = await apiFetch('/my/uploads/' + it.id, { method: 'DELETE' });
                const d = await r.json().catch(()=>({}));
                if (!r.ok) throw new Error(d && d.error ? d.error : 'Delete failed');
                await refreshUploadsSavedList();
              } catch (e) { alert(e.message); }
            };
            actions.appendChild(sel); actions.appendChild(loadBtn); actions.appendChild(reparseBtn); actions.appendChild(delBtn);
            row.appendChild(left); row.appendChild(actions);
            list.appendChild(row);
          });
        } catch (e) { msgEl.textContent = e.message; msgEl.style.color = '#ef4444'; }
      }
      // Expose open function
      window.openUploadsModal = async function() {
        if (!localStorage.getItem('token')) { openAuthModal('login'); return; }
        await populateUploadsMemberFilter();
        await refreshUploadsSavedList();
        modal.style.display = 'block';
      };
    }
    buildUploadsManagerModal();
    document.getElementById('manageUploadsBtn').onclick = () => window.openUploadsModal();
    document.getElementById('membersBtn').onclick = async () => { await loadFamily(); openMembersModal(); };
    // Auth modal logic
    let authMode = 'login'; // or 'register'
    function openAuthModal(mode='login') {
      authMode = mode;
      document.getElementById('authTitle').textContent = mode === 'login' ? 'Login' : 'Register';
      document.getElementById('authSubmitBtn').textContent = mode === 'login' ? 'Login' : 'Register';
      document.getElementById('authToggleBtn').textContent = mode === 'login' ? 'Switch to Register' : 'Switch to Login';
      document.getElementById('authName').style.display = mode === 'register' ? 'block' : 'none';
      document.getElementById('authMsg').textContent = '';
      document.getElementById('authEmail').value = '';
      document.getElementById('authPassword').value = '';
      document.getElementById('authName').value = '';
      document.getElementById('authModal').style.display = 'block';
    }
    function closeAuthModal() {
      document.getElementById('authModal').style.display = 'none';
    }
    document.getElementById('loginBtn').onclick = () => openAuthModal('login');
    document.getElementById('logoutBtn').onclick = () => { resetAppUI(); setToken(null); setUserEmail(null); localStorage.removeItem('userName'); document.getElementById('profileModal').style.display = 'none'; document.getElementById('authModal').style.display = 'none'; refreshAuthUI(); };
    document.getElementById('profileBtn').onclick = () => openProfileModal();
    document.getElementById('authCloseBtn').onclick = closeAuthModal;
    document.getElementById('authToggleBtn').onclick = () => openAuthModal(authMode === 'login' ? 'register' : 'login');
    document.getElementById('authSubmitBtn').onclick = async () => {
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPassword').value;
      const name = document.getElementById('authName').value.trim();
      const msg = document.getElementById('authMsg');
      msg.style.color = '#2563eb';
      msg.textContent = 'Working...';
      try {
        const res = await fetch(API_BASE + '/auth/' + (authMode === 'login' ? 'login' : 'register'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(authMode === 'login' ? { email, password } : { email, password, name })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error || 'Auth failed');
        setToken(data.token);
        setUserEmail(data.user && data.user.email);
        if (data.user && data.user.name) localStorage.setItem('userName', data.user.name);
        msg.style.color = '#16a34a';
        msg.textContent = 'Success';
        closeAuthModal();
        refreshAuthUI();
      } catch (e) {
        msg.style.color = '#ef4444';
        msg.textContent = e.message;
      }
    };
    // Initialize auth UI on load
    refreshAuthUI();
    // Auto-load aggregated saved expenses on landing when logged in
    (async function autoLoadAggregatedOnStartup(){
      try {
        if (localStorage.getItem('token')) {
          await loadFamily();
          await fetchMapping();
          const idsStr = getSelectedMemberIdsString();
          const r = await apiFetch(idsStr ? ('/my/expenses?memberIds=' + encodeURIComponent(idsStr)) : '/my/expenses');
          const d = await r.json().catch(()=>({}));
          if (r.ok) {
            chartData = d; window.chartData = d; currentType = null; currentParentCat = null; drillStack = [];
            (async ()=>{ await renderForMemberSelection(d); })();
            updateSelectedMembersLabel();
          }
        }
      } catch (e) {
        console.warn('Auto-load aggregated failed:', e);
      }
    })();
  </script>
  <!-- Profile Modal -->
  <div id="profileModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:100;">
    <div style="max-width:560px; width:92%; margin:6% auto; background:#fff; border-radius:12px; box-shadow:0 10px 40px #0003; overflow:hidden;">
      <div style="padding:0.9em 1.2em; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between;">
        <h3 style="margin:0; color:#2563eb;">Your Profile</h3>
        <button id="profileCloseBtn" class="btn btn-neutral btn-sm" title="Close">âœ•</button>
      </div>
      <!-- Tabs -->
      <div style="padding:0.6em 1.2em; border-bottom:1px solid #e5e7eb; display:flex; gap:0.6em;">
        <button id="tab-general" class="btn btn-neutral btn-sm" style="border-color:#2563eb; color:#2563eb;">General</button>
        <button id="tab-uploads" class="btn btn-neutral btn-sm">Saved Uploads</button>
        <button id="tab-family" class="btn btn-neutral btn-sm">Family</button>
      </div>
      <div style="padding:1.2em; display:flex; flex-direction:column; gap:1em;">
        <!-- General section: name + password -->
        <div id="profileGeneralSection">
          <div>
            <label style="display:block; font-weight:600; color:#374151; margin-bottom:0.3em;">Display Name</label>
            <input id="profileName" type="text" placeholder="Your name" style="width:100%; padding:0.6em; border:1px solid #cbd5e1; border-radius:8px;" />
            <div style="margin-top:0.6em; display:flex; gap:0.6em; align-items:center; justify-content:flex-start;">
              <button id="saveProfileBtn" class="btn btn-accent btn-sm">Save</button>
              <span id="profileMsg" style="font-weight:700; color:#2563eb;"></span>
            </div>
          </div>
          <hr style="border:none; border-top:1px solid #e5e7eb;" />
          <div>
            <label style="display:block; font-weight:700; color:#374151; margin-bottom:0.3em;">Change Password</label>
            <input id="currentPassword" type="password" placeholder="Current password" style="width:100%; padding:0.6em; border:1px solid #cbd5e1; border-radius:8px; margin-bottom:0.5em;" />
            <input id="newPassword" type="password" placeholder="New password (min 6)" style="width:100%; padding:0.6em; border:1px solid #cbd5e1; border-radius:8px; margin-bottom:0.5em;" />
            <input id="confirmNewPassword" type="password" placeholder="Confirm new password" style="width:100%; padding:0.6em; border:1px solid #cbd5e1; border-radius:8px; margin-bottom:0.5em;" />
            <div style="display:flex; gap:0.6em; align-items:center;">
              <button id="changePasswordBtn" class="btn btn-primary btn-sm">Change Password</button>
              <span id="passwordMsg" style="font-weight:700; color:#2563eb;"></span>
            </div>
          </div>
        </div>
        <!-- Uploads section -->
        <div id="profileUploadsSection" style="display:none;">
          <label style="display:block; font-weight:700; color:#374151; margin-bottom:0.3em;">Saved Uploads</label>
          <div style="display:flex; gap:0.6em; align-items:center; margin-bottom:0.5em;">
            <button id="loadAllSavedBtn" class="btn btn-primary btn-sm">Load aggregated saved expenses</button>
            <span id="savedMsg" style="font-weight:700; color:#2563eb;"></span>
          </div>
          <div style="display:flex; gap:0.6em; align-items:center; margin-bottom:0.5em; flex-wrap:wrap;">
            <button id="profileLoadSelectedBtn" class="btn btn-accent btn-sm">Load Selected</button>
            <button id="profileDeleteSelectedBtn" class="btn btn-neutral btn-sm">Delete Selected</button>
            <button id="profileSelectAllBtn" class="btn btn-neutral btn-sm">Select All</button>
            <button id="profileClearSelectionBtn" class="btn btn-neutral btn-sm">Clear Selection</button>
            <div style="display:flex; align-items:center; gap:0.4em;">
              <label for="profileMemberFilter" style="color:#374151; font-weight:600;">Filter by Member</label>
              <select id="profileMemberFilter" style="padding:0.35em 0.5em; border:1px solid #cbd5e1; border-radius:8px; font-size:12px;"></select>
            </div>
          </div>
          <div id="savedUploadsList" style="display:flex; flex-direction:column; gap:0.5em;"></div>
        </div>
        <!-- Family section -->
        <div id="profileFamilySection" style="display:none;">
          <label style="display:block; font-weight:700; color:#374151; margin-bottom:0.3em;">Family Members</label>
          <div id="familyMembersList" style="display:flex; flex-direction:column; gap:0.5em; margin-bottom:0.6em;"></div>
          <div style="display:flex; gap:0.6em; align-items:center; flex-wrap:wrap;">
            <input id="newFamilyMemberName" type="text" placeholder="Member name" style="flex:1; min-width:220px; padding:0.5em; border:1px solid #cbd5e1; border-radius:8px;" />
            <button id="addFamilyMemberBtn" class="btn btn-accent btn-sm">Add Member</button>
            <span id="familyMsg" style="font-weight:700; color:#2563eb;"></span>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    async function openProfileModal() {
      document.getElementById('profileMsg').textContent = '';
      document.getElementById('passwordMsg').textContent = '';
      const savedMsgEl = document.getElementById('savedMsg'); if (savedMsgEl) savedMsgEl.textContent = '';
      try {
        const res = await apiFetch('/me');
        const payload = await res.json().catch(()=>({}));
        if (!res.ok) {
          if (res.status === 401) { openAuthModal('login'); return; }
          const msg = payload && payload.error ? payload.error : 'Failed to load profile';
          throw new Error(msg);
        }
        const u = payload;
        document.getElementById('profileName').value = u.name || '';
        document.getElementById('profileModal').style.display = 'block';
        setProfileTab('general');
      } catch (e) {
        alert(e.message || 'Failed to load profile');
      }
    }
    function closeProfileModal() { document.getElementById('profileModal').style.display = 'none'; }
    document.getElementById('profileCloseBtn').onclick = closeProfileModal;
    document.getElementById('saveProfileBtn').onclick = async () => {
      const name = document.getElementById('profileName').value.trim();
      const msg = document.getElementById('profileMsg');
      msg.style.color = '#2563eb'; msg.textContent = 'Saving...';
      try {
        const res = await apiFetch('/me', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name }) });
        const data = await res.json().catch(()=>({}));
        if (!res.ok) throw new Error(data.error || 'Failed to save profile');
        localStorage.setItem('userName', data.name || '');
        msg.style.color = '#16a34a'; msg.textContent = 'Saved';
        refreshAuthUI();
      } catch (e) {
        msg.style.color = '#ef4444'; msg.textContent = e.message;
      }
    };
    document.getElementById('changePasswordBtn').onclick = async () => {
      const cur = document.getElementById('currentPassword').value;
      const np = document.getElementById('newPassword').value;
      const cp = document.getElementById('confirmNewPassword').value;
      const msg = document.getElementById('passwordMsg');
      if (np !== cp) { msg.style.color = '#ef4444'; msg.textContent = 'Passwords do not match'; return; }
      msg.style.color = '#2563eb'; msg.textContent = 'Updating...';
      try {
        const res = await apiFetch('/auth/change-password', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ currentPassword: cur, newPassword: np }) });
        const data = await res.json().catch(()=>({}));
        if (!res.ok) throw new Error(data.error || 'Failed to change password');
        msg.style.color = '#16a34a'; msg.textContent = 'Password updated';
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmNewPassword').value = '';
      } catch (e) {
        msg.style.color = '#ef4444'; msg.textContent = e.message;
      }
    };

    // Tabs control
    function setProfileTab(tab) {
      const general = document.getElementById('profileGeneralSection');
      const uploads = document.getElementById('profileUploadsSection');
      const family = document.getElementById('profileFamilySection');
      const tabGen = document.getElementById('tab-general');
      const tabUp = document.getElementById('tab-uploads');
      const tabFam = document.getElementById('tab-family');
      if (!general || !uploads || !tabGen || !tabUp) return;
      general.style.display = (tab === 'general') ? 'block' : 'none';
      uploads.style.display = (tab === 'uploads') ? 'block' : 'none';
      if (family) family.style.display = (tab === 'family') ? 'block' : 'none';
      // simple active styling
      if (tabGen) { if (tab === 'general') { tabGen.style.borderColor = '#2563eb'; tabGen.style.color = '#2563eb'; } else { tabGen.style.borderColor = ''; tabGen.style.color = ''; } }
      if (tabUp) { if (tab === 'uploads') { tabUp.style.borderColor = '#2563eb'; tabUp.style.color = '#2563eb'; } else { tabUp.style.borderColor = ''; tabUp.style.color = ''; } }
      if (tabFam) { if (tab === 'family') { tabFam.style.borderColor = '#2563eb'; tabFam.style.color = '#2563eb'; } else { tabFam.style.borderColor = ''; tabFam.style.color = ''; } }
      // Refresh lists when switching
      if (tab === 'uploads') {
        loadSavedUploadsIntoProfile();
      } else if (tab === 'family') {
        renderFamilySection();
      }
    }
    document.getElementById('tab-general').onclick = () => setProfileTab('general');
    document.getElementById('tab-uploads').onclick = () => setProfileTab('uploads');
    document.getElementById('tab-family').onclick = () => setProfileTab('family');

    // Saved uploads management
    const profileSelectedIds = new Set();
    async function loadSavedUploadsIntoProfile() {
      const listEl = document.getElementById('savedUploadsList');
      const msgEl = document.getElementById('savedMsg');
      if (!listEl || !msgEl) return;
      listEl.innerHTML = '';
      msgEl.style.color = '#2563eb'; msgEl.textContent = 'Loading...';
      try {
        await loadFamily();
        // Populate filter
        const sel = document.getElementById('profileMemberFilter');
        if (sel) {
          const prev = sel.value;
          sel.innerHTML = '';
          const optAll = document.createElement('option'); optAll.value = 'all'; optAll.textContent = 'All'; sel.appendChild(optAll);
          const optNone = document.createElement('option'); optNone.value = ''; optNone.textContent = '(Unassigned)'; sel.appendChild(optNone);
          familyMembers.forEach(m => { const o = document.createElement('option'); o.value = m.id; o.textContent = m.name + (m.isPrimary ? ' â˜…' : ''); sel.appendChild(o); });
          sel.onchange = () => loadSavedUploadsIntoProfile();
          sel.value = prev || 'all';
        }
        const res = await apiFetch('/my/uploads');
        const items = await res.json().catch(()=>[]);
        if (!res.ok) throw new Error(items && items.error ? items.error : 'Failed to load saved uploads');
        msgEl.textContent = items.length ? '' : 'No saved uploads yet';
        const filterVal = (document.getElementById('profileMemberFilter') && document.getElementById('profileMemberFilter').value) || 'all';
        items.forEach(it => {
          if (filterVal !== 'all') {
            if (filterVal === '' && it.memberId) return; // show unassigned only
            if (filterVal !== '' && it.memberId !== filterVal) return; // show matching member only
          }
          const row = document.createElement('div');
          row.style.display = 'flex';
          row.style.alignItems = 'center';
          row.style.justifyContent = 'space-between';
          row.style.border = '1px solid #e5e7eb';
          row.style.borderRadius = '8px';
          row.style.padding = '0.5em 0.7em';
          const left = document.createElement('div');
          left.style.display = 'flex'; left.style.alignItems = 'center'; left.style.gap = '0.6em';
          const cb = document.createElement('input'); cb.type = 'checkbox'; cb.value = it.id;
          cb.onchange = () => { if (cb.checked) profileSelectedIds.add(it.id); else profileSelectedIds.delete(it.id); };
          const meta = document.createElement('div');
          meta.innerHTML = `<div style=\"font-weight:700; color:#111827;\">${it.originalName || '(unnamed)'}<\/div>
                            <div style=\"font-size:12px; color:#6b7280;\">${new Date(it.createdAt).toLocaleString()}<\/div>
                            <div style=\"font-size:12px; color:#374151;\">Expense: ${Math.round((it.summary?.expense||0)*100)/100}, Income: ${Math.round((it.summary?.income||0)*100)/100}<\/div>`;
          left.appendChild(cb); left.appendChild(meta);
          const actions = document.createElement('div');
          actions.style.display = 'flex'; actions.style.gap = '0.5em'; actions.style.alignItems='center';
          // Member assignment dropdown
          const sel = document.createElement('select');
          sel.style.padding = '0.35em 0.5em'; sel.style.border = '1px solid #cbd5e1'; sel.style.borderRadius = '8px'; sel.style.fontSize='12px';
          const optNone = document.createElement('option'); optNone.value=''; optNone.textContent='(Unassigned)'; sel.appendChild(optNone);
          familyMembers.forEach(m => { const o = document.createElement('option'); o.value = m.id; o.textContent = m.name + (m.isPrimary ? ' â˜…' : ''); sel.appendChild(o); });
          sel.value = it.memberId || '';
          sel.onchange = async () => {
            try {
              const body = sel.value ? { memberId: sel.value } : { memberId: null };
              const rr = await apiFetch('/my/uploads/' + it.id + '/member', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
              const dd = await rr.json().catch(()=>({}));
              if (!rr.ok) throw new Error(dd && dd.error ? dd.error : 'Failed to set member');
            } catch (e) { alert(e.message); }
          };
          const loadBtn = document.createElement('button');
          loadBtn.className = 'btn btn-primary btn-sm';
          loadBtn.textContent = 'Load';
          loadBtn.onclick = async () => {
            try {
              await fetchMapping();
              const r = await apiFetch('/my/uploads/' + it.id);
              const d = await r.json().catch(()=>({}));
              if (!r.ok) throw new Error(d && d.error ? d.error : 'Failed to load report');
              chartData = d.report;
              window.chartData = d.report;
              currentType = null; currentParentCat = null; drillStack = [];
              (async ()=>{ await renderForMemberSelection(d.report); })();
              document.getElementById('profileModal').style.display = 'none';
            } catch (e) { alert(e.message); }
          };
          const delBtn = document.createElement('button');
          delBtn.className = 'btn btn-neutral btn-sm';
          delBtn.textContent = 'Delete';
          delBtn.onclick = async () => {
            const ok = await showConfirm('Delete this saved upload?');
            if (!ok) return;
            try {
              const r = await apiFetch('/my/uploads/' + it.id, { method: 'DELETE' });
              const d = await r.json().catch(()=>({}));
              if (!r.ok) throw new Error(d && d.error ? d.error : 'Delete failed');
              await loadSavedUploadsIntoProfile();
            } catch (e) { alert(e.message); }
          };
          actions.appendChild(sel); actions.appendChild(loadBtn); actions.appendChild(delBtn);
          row.appendChild(left); row.appendChild(actions);
          listEl.appendChild(row);
        });
      } catch (e) {
        msgEl.style.color = '#ef4444'; msgEl.textContent = e.message;
      }
    }
    document.getElementById('profileLoadSelectedBtn').onclick = async () => {
      const ids = Array.from(profileSelectedIds);
      const msgEl = document.getElementById('savedMsg');
      if (!ids.length) { msgEl.style.color = '#ef4444'; msgEl.textContent = 'No items selected'; return; }
      msgEl.style.color = '#2563eb'; msgEl.textContent = 'Loading selected...';
      try {
        await fetchMapping();
        const r = await apiFetch('/my/uploads/aggregate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ids }) });
        const d = await r.json().catch(()=>({}));
        if (!r.ok) throw new Error(d && d.error ? d.error : 'Failed to load selected');
        chartData = d; window.chartData = d; currentType = null; currentParentCat = null; drillStack = [];
        (async ()=>{ await renderForMemberSelection(d); })();
        document.getElementById('profileModal').style.display = 'none';
        msgEl.textContent = '';
      } catch (e) { msgEl.style.color = '#ef4444'; msgEl.textContent = e.message; }
    };
    document.getElementById('profileDeleteSelectedBtn').onclick = async () => {
      const ids = Array.from(profileSelectedIds);
      const msgEl = document.getElementById('savedMsg');
      if (!ids.length) { msgEl.style.color = '#ef4444'; msgEl.textContent = 'No items selected'; return; }
      const ok = await window.showConfirm('Delete selected uploads?');
      if (!ok) return;
      msgEl.style.color = '#2563eb'; msgEl.textContent = 'Deleting...';
      try {
        const r = await apiFetch('/my/uploads', { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ids }) });
        const d = await r.json().catch(()=>({}));
        if (!r.ok) throw new Error(d && d.error ? d.error : 'Failed to delete');
        profileSelectedIds.clear();
        await loadSavedUploadsIntoProfile();
        msgEl.textContent = '';
      } catch (e) { msgEl.style.color = '#ef4444'; msgEl.textContent = e.message; }
    };
    document.getElementById('profileSelectAllBtn').onclick = () => {
      document.querySelectorAll('#savedUploadsList input[type="checkbox"]').forEach(cb => { cb.checked = true; profileSelectedIds.add(cb.value); });
    };
    document.getElementById('profileClearSelectionBtn').onclick = () => {
      profileSelectedIds.clear();
      document.querySelectorAll('#savedUploadsList input[type="checkbox"]').forEach(cb => { cb.checked = false; });
    };
    document.getElementById('loadAllSavedBtn').onclick = async () => {
      const msgEl = document.getElementById('savedMsg');
      if (!msgEl) return;
      msgEl.style.color = '#2563eb'; msgEl.textContent = 'Loading...';
      try {
        await fetchMapping();
        const idsStr = getSelectedMemberIdsString();
        const r = await apiFetch(idsStr ? ('/my/expenses?memberIds=' + encodeURIComponent(idsStr)) : '/my/expenses');
        const d = await r.json().catch(()=>({}));
        if (!r.ok) throw new Error(d && d.error ? d.error : 'Failed to load aggregated');
        chartData = d; window.chartData = d; currentType = null; currentParentCat = null; drillStack = [];
        (async ()=>{ await renderForMemberSelection(d); })();
        document.getElementById('profileModal').style.display = 'none';
        msgEl.textContent = '';
      } catch (e) {
        msgEl.style.color = '#ef4444'; msgEl.textContent = e.message;
      }
    };
    // Family section logic
    async function renderFamilySection() {
      const list = document.getElementById('familyMembersList');
      const msg = document.getElementById('familyMsg');
      if (!list) return;
      list.innerHTML = '';
      msg && (msg.textContent = 'Loading...');
      try {
        await loadFamily();
        msg && (msg.textContent = '');
        familyMembers.forEach(m => {
          const row = document.createElement('div');
          row.style.display = 'flex'; row.style.alignItems = 'center'; row.style.justifyContent = 'space-between';
          row.style.border = '1px solid #e5e7eb'; row.style.borderRadius = '8px'; row.style.padding = '0.5em 0.7em';
          const left = document.createElement('div'); left.style.display='flex'; left.style.alignItems='center'; left.style.gap='0.6em';
          const name = document.createElement('div'); name.style.fontWeight='700'; name.style.color='#111827'; name.textContent = m.name + (m.isPrimary ? ' (Primary)' : '');
          left.appendChild(name);
          const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='0.5em';
          const setPrimaryBtn = document.createElement('button'); setPrimaryBtn.className='btn btn-primary btn-sm'; setPrimaryBtn.textContent='Set Primary';
          setPrimaryBtn.onclick = async () => {
            try {
              const r = await apiFetch('/my/family/members/' + m.id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ isPrimary: true }) });
              const d = await r.json().catch(()=>({}));
              if (!r.ok) throw new Error(d && d.error ? d.error : 'Failed to set primary');
              selectedMemberIds = new Set([m.id]);
              await renderFamilySection();
            } catch (e) { alert(e.message); }
          };
          const deleteBtn = document.createElement('button'); deleteBtn.className='btn btn-neutral btn-sm'; deleteBtn.textContent='Delete';
          deleteBtn.onclick = async () => {
            const ok = await showConfirm('Delete this member?');
            if (!ok) return;
            try {
              const r = await apiFetch('/my/family/members/' + m.id, { method: 'DELETE' });
              const d = await r.json().catch(()=>({}));
              if (!r.ok) throw new Error(d && d.error ? d.error : 'Failed to delete member');
              if (selectedMemberIds.has(m.id)) selectedMemberIds.delete(m.id);
              await renderFamilySection();
            } catch (e) { alert(e.message); }
          };
          actions.appendChild(setPrimaryBtn); actions.appendChild(deleteBtn);
          row.appendChild(left); row.appendChild(actions);
          list.appendChild(row);
        });
        document.getElementById('addFamilyMemberBtn').onclick = async () => {
          const inp = document.getElementById('newFamilyMemberName');
          const nm = (inp && inp.value || '').trim();
          if (!nm) { msg && (msg.style.color='#ef4444', msg.textContent='Please enter a name'); return; }
          msg && (msg.style.color='#2563eb', msg.textContent='Adding...');
          try {
            const r = await apiFetch('/my/family/members', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: nm }) });
            const d = await r.json().catch(()=>({}));
            if (!r.ok) throw new Error(d && d.error ? d.error : 'Failed to add member');
            inp.value=''; msg && (msg.style.color='#16a34a', msg.textContent='Added');
            await renderFamilySection();
          } catch (e) { msg && (msg.style.color='#ef4444', msg.textContent=e.message); }
        };
      } catch (e) {
        msg && (msg.style.color='#ef4444', msg.textContent = e.message);
      }
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</body>
</html>              